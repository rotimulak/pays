# E8.4 ‚Äî Bot Integration

## –û–ø–∏—Å–∞–Ω–∏–µ

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è TokenService —Å –±–æ—Ç–æ–º: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–∏–∑–∫–æ–º –±–∞–ª–∞–Ω—Å–µ, —É–ª—É—á—à–µ–Ω–Ω—ã–π /balance.

---

## Tasks

### T8.4.1 ‚Äî Enhanced balance handler

**–û–ø–∏—Å–∞–Ω–∏–µ:** –£–ª—É—á—à–∏—Ç—å handler /balance —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.

**–§–∞–π–ª:** `backend/src/bot/handlers/balance.py` (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
from aiogram import Router, F
from aiogram.filters import Command
from aiogram.types import Message

from sqlalchemy.ext.asyncio import AsyncSession

from db.models.user import User
from services.token_service import TokenService
from services.transaction_service import TransactionService
from bot.keyboards.balance import get_balance_keyboard

router = Router()

@router.message(Command("balance"))
@router.message(F.text == "üí∞ –ë–∞–ª–∞–Ω—Å")
async def cmd_balance(
    message: Message,
    user: User,
    session: AsyncSession,
) -> None:
    """Show detailed balance information"""
    token_service = TokenService(session)
    transaction_service = TransactionService(session)

    # Get balance info
    balance = await token_service.check_balance(user.id)

    # Get recent spending stats
    stats = await transaction_service.get_user_stats(user.id)
    recent_spend = await transaction_service.get_recent_spending(
        user.id, days=7
    )

    text = format_detailed_balance(balance, stats, recent_spend)
    keyboard = get_balance_keyboard(balance.can_spend)

    await message.answer(text, reply_markup=keyboard)

def format_detailed_balance(balance, stats, recent_spend) -> str:
    """Format detailed balance message"""
    lines = ["üí∞ <b>–í–∞—à –±–∞–ª–∞–Ω—Å</b>\n"]

    # Current balance with status indicator
    if balance.token_balance > 50:
        balance_icon = "üü¢"
    elif balance.token_balance > 10:
        balance_icon = "üü°"
    else:
        balance_icon = "üî¥"

    lines.append(f"{balance_icon} –¢–æ–∫–µ–Ω—ã: <b>{balance.token_balance}</b>")

    # Subscription status
    if balance.subscription_active:
        days_left = (balance.subscription_end - datetime.utcnow()).days
        if days_left <= 3:
            sub_icon = "‚ö†Ô∏è"
        else:
            sub_icon = "‚úÖ"
        lines.append(
            f"{sub_icon} –ü–æ–¥–ø–∏—Å–∫–∞: –¥–æ {balance.subscription_end.strftime('%d.%m.%Y')}"
        )
        if days_left <= 3:
            lines.append(f"   <i>–û—Å—Ç–∞–ª–æ—Å—å {days_left} –¥–Ω–µ–π</i>")
    else:
        lines.append("‚ùå –ü–æ–¥–ø–∏—Å–∫–∞: <b>–Ω–µ –∞–∫—Ç–∏–≤–Ω–∞</b>")

    # Spending status
    lines.append("")
    if balance.can_spend:
        lines.append("‚úÖ –°–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤: <b>–¥–æ—Å—Ç—É–ø–Ω–æ</b>")
    else:
        lines.append(f"‚ùå –°–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤: {balance.reason}")

    # Stats
    if stats:
        lines.append("\nüìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b>")
        lines.append(f"   –í—Å–µ–≥–æ –ø–æ–ª—É—á–µ–Ω–æ: {stats.get('total_topup', 0)} —Ç–æ–∫–µ–Ω–æ–≤")
        lines.append(f"   –í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ: {stats.get('total_spent', 0)} —Ç–æ–∫–µ–Ω–æ–≤")

    # Recent spending
    if recent_spend:
        lines.append(f"\nüìÖ –ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π:")
        lines.append(f"   –ü–æ—Ç—Ä–∞—á–µ–Ω–æ: {recent_spend} —Ç–æ–∫–µ–Ω–æ–≤")
        avg_daily = recent_spend / 7
        lines.append(f"   –í —Å—Ä–µ–¥–Ω–µ–º: {avg_daily:.1f} —Ç–æ–∫–µ–Ω–æ–≤/–¥–µ–Ω—å")

    # Actions
    lines.append("\n")
    if not balance.can_spend:
        lines.append("üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å: /tariffs")
    lines.append("üìú –ò—Å—Ç–æ—Ä–∏—è: /history")

    return "\n".join(lines)
```

**Keyboards:**
```python
# bot/keyboards/balance.py
from aiogram.types import InlineKeyboardMarkup
from aiogram.utils.keyboard import InlineKeyboardBuilder

def get_balance_keyboard(can_spend: bool) -> InlineKeyboardMarkup:
    """Keyboard for balance view"""
    builder = InlineKeyboardBuilder()

    if not can_spend:
        builder.button(text="üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å", callback_data="show_tariffs")

    builder.button(text="üìú –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π", callback_data="show_history")
    builder.button(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="refresh_balance")

    builder.adjust(1)
    return builder.as_markup()
```

**DoD:**
- [ ] –î–µ—Ç–∞–ª—å–Ω—ã–π /balance —Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
- [ ] –¶–≤–µ—Ç–æ–≤—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è
- [ ] –°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ –∑–∞ –Ω–µ–¥–µ–ª—é
- [ ] Keyboard —Å –¥–µ–π—Å—Ç–≤–∏—è–º–∏

---

### T8.4.2 ‚Äî Low balance notifications

**–û–ø–∏—Å–∞–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–∏–∑–∫–æ–º –±–∞–ª–∞–Ω—Å–µ.

**–§–∞–π–ª:** `backend/src/services/notification_service.py` (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)

**–î–æ–±–∞–≤–ª–µ–Ω–∏—è:**
```python
class NotificationService:
    # ... existing methods ...

    async def notify_low_balance(
        self,
        user_id: int,
        current_balance: int,
        threshold: int = 10,
    ) -> bool:
        """
        Send low balance warning.

        Args:
            user_id: Telegram user ID
            current_balance: Current token balance
            threshold: Warning threshold

        Returns:
            True if sent successfully
        """
        message = (
            f"‚ö†Ô∏è <b>–ù–∏–∑–∫–∏–π –±–∞–ª–∞–Ω—Å —Ç–æ–∫–µ–Ω–æ–≤</b>\n\n"
            f"–ù–∞ –≤–∞—à–µ–º –±–∞–ª–∞–Ω—Å–µ –æ—Å—Ç–∞–ª–æ—Å—å: <b>{current_balance}</b> —Ç–æ–∫–µ–Ω–æ–≤\n\n"
            f"–ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Å–µ—Ä–≤–∏—Å–æ–º.\n\n"
            f"üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å: /tariffs"
        )

        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å", callback_data="show_tariffs")],
        ])

        return await self._send_message(user_id, message, keyboard)

    async def check_and_notify_low_balance(
        self,
        user_id: int,
        balance_after: int,
        thresholds: list[int] = [50, 20, 10, 5],
    ) -> None:
        """
        Check if balance crossed threshold and send notification.

        Called after spending tokens.
        Only notifies once per threshold.
        """
        # Get user's last notification threshold
        user = await self.user_repo.get_by_id(user_id)
        last_notified = user.last_balance_notification or 0

        for threshold in sorted(thresholds, reverse=True):
            if balance_after <= threshold and last_notified > threshold:
                await self.notify_low_balance(user_id, balance_after, threshold)

                # Update last notification level
                await self.user_repo.update_last_balance_notification(
                    user_id, threshold
                )
                break
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å TokenService:**
```python
# services/token_service.py

class TokenService:
    def __init__(self, session: AsyncSession):
        # ...
        self.notification_service: NotificationService | None = None

    def set_notification_service(self, service: NotificationService) -> None:
        self.notification_service = service

    async def spend_tokens(self, ...):
        # ... existing spending logic ...

        # Check for low balance notification
        if self.notification_service:
            await self.notification_service.check_and_notify_low_balance(
                user_id=user_id,
                balance_after=new_balance,
            )

        return result
```

**–ú–æ–¥–µ–ª—å User –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:**
```python
# db/models/user.py
class User(Base):
    # ... existing fields ...

    last_balance_notification: Mapped[int | None] = mapped_column(
        Integer,
        nullable=True,
        default=None,
        comment="Last balance threshold notification was sent for",
    )
```

**DoD:**
- [ ] notify_low_balance –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- [ ] check_and_notify_low_balance –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ—Ä–æ–≥–∏
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –ø–æ—Ä–æ–≥
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å spend_tokens
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è
