# E3.4 ‚Äî Keyboards & Callbacks

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω–∏–µ inline keyboards –∏ callback data –¥–ª—è —Ç–∞—Ä–∏—Ñ–æ–≤ –∏ –ø–ª–∞—Ç–µ–∂–µ–π.

---

## Tasks

### T3.4.1 ‚Äî Tariff callback data

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å callback data –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞.

**–§–∞–π–ª:** `backend/src/bot/callbacks/tariff.py`

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
```python
from aiogram.filters.callback_data import CallbackData
from uuid import UUID

class TariffCallback(CallbackData, prefix="tariff"):
    """Callback data for tariff selection"""
    action: str  # "select", "info"
    tariff_id: UUID

# Usage in handlers:
# callback_data=TariffCallback(action="select", tariff_id=tariff.id)
# Serializes to: "tariff:select:550e8400-e29b-41d4-a716-446655440000"
```

**DoD:**
- [ ] TariffCallback —Å–æ–∑–¥–∞–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º prefix
- [ ] –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è UUID —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –§–∏–ª—å—Ç—Ä `TariffCallback.filter()` —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ handlers

---

### T3.4.2 ‚Äî Tariffs keyboard

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å inline keyboard –¥–ª—è —Å–ø–∏—Å–∫–∞ —Ç–∞—Ä–∏—Ñ–æ–≤.

**–§–∞–π–ª:** `backend/src/bot/keyboards/tariffs.py`

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
```python
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder

from bot.callbacks.tariff import TariffCallback
from services.dto.tariff import TariffDTO

def get_tariffs_keyboard(tariffs: list[TariffDTO]) -> InlineKeyboardMarkup:
    """
    Create inline keyboard with tariff buttons.

    Each button:
    - Text: "–í—ã–±—Ä–∞—Ç—å {name} {emoji}"
    - Callback: TariffCallback(action="select", tariff_id=id)
    """
    builder = InlineKeyboardBuilder()

    for tariff in tariffs:
        builder.button(
            text=f"–í—ã–±—Ä–∞—Ç—å {tariff.name}",
            callback_data=TariffCallback(
                action="select",
                tariff_id=tariff.id
            )
        )

    builder.adjust(1)  # One button per row
    return builder.as_markup()
```

**DoD:**
- [ ] Keyboard –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∏–∑ —Å–ø–∏—Å–∫–∞ —Ç–∞—Ä–∏—Ñ–æ–≤
- [ ] –ö–∞–∂–¥–∞—è –∫–Ω–æ–ø–∫–∞ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π callback_data
- [ ] –ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è (–ø—É—Å—Ç–∞—è keyboard –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ)

---

### T3.4.3 ‚Äî Payment keyboard

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å inline keyboard –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ–ø–ª–∞—Ç—ã.

**–§–∞–π–ª:** `backend/src/bot/keyboards/payment.py`

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
```python
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from uuid import UUID

class InvoiceCallback(CallbackData, prefix="invoice"):
    """Callback data for invoice actions"""
    action: str  # "cancel", "check_status"
    invoice_id: UUID

def get_payment_keyboard(
    payment_url: str,
    amount: str,
    invoice_id: UUID
) -> InlineKeyboardMarkup:
    """
    Create payment keyboard with URL button and cancel option.

    Buttons:
    - [üí≥ –û–ø–ª–∞—Ç–∏—Ç—å {amount}] - URL button
    - [‚ùå –û—Ç–º–µ–Ω–∏—Ç—å] - Callback button
    """
    builder = InlineKeyboardBuilder()

    # URL button (opens payment page)
    builder.button(
        text=f"üí≥ –û–ø–ª–∞—Ç–∏—Ç—å {amount}",
        url=payment_url
    )

    # Cancel button
    builder.button(
        text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å",
        callback_data=InvoiceCallback(
            action="cancel",
            invoice_id=invoice_id
        )
    )

    builder.adjust(1)
    return builder.as_markup()

def get_payment_success_keyboard() -> InlineKeyboardMarkup:
    """Keyboard shown after successful payment"""
    builder = InlineKeyboardBuilder()
    builder.button(text="üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å", callback_data="show_profile")
    builder.button(text="üí∞ –ï—â—ë —Ç–∞—Ä–∏—Ñ—ã", callback_data="show_tariffs")
    builder.adjust(2)
    return builder.as_markup()
```

**DoD:**
- [ ] Payment keyboard —Å URL –∫–Ω–æ–ø–∫–æ–π
- [ ] Cancel callback —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Success keyboard –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ–ø–ª–∞—Ç–µ
- [ ] InvoiceCallback —Å–æ–∑–¥–∞–Ω
