# E3.3 ‚Äî Bot Handlers

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω–∏–µ handlers –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–∞—Ä–∏—Ñ–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á–µ—Ç–æ–≤.

---

## Tasks

### T3.3.1 ‚Äî Tariffs handler

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å handler –¥–ª—è –∫–æ–º–∞–Ω–¥—ã `/tariffs`.

**–§–∞–π–ª:** `backend/src/bot/handlers/tariffs.py`

**–õ–æ–≥–∏–∫–∞:**
```python
from aiogram import Router, F
from aiogram.filters import Command
from aiogram.types import Message

router = Router()

@router.message(Command("tariffs"))
@router.message(F.text == "üí∞ –¢–∞—Ä–∏—Ñ—ã")
async def cmd_tariffs(
    message: Message,
    user: User,
    session: AsyncSession
) -> None:
    """
    Show available tariffs with inline buttons.

    1. Get active tariffs from TariffService
    2. Format each tariff for display
    3. Create inline keyboard with tariff buttons
    4. Send message with keyboard
    """
```

**–°–æ–æ–±—â–µ–Ω–∏–µ:**
```
üí∞ –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã

–í—ã–±–µ—Ä–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–∞—Ä–∏—Ñ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:

üíé Premium
100 —Ç–æ–∫–µ–Ω–æ–≤ + 30 –¥–Ω–µ–π –ø–æ–¥–ø–∏—Å–∫–∏
499 ‚ÇΩ

ü•à Standard
50 —Ç–æ–∫–µ–Ω–æ–≤
249 ‚ÇΩ

ü•â Basic
20 —Ç–æ–∫–µ–Ω–æ–≤
99 ‚ÇΩ
```

**Inline keyboard:**
```
[–í—ã–±—Ä–∞—Ç—å Premium üíé]
[–í—ã–±—Ä–∞—Ç—å Standard ü•à]
[–í—ã–±—Ä–∞—Ç—å Basic ü•â]
```

**DoD:**
- [ ] Handler –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ `/tariffs` –∏ –∫–Ω–æ–ø–∫—É –º–µ–Ω—é
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã
- [ ] Inline keyboard —Å callback_data –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞
- [ ] –ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —Ç–∞—Ä–∏—Ñ–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è

---

### T3.3.2 ‚Äî Buy handler

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å handler –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á—ë—Ç–∞.

**–§–∞–π–ª:** `backend/src/bot/handlers/buy.py`

**–õ–æ–≥–∏–∫–∞:**
```python
from aiogram import Router
from aiogram.types import CallbackQuery

from bot.callbacks.tariff import TariffCallback

router = Router()

@router.callback_query(TariffCallback.filter())
async def process_tariff_selection(
    callback: CallbackQuery,
    callback_data: TariffCallback,
    user: User,
    session: AsyncSession
) -> None:
    """
    Process tariff selection.

    1. Get tariff by ID from callback_data
    2. Create or get existing pending invoice
    3. Generate payment URL (mock for now)
    4. Show invoice details with "Pay" button
    5. Answer callback to remove loading
    """
```

**–°–æ–æ–±—â–µ–Ω–∏–µ:**
```
üìã –°—á—ë—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É

–¢–∞—Ä–∏—Ñ: Premium üíé
–°—É–º–º–∞: 499 ‚ÇΩ

–í—ã –ø–æ–ª—É—á–∏—Ç–µ:
‚Ä¢ 100 —Ç–æ–∫–µ–Ω–æ–≤
‚Ä¢ 30 –¥–Ω–µ–π –ø–æ–¥–ø–∏—Å–∫–∏

–°—á—ë—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ: 01.02.2024 15:30

–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã:
```

**Inline keyboard:**
```
[üí≥ –û–ø–ª–∞—Ç–∏—Ç—å 499 ‚ÇΩ] (URL button)
[‚ùå –û—Ç–º–µ–Ω–∏—Ç—å]
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã:**
```python
@router.callback_query(F.data == "cancel_invoice")
async def cancel_invoice_handler(
    callback: CallbackQuery,
    user: User,
    session: AsyncSession
) -> None:
    """Cancel pending invoice and show tariffs again"""
```

**DoD:**
- [ ] Callback handler –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞
- [ ] Invoice —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- [ ] Idempotency: –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–±–æ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ—Ç –∂–µ invoice
- [ ] –ö–Ω–æ–ø–∫–∞ –æ–ø–ª–∞—Ç—ã –≤–µ–¥—ë—Ç –Ω–∞ payment URL
- [ ] –û—Ç–º–µ–Ω–∞ —Å—á—ë—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] callback.answer() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
