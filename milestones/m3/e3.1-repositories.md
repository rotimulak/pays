# E3.1 — Repositories

## Описание

Создание репозиториев для работы с Invoice и Transaction.

---

## Tasks

### T3.1.1 — Invoice repository

**Описание:** Создать репозиторий для работы со счетами.

**Файл:** `backend/src/db/repositories/invoice_repository.py`

**Методы:**
```python
class InvoiceRepository:
    async def create(self, invoice: Invoice) -> Invoice:
        """Create new invoice"""

    async def get_by_id(self, invoice_id: UUID) -> Invoice | None:
        """Get invoice by UUID"""

    async def get_by_inv_id(self, inv_id: int) -> Invoice | None:
        """Get invoice by Robokassa InvId"""

    async def get_by_idempotency_key(self, key: str) -> Invoice | None:
        """Get invoice by idempotency key"""

    async def get_pending_by_user(
        self,
        user_id: int,
        tariff_id: UUID
    ) -> Invoice | None:
        """Get pending invoice for user and tariff"""

    async def get_user_invoices(
        self,
        user_id: int,
        limit: int = 20,
        offset: int = 0
    ) -> list[Invoice]:
        """Get user's invoices ordered by created_at desc"""

    async def update_status(
        self,
        invoice_id: UUID,
        status: InvoiceStatus,
        paid_at: datetime | None = None
    ) -> Invoice:
        """Update invoice status"""

    async def get_for_update(self, invoice_id: UUID) -> Invoice | None:
        """Get invoice with FOR UPDATE lock"""

    async def get_next_inv_id(self) -> int:
        """Generate next sequential InvId for Robokassa"""

    async def expire_old_pending(self, before: datetime) -> int:
        """Set expired status for old pending invoices. Returns count."""
```

**DoD:**
- [ ] Все методы реализованы
- [ ] `get_for_update` использует SELECT FOR UPDATE
- [ ] `get_next_inv_id` thread-safe (sequence или atomic counter)
- [ ] Unit-тесты для всех методов

---

### T3.1.2 — Transaction repository

**Описание:** Создать репозиторий для работы с транзакциями.

**Файл:** `backend/src/db/repositories/transaction_repository.py`

**Методы:**
```python
class TransactionRepository:
    async def create(self, transaction: Transaction) -> Transaction:
        """Create new transaction"""

    async def get_by_id(self, transaction_id: UUID) -> Transaction | None:
        """Get transaction by ID"""

    async def get_by_user(
        self,
        user_id: int,
        limit: int = 20,
        offset: int = 0,
        type: TransactionType | None = None
    ) -> list[Transaction]:
        """Get user's transactions with optional type filter"""

    async def get_by_invoice(self, invoice_id: UUID) -> list[Transaction]:
        """Get transactions for specific invoice"""

    async def get_user_stats(self, user_id: int) -> TransactionStats:
        """Get aggregated stats: total_topup, total_spent, etc."""
```

**DTO:**
```python
class TransactionStats(BaseModel):
    total_topup: int
    total_spent: int
    total_refund: int
    transaction_count: int
```

**DoD:**
- [ ] Все методы реализованы
- [ ] Фильтрация по типу работает
- [ ] Агрегация в get_user_stats через SQL
- [ ] Unit-тесты
