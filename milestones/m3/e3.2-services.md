# E3.2 ‚Äî Services

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞—Ä–∏—Ñ–∞–º–∏ –∏ —Å—á–µ—Ç–∞–º–∏.

---

## Tasks

### T3.2.1 ‚Äî Tariff service

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞—Ä–∏—Ñ–∞–º–∏.

**–§–∞–π–ª:** `backend/src/services/tariff_service.py`

**–ú–µ—Ç–æ–¥—ã:**
```python
class TariffService:
    def __init__(self, session: AsyncSession):
        self.session = session
        self.tariff_repo = TariffRepository(session)

    async def get_active_tariffs(self) -> list[TariffDTO]:
        """
        Get all active tariffs sorted by sort_order.
        Returns list of TariffDTO for display.
        """

    async def get_tariff_by_id(self, tariff_id: UUID) -> TariffDTO | None:
        """Get tariff by ID"""

    async def get_tariff_by_slug(self, slug: str) -> TariffDTO | None:
        """Get tariff by slug"""

    async def format_tariff_for_display(self, tariff: Tariff) -> str:
        """
        Format tariff for Telegram message.
        Example:
        üíé Premium
        100 —Ç–æ–∫–µ–Ω–æ–≤ + 30 –¥–Ω–µ–π –ø–æ–¥–ø–∏—Å–∫–∏
        üí∞ 499 ‚ÇΩ
        """
```

**DTO:**
```python
class TariffDTO(BaseModel):
    id: UUID
    slug: str
    name: str
    description: str | None
    price: Decimal
    price_display: str  # "499 ‚ÇΩ"
    tokens: int
    subscription_days: int
    benefits: str  # "100 —Ç–æ–∫–µ–Ω–æ–≤ + 30 –¥–Ω–µ–π –ø–æ–¥–ø–∏—Å–∫–∏"
```

**DoD:**
- [ ] –í—Å–µ –º–µ—Ç–æ–¥—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- [ ] TariffDTO —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è
- [ ] –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ price —Å –≤–∞–ª—é—Ç–æ–π
- [ ] Unit-—Ç–µ—Å—Ç—ã

---

### T3.2.2 ‚Äî Invoice service

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—á–µ—Ç–∞–º–∏.

**–§–∞–π–ª:** `backend/src/services/invoice_service.py`

**–ú–µ—Ç–æ–¥—ã:**
```python
class InvoiceService:
    def __init__(self, session: AsyncSession):
        self.session = session
        self.invoice_repo = InvoiceRepository(session)
        self.tariff_repo = TariffRepository(session)

    async def create_invoice(
        self,
        user_id: int,
        tariff_id: UUID,
        promo_code: str | None = None
    ) -> Invoice:
        """
        Create invoice for tariff purchase.

        1. Check for existing pending invoice (idempotency)
        2. Get tariff details
        3. Apply promo code if provided
        4. Calculate final amount
        5. Generate inv_id for Robokassa
        6. Create invoice with status=pending
        7. Set expires_at (e.g., +24h)
        """

    async def get_or_create_invoice(
        self,
        user_id: int,
        tariff_id: UUID,
        idempotency_key: str | None = None
    ) -> tuple[Invoice, bool]:
        """
        Get existing pending invoice or create new.
        Returns (invoice, created).
        """

    async def get_user_invoices(
        self,
        user_id: int,
        limit: int = 20
    ) -> list[InvoiceDTO]:
        """Get user's invoices for display"""

    async def get_invoice_for_payment(
        self,
        invoice_id: UUID
    ) -> InvoiceDTO | None:
        """Get invoice with all details for payment page"""

    async def cancel_invoice(self, invoice_id: UUID) -> Invoice:
        """Cancel pending invoice"""

    def generate_idempotency_key(
        self,
        user_id: int,
        tariff_id: UUID
    ) -> str:
        """Generate idempotency key based on user, tariff, and time window"""
```

**DTO:**
```python
class InvoiceDTO(BaseModel):
    id: UUID
    inv_id: int
    amount: Decimal
    amount_display: str  # "499 ‚ÇΩ"
    original_amount: Decimal | None
    discount: Decimal | None  # if promo applied
    tokens: int
    subscription_days: int
    status: InvoiceStatus
    status_display: str  # "–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã"
    tariff_name: str
    created_at: datetime
    expires_at: datetime
    is_expired: bool
```

**Idempotency:**
- Key format: `{user_id}:{tariff_id}:{time_window}`
- Time window: 1 hour (configurable)
- –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π pending invoice

**DoD:**
- [ ] –í—Å–µ –º–µ—Ç–æ–¥—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- [ ] Idempotency —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] expires_at —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
- [ ] Promo code –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è (–∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è M7)
- [ ] Unit-—Ç–µ—Å—Ç—ã
- [ ] Integration test: create ‚Üí get ‚Üí cancel
