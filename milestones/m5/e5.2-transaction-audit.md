# E5.2 ‚Äî Transaction & Audit

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –∏ –∞—É–¥–∏—Ç-–ª–æ–≥–æ–º.

---

## Tasks

### T5.2.1 ‚Äî Transaction service

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏.

**–§–∞–π–ª:** `backend/src/services/transaction_service.py`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
from uuid import UUID, uuid4
from datetime import datetime
from typing import Any

from sqlalchemy.ext.asyncio import AsyncSession

from db.repositories.transaction_repository import TransactionRepository
from db.models.transaction import Transaction, TransactionType
from services.dto.transaction import TransactionDTO, TransactionListDTO

class TransactionService:
    """Service for transaction operations"""

    def __init__(self, session: AsyncSession):
        self.session = session
        self.transaction_repo = TransactionRepository(session)

    async def create_transaction(
        self,
        user_id: int,
        type: TransactionType,
        tokens_delta: int,
        balance_after: int,
        description: str | None = None,
        invoice_id: UUID | None = None,
        metadata: dict[str, Any] | None = None,
    ) -> Transaction:
        """
        Create new transaction record.

        Args:
            user_id: Telegram user ID
            type: Transaction type (topup, spend, refund, adjustment)
            tokens_delta: Change in tokens (positive or negative)
            balance_after: Balance after this transaction
            description: Human-readable description
            invoice_id: Related invoice if any
            metadata: Additional data as JSON

        Returns:
            Created transaction
        """
        transaction = Transaction(
            id=uuid4(),
            user_id=user_id,
            type=type,
            tokens_delta=tokens_delta,
            balance_after=balance_after,
            description=description,
            invoice_id=invoice_id,
            metadata=metadata or {},
            created_at=datetime.utcnow(),
        )

        return await self.transaction_repo.create(transaction)

    async def get_user_transactions(
        self,
        user_id: int,
        limit: int = 20,
        offset: int = 0,
        type: TransactionType | None = None,
    ) -> TransactionListDTO:
        """
        Get user transactions with pagination.

        Args:
            user_id: Telegram user ID
            limit: Max number of transactions
            offset: Skip first N transactions
            type: Filter by transaction type

        Returns:
            TransactionListDTO with items and pagination info
        """
        transactions = await self.transaction_repo.get_by_user(
            user_id=user_id,
            limit=limit,
            offset=offset,
            type=type,
        )

        total = await self.transaction_repo.count_by_user(user_id, type)

        items = [self._to_dto(t) for t in transactions]

        return TransactionListDTO(
            items=items,
            total=total,
            limit=limit,
            offset=offset,
            has_more=offset + len(items) < total,
        )

    async def get_user_stats(self, user_id: int) -> dict:
        """Get aggregated transaction stats"""
        return await self.transaction_repo.get_user_stats(user_id)

    def _to_dto(self, transaction: Transaction) -> TransactionDTO:
        """Convert model to DTO"""
        return TransactionDTO(
            id=transaction.id,
            type=transaction.type,
            type_display=self._format_type(transaction.type),
            tokens_delta=transaction.tokens_delta,
            tokens_delta_display=self._format_delta(transaction.tokens_delta),
            balance_after=transaction.balance_after,
            description=transaction.description,
            invoice_id=transaction.invoice_id,
            created_at=transaction.created_at,
            created_at_display=transaction.created_at.strftime("%d.%m.%Y %H:%M"),
        )

    def _format_type(self, type: TransactionType) -> str:
        """Format transaction type for display"""
        mapping = {
            TransactionType.TOPUP: "üì• –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ",
            TransactionType.SPEND: "üì§ –°–ø–∏—Å–∞–Ω–∏–µ",
            TransactionType.REFUND: "‚Ü©Ô∏è –í–æ–∑–≤—Ä–∞—Ç",
            TransactionType.ADJUSTMENT: "‚öôÔ∏è –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞",
        }
        return mapping.get(type, str(type))

    def _format_delta(self, delta: int) -> str:
        """Format delta with sign"""
        if delta > 0:
            return f"+{delta}"
        return str(delta)
```

**DTO:**
```python
# services/dto/transaction.py
from pydantic import BaseModel
from uuid import UUID
from datetime import datetime
from db.models.transaction import TransactionType

class TransactionDTO(BaseModel):
    id: UUID
    type: TransactionType
    type_display: str
    tokens_delta: int
    tokens_delta_display: str  # "+100" or "-50"
    balance_after: int
    description: str | None
    invoice_id: UUID | None
    created_at: datetime
    created_at_display: str  # "01.02.2024 15:30"

class TransactionListDTO(BaseModel):
    items: list[TransactionDTO]
    total: int
    limit: int
    offset: int
    has_more: bool
```

**DoD:**
- [ ] –í—Å–µ –º–µ—Ç–æ–¥—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- [ ] Pagination —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] DTO —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- [ ] Unit-—Ç–µ—Å—Ç—ã

---

### T5.2.2 ‚Äî Audit service

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å –¥–ª—è –∑–∞–ø–∏—Å–∏ –∞—É–¥–∏—Ç-–ª–æ–≥–æ–≤.

**–§–∞–π–ª:** `backend/src/services/audit_service.py`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
from uuid import UUID, uuid4
from datetime import datetime
from typing import Any

from sqlalchemy.ext.asyncio import AsyncSession

from db.models.audit_log import AuditLog

class AuditService:
    """Service for audit logging"""

    def __init__(self, session: AsyncSession):
        self.session = session

    async def log_action(
        self,
        action: str,
        entity_type: str,
        entity_id: str | None = None,
        user_id: int | None = None,
        old_value: dict | None = None,
        new_value: dict | None = None,
        metadata: dict[str, Any] | None = None,
    ) -> AuditLog:
        """
        Create audit log entry.

        Args:
            action: Action name (e.g., "payment.processed", "user.created")
            entity_type: Type of entity (e.g., "invoice", "user")
            entity_id: ID of affected entity
            user_id: Telegram user ID if applicable
            old_value: State before change (as dict)
            new_value: State after change (as dict)
            metadata: Additional context

        Returns:
            Created audit log entry
        """
        audit_log = AuditLog(
            id=uuid4(),
            user_id=user_id,
            action=action,
            entity_type=entity_type,
            entity_id=entity_id,
            old_value=old_value,
            new_value=new_value,
            metadata=metadata or {},
            created_at=datetime.utcnow(),
        )

        self.session.add(audit_log)
        await self.session.flush()

        return audit_log

    async def log_payment_processed(
        self,
        user_id: int,
        invoice_id: UUID,
        old_balance: int,
        new_balance: int,
        old_subscription: datetime | None,
        new_subscription: datetime | None,
    ) -> AuditLog:
        """Log successful payment processing"""
        return await self.log_action(
            action="payment.processed",
            entity_type="invoice",
            entity_id=str(invoice_id),
            user_id=user_id,
            old_value={
                "token_balance": old_balance,
                "subscription_end": old_subscription.isoformat() if old_subscription else None,
            },
            new_value={
                "token_balance": new_balance,
                "subscription_end": new_subscription.isoformat() if new_subscription else None,
            },
        )

    async def log_user_created(self, user_id: int, username: str | None) -> AuditLog:
        """Log new user registration"""
        return await self.log_action(
            action="user.created",
            entity_type="user",
            entity_id=str(user_id),
            user_id=user_id,
            new_value={"username": username},
        )

    async def log_invoice_created(
        self,
        user_id: int,
        invoice_id: UUID,
        tariff_slug: str,
        amount: float,
    ) -> AuditLog:
        """Log invoice creation"""
        return await self.log_action(
            action="invoice.created",
            entity_type="invoice",
            entity_id=str(invoice_id),
            user_id=user_id,
            new_value={
                "tariff_slug": tariff_slug,
                "amount": amount,
            },
        )

    async def log_tokens_spent(
        self,
        user_id: int,
        amount: int,
        old_balance: int,
        new_balance: int,
        reason: str,
    ) -> AuditLog:
        """Log token spending"""
        return await self.log_action(
            action="tokens.spent",
            entity_type="user",
            entity_id=str(user_id),
            user_id=user_id,
            old_value={"token_balance": old_balance},
            new_value={"token_balance": new_balance},
            metadata={"amount": amount, "reason": reason},
        )
```

**DoD:**
- [ ] –ë–∞–∑–æ–≤—ã–π log_action —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [ ] –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ç–∏–ø–∏—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
- [ ] JSONB –¥–ª—è old_value/new_value
- [ ] Unit-—Ç–µ—Å—Ç—ã
