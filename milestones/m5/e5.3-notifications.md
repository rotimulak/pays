# E5.3 ‚Äî Notifications

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤ Telegram.

---

## Tasks

### T5.3.1 ‚Äî Notification service

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

**–§–∞–π–ª:** `backend/src/services/notification_service.py`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
import logging
from aiogram import Bot
from aiogram.exceptions import TelegramForbiddenError, TelegramBadRequest

from db.models.invoice import Invoice
from bot.keyboards.payment import get_payment_success_keyboard

logger = logging.getLogger(__name__)

class NotificationService:
    """Service for sending Telegram notifications"""

    def __init__(self, bot: Bot):
        self.bot = bot

    async def notify_payment_success(
        self,
        user_id: int,
        invoice: Invoice,
    ) -> bool:
        """
        Send payment success notification.

        Args:
            user_id: Telegram user ID
            invoice: Paid invoice

        Returns:
            True if message sent successfully
        """
        message = self._format_payment_success(invoice)
        keyboard = get_payment_success_keyboard()

        return await self._send_message(user_id, message, keyboard)

    async def notify_subscription_expiring(
        self,
        user_id: int,
        days_left: int,
    ) -> bool:
        """
        Send subscription expiring warning.

        Args:
            user_id: Telegram user ID
            days_left: Days until subscription expires

        Returns:
            True if message sent successfully
        """
        if days_left == 0:
            message = (
                "‚ö†Ô∏è –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç —Å–µ–≥–æ–¥–Ω—è!\n\n"
                "–ü—Ä–æ–¥–ª–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏—è–º.\n\n"
                "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ: /tariffs"
            )
        elif days_left == 1:
            message = (
                "‚ö†Ô∏è –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç –∑–∞–≤—Ç—Ä–∞!\n\n"
                "–ü—Ä–æ–¥–ª–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É: /tariffs"
            )
        else:
            message = (
                f"üìÖ –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ {days_left} –¥–Ω–µ–π.\n\n"
                "–ü—Ä–æ–¥–ª–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É: /tariffs"
            )

        return await self._send_message(user_id, message)

    async def notify_subscription_expired(self, user_id: int) -> bool:
        """Send subscription expired notification"""
        message = (
            "‚ùå –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞.\n\n"
            "–ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Å–µ—Ä–≤–∏—Å–æ–º, "
            "–æ—Ñ–æ—Ä–º–∏—Ç–µ –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É: /tariffs"
        )
        return await self._send_message(user_id, message)

    async def notify_low_balance(
        self,
        user_id: int,
        current_balance: int,
        threshold: int,
    ) -> bool:
        """Send low balance warning"""
        message = (
            f"‚ö†Ô∏è –ù–∞ –≤–∞—à–µ–º –±–∞–ª–∞–Ω—Å–µ –æ—Å—Ç–∞–ª–æ—Å—å –º–∞–ª–æ —Ç–æ–∫–µ–Ω–æ–≤: {current_balance}\n\n"
            "–ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Å–µ—Ä–≤–∏—Å–æ–º.\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ: /tariffs"
        )
        return await self._send_message(user_id, message)

    def _format_payment_success(self, invoice: Invoice) -> str:
        """Format payment success message"""
        parts = ["‚úÖ –û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞!\n"]

        parts.append(f"üí∞ –°—É–º–º–∞: {invoice.amount} ‚ÇΩ\n")

        if invoice.tokens > 0:
            parts.append(f"üé´ –ù–∞—á–∏—Å–ª–µ–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤: {invoice.tokens}\n")

        if invoice.subscription_days > 0:
            parts.append(f"üìÖ –ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∞ –Ω–∞: {invoice.subscription_days} –¥–Ω–µ–π\n")

        parts.append("\n–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É! üôè")

        return "".join(parts)

    async def _send_message(
        self,
        user_id: int,
        text: str,
        reply_markup=None,
    ) -> bool:
        """
        Send message to user with error handling.

        Returns:
            True if message sent, False if user blocked bot or error
        """
        try:
            await self.bot.send_message(
                chat_id=user_id,
                text=text,
                reply_markup=reply_markup,
            )
            logger.info(f"Notification sent to user {user_id}")
            return True

        except TelegramForbiddenError:
            logger.warning(f"User {user_id} blocked the bot")
            return False

        except TelegramBadRequest as e:
            logger.error(f"Failed to send notification to {user_id}: {e}")
            return False

        except Exception as e:
            logger.error(f"Unexpected error sending to {user_id}: {e}")
            return False
```

**DoD:**
- [ ] Payment success notification
- [ ] Subscription expiring warnings
- [ ] Low balance warning
- [ ] Error handling –¥–ª—è blocked users
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

---

### T5.3.2 ‚Äî Webhook integration

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å NotificationService —Å webhook handler.

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ webhook handler:**
```python
# api/routes/webhook.py

from aiogram import Bot
from services.notification_service import NotificationService
from services.billing_service import BillingService

@router.post("/robokassa", response_class=PlainTextResponse)
async def robokassa_result_url(
    # ... existing params ...
    bot: Bot = Depends(get_bot),
) -> str:
    """ResultURL callback handler with billing processing"""

    # ... signature verification ...

    # Process payment
    billing_service = BillingService(session)

    # Set up notification service
    notification_service = NotificationService(bot)
    billing_service.set_notification_service(notification_service)

    # Process payment (will send notification)
    invoice = await billing_service.process_successful_payment(
        invoice_id=webhook_data.shp_invoice_id
    )

    return provider.format_success_response(InvId)
```

**–î–æ–±–∞–≤–∏—Ç—å dependency –¥–ª—è Bot:**
```python
# api/dependencies.py

from aiogram import Bot
from bot import create_bot
from core.config import settings

_bot_instance: Bot | None = None

def get_bot() -> Bot:
    """Get or create Bot instance"""
    global _bot_instance
    if _bot_instance is None:
        _bot_instance = create_bot(settings.TELEGRAM_BOT_TOKEN)
    return _bot_instance
```

**DoD:**
- [ ] NotificationService –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ webhook
- [ ] Bot dependency –¥–æ–±–∞–≤–ª–µ–Ω
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- [ ] Integration test: payment ‚Üí notification
