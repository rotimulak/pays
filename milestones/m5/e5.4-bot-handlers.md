# E5.4 ‚Äî Bot Handlers

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω–∏–µ handlers –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ –±–∞–ª–∞–Ω—Å–∞.

---

## Tasks

### T5.4.1 ‚Äî History handler

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å handler –¥–ª—è –∫–æ–º–∞–Ω–¥—ã `/history`.

**–§–∞–π–ª:** `backend/src/bot/handlers/history.py`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
from aiogram import Router, F
from aiogram.filters import Command
from aiogram.types import Message, CallbackQuery
from aiogram.utils.keyboard import InlineKeyboardBuilder

from sqlalchemy.ext.asyncio import AsyncSession

from db.models.user import User
from services.transaction_service import TransactionService
from bot.callbacks.pagination import PaginationCallback

router = Router()

ITEMS_PER_PAGE = 10

@router.message(Command("history"))
@router.message(F.text == "üìú –ò—Å—Ç–æ—Ä–∏—è")
async def cmd_history(
    message: Message,
    user: User,
    session: AsyncSession,
) -> None:
    """Show transaction history"""
    service = TransactionService(session)
    result = await service.get_user_transactions(
        user_id=user.id,
        limit=ITEMS_PER_PAGE,
        offset=0,
    )

    text = format_history_message(result.items, result.total, 1)
    keyboard = get_pagination_keyboard(
        current_page=1,
        total_items=result.total,
        items_per_page=ITEMS_PER_PAGE,
        callback_prefix="history",
    )

    await message.answer(text, reply_markup=keyboard)

@router.callback_query(PaginationCallback.filter(F.prefix == "history"))
async def history_pagination(
    callback: CallbackQuery,
    callback_data: PaginationCallback,
    user: User,
    session: AsyncSession,
) -> None:
    """Handle history pagination"""
    service = TransactionService(session)

    offset = (callback_data.page - 1) * ITEMS_PER_PAGE
    result = await service.get_user_transactions(
        user_id=user.id,
        limit=ITEMS_PER_PAGE,
        offset=offset,
    )

    text = format_history_message(result.items, result.total, callback_data.page)
    keyboard = get_pagination_keyboard(
        current_page=callback_data.page,
        total_items=result.total,
        items_per_page=ITEMS_PER_PAGE,
        callback_prefix="history",
    )

    await callback.message.edit_text(text, reply_markup=keyboard)
    await callback.answer()

def format_history_message(
    transactions: list,
    total: int,
    page: int,
) -> str:
    """Format transaction history for display"""
    if not transactions:
        return (
            "üìú –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π\n\n"
            "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.\n\n"
            "–ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å: /tariffs"
        )

    lines = ["üìú –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π\n"]

    for tx in transactions:
        lines.append(
            f"{tx.type_display}\n"
            f"  {tx.tokens_delta_display} —Ç–æ–∫–µ–Ω–æ–≤ ‚Üí {tx.balance_after}\n"
            f"  {tx.created_at_display}\n"
        )

    total_pages = (total + ITEMS_PER_PAGE - 1) // ITEMS_PER_PAGE
    lines.append(f"\n–°—Ç—Ä–∞–Ω–∏—Ü–∞ {page} –∏–∑ {total_pages}")

    return "\n".join(lines)

def get_pagination_keyboard(
    current_page: int,
    total_items: int,
    items_per_page: int,
    callback_prefix: str,
):
    """Create pagination keyboard"""
    total_pages = (total_items + items_per_page - 1) // items_per_page

    builder = InlineKeyboardBuilder()

    if current_page > 1:
        builder.button(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥",
            callback_data=PaginationCallback(
                prefix=callback_prefix,
                page=current_page - 1,
            ),
        )

    if current_page < total_pages:
        builder.button(
            text="–í–ø–µ—Ä—ë–¥ ‚ñ∂Ô∏è",
            callback_data=PaginationCallback(
                prefix=callback_prefix,
                page=current_page + 1,
            ),
        )

    builder.adjust(2)
    return builder.as_markup()
```

**Callback data:**
```python
# bot/callbacks/pagination.py
from aiogram.filters.callback_data import CallbackData

class PaginationCallback(CallbackData, prefix="page"):
    prefix: str  # "history", "invoices", etc.
    page: int
```

**DoD:**
- [ ] `/history` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- [ ] Pagination —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ü—É—Å—Ç–∞—è –∏—Å—Ç–æ—Ä–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
- [ ] –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Ç–∞–µ–º–æ–µ

---

### T5.4.2 ‚Äî Balance handler

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å handler –¥–ª—è –∫–æ–º–∞–Ω–¥—ã `/balance`.

**–§–∞–π–ª:** `backend/src/bot/handlers/balance.py`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
from aiogram import Router, F
from aiogram.filters import Command
from aiogram.types import Message
from datetime import datetime

from sqlalchemy.ext.asyncio import AsyncSession

from db.models.user import User
from services.transaction_service import TransactionService

router = Router()

@router.message(Command("balance"))
async def cmd_balance(
    message: Message,
    user: User,
    session: AsyncSession,
) -> None:
    """Show current balance and subscription status"""
    service = TransactionService(session)
    stats = await service.get_user_stats(user.id)

    text = format_balance_message(user, stats)
    await message.answer(text)

def format_balance_message(user: User, stats: dict) -> str:
    """Format balance information"""
    lines = ["üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å\n"]

    # Current balance
    lines.append(f"üé´ –¢–æ–∫–µ–Ω—ã: {user.token_balance}")

    # Subscription status
    if user.subscription_end:
        now = datetime.utcnow()
        if user.subscription_end > now:
            days_left = (user.subscription_end - now).days
            lines.append(
                f"üìÖ –ü–æ–¥–ø–∏—Å–∫–∞: –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ {user.subscription_end.strftime('%d.%m.%Y')}"
            )
            if days_left <= 3:
                lines.append(f"   ‚ö†Ô∏è –û—Å—Ç–∞–ª–æ—Å—å {days_left} –¥–Ω–µ–π!")
        else:
            lines.append("üìÖ –ü–æ–¥–ø–∏—Å–∫–∞: –∏—Å—Ç–µ–∫–ª–∞")
    else:
        lines.append("üìÖ –ü–æ–¥–ø–∏—Å–∫–∞: –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞")

    # Stats
    lines.append("\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
    lines.append(f"  –í—Å–µ–≥–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–æ: {stats.get('total_topup', 0)} —Ç–æ–∫–µ–Ω–æ–≤")
    lines.append(f"  –í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ: {stats.get('total_spent', 0)} —Ç–æ–∫–µ–Ω–æ–≤")

    # Actions
    lines.append("\nüí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å: /tariffs")
    lines.append("üìú –ò—Å—Ç–æ—Ä–∏—è: /history")

    return "\n".join(lines)
```

**–°–æ–æ–±—â–µ–Ω–∏–µ:**
```
üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å

üé´ –¢–æ–∫–µ–Ω—ã: 150
üìÖ –ü–æ–¥–ø–∏—Å–∫–∞: –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ 01.03.2024
   ‚ö†Ô∏è –û—Å—Ç–∞–ª–æ—Å—å 3 –¥–Ω—è!

üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
  –í—Å–µ–≥–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–æ: 200 —Ç–æ–∫–µ–Ω–æ–≤
  –í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ: 50 —Ç–æ–∫–µ–Ω–æ–≤

üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å: /tariffs
üìú –ò—Å—Ç–æ—Ä–∏—è: /history
```

**DoD:**
- [ ] `/balance` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å
- [ ] –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è
- [ ] –°—Å—ã–ª–∫–∏ –Ω–∞ —Ç–∞—Ä–∏—Ñ—ã –∏ –∏—Å—Ç–æ—Ä–∏—é
