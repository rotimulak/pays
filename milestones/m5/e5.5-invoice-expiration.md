# E5.5 — Invoice Expiration

## Описание

Создание механизма автоматического истечения неоплаченных счетов.

---

## Tasks

### T5.5.1 — Expiration script

**Описание:** Создать скрипт для перевода просроченных invoices в статус expired.

**Файл:** `backend/scripts/expire_invoices.py`

**Реализация:**
```python
"""
Script to expire old pending invoices.

Run periodically via cron or scheduler:
    python -m scripts.expire_invoices

Or with custom TTL:
    python -m scripts.expire_invoices --ttl-hours 12
"""

import asyncio
import argparse
import logging
from datetime import datetime, timedelta

from db.session import async_session_factory
from db.repositories.invoice_repository import InvoiceRepository
from db.models.invoice import InvoiceStatus
from services.audit_service import AuditService
from core.config import settings

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
)
logger = logging.getLogger(__name__)

async def expire_invoices(ttl_hours: int | None = None) -> int:
    """
    Expire old pending invoices.

    Args:
        ttl_hours: Hours after which pending invoice expires.
                   Defaults to INVOICE_TTL_HOURS from settings.

    Returns:
        Number of expired invoices
    """
    ttl = ttl_hours or settings.INVOICE_TTL_HOURS
    cutoff_time = datetime.utcnow() - timedelta(hours=ttl)

    logger.info(f"Expiring invoices older than {cutoff_time} (TTL: {ttl}h)")

    async with async_session_factory() as session:
        repo = InvoiceRepository(session)
        audit = AuditService(session)

        # Get pending invoices older than cutoff
        expired_count = await repo.expire_old_pending(cutoff_time)

        if expired_count > 0:
            await audit.log_action(
                action="invoices.expired",
                entity_type="system",
                metadata={
                    "count": expired_count,
                    "cutoff_time": cutoff_time.isoformat(),
                    "ttl_hours": ttl,
                },
            )

        await session.commit()

    logger.info(f"Expired {expired_count} invoices")
    return expired_count

async def main():
    parser = argparse.ArgumentParser(description="Expire old pending invoices")
    parser.add_argument(
        "--ttl-hours",
        type=int,
        default=None,
        help=f"Hours until invoice expires (default: {settings.INVOICE_TTL_HOURS})",
    )
    parser.add_argument(
        "--dry-run",
        action="store_true",
        help="Show what would be expired without making changes",
    )

    args = parser.parse_args()

    if args.dry_run:
        logger.info("DRY RUN - no changes will be made")
        # TODO: implement dry run mode
        return

    count = await expire_invoices(args.ttl_hours)
    print(f"Expired {count} invoices")

if __name__ == "__main__":
    asyncio.run(main())
```

**Репозиторий метод:**
```python
# db/repositories/invoice_repository.py

async def expire_old_pending(self, before: datetime) -> int:
    """
    Set expired status for old pending invoices.

    Args:
        before: Expire invoices created before this time

    Returns:
        Number of expired invoices
    """
    result = await self.session.execute(
        update(Invoice)
        .where(Invoice.status == InvoiceStatus.PENDING)
        .where(Invoice.created_at < before)
        .values(
            status=InvoiceStatus.EXPIRED,
            updated_at=datetime.utcnow(),
        )
    )
    return result.rowcount

async def get_expiring_invoices(
    self,
    before: datetime,
    limit: int = 100,
) -> list[Invoice]:
    """
    Get pending invoices that will be expired.
    Useful for dry-run mode.
    """
    result = await self.session.execute(
        select(Invoice)
        .where(Invoice.status == InvoiceStatus.PENDING)
        .where(Invoice.created_at < before)
        .limit(limit)
    )
    return list(result.scalars().all())
```

**Cron setup:**
```bash
# Run every hour
0 * * * * cd /app && python -m scripts.expire_invoices >> /var/log/expire_invoices.log 2>&1

# Or in docker-compose with scheduler service
```

**Alternative: Background task in FastAPI:**
```python
# api/tasks.py
from fastapi import BackgroundTasks
from apscheduler.schedulers.asyncio import AsyncIOScheduler

scheduler = AsyncIOScheduler()

@scheduler.scheduled_job("interval", hours=1)
async def scheduled_expire_invoices():
    """Run invoice expiration every hour"""
    from scripts.expire_invoices import expire_invoices
    await expire_invoices()

def start_scheduler():
    scheduler.start()
```

**DoD:**
- [ ] Скрипт переводит pending → expired
- [ ] Настраиваемый TTL
- [ ] Логирование и аудит
- [ ] Dry-run режим
- [ ] Документация по настройке cron
- [ ] Альтернатива: background scheduler
