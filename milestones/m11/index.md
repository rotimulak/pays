# M11: Simplified Payment UX

## Обзор

Упрощение UX бота: меню 2 уровня, скрытие тарифов от пользователя, интуитивное пополнение баланса. Тариф остаётся в системе, но пользователь просто пополняет баланс и использует токены.

---

## Epics & Tasks

| Epic | Задачи | Описание |
|------|--------|----------|
| [E11.1 — Model Updates](e11.1-model-updates.md) | 3 tasks | Новые поля в Tariff, миграция |
| [E11.2 — Payment Service](e11.2-payment-service.md) | 4 tasks | Логика первого/повторного платежа |
| [E11.3 — Bot Menu](e11.3-bot-menu.md) | 4 tasks | Упрощение главного меню |
| [E11.4 — Balance Handler](e11.4-balance-handler.md) | 5 tasks | Экран баланса, кнопки пополнения |
| [E11.5 — Custom Amount](e11.5-custom-amount.md) | 3 tasks | FSM для ввода произвольной суммы |
| [E11.6 — Notifications](e11.6-notifications.md) | 3 tasks | Уведомления об истечении подписки |
| [E11.7 — Subscription Tasks](e11.7-subscription-tasks.md) | 3 tasks | Автопродление с новой логикой |

---

## Бизнес-логика

### Модель оплаты

| Параметр | Значение |
|----------|----------|
| Минимальный платёж | 200₽ |
| Абонплата | 100 токенов/период |
| Период | 1 месяц (настраиваемо) |

### Логика зачисления

```
Первый платёж или подписка истекла:
├── Списать subscription_fee (100 токенов) как абонплату
├── Остаток зачислить на баланс
└── Активировать подписку на 1 период

Повторный платёж (подписка активна):
└── Вся сумма → токены на баланс
```

---

## Definition of Done

### Функциональность

- [ ] `/start` показывает двухкнопочное меню: Баланс, Помощь
- [ ] Кнопка "Баланс" показывает текущий баланс и статус подписки
- [ ] Кнопка "Пополнить 200₽" создаёт invoice и редиректит на оплату
- [ ] "Другая сумма" принимает ввод >= 200₽
- [ ] Первый платёж: абонплата списывается, остаток на баланс
- [ ] Повторный платёж: вся сумма на баланс
- [ ] Автопродление списывает subscription_fee при истечении
- [ ] При недостатке токенов подписка деактивируется
- [ ] Уведомления за 3 и 1 день до истечения

### Удалено

- [ ] Команда `/tariffs` удалена
- [ ] Меню выбора тарифа удалено
- [ ] Старая команда `/pay` с выбором тарифа удалена

### Качество

- [ ] `mypy --strict` без ошибок
- [ ] `ruff check && ruff format` без замечаний
- [ ] Тесты для критичных путей

---

## Зависимости

```
M9 (Subscription Management) ──> M11 (Simplified UX)
```

## Разблокирует

- Нет (финальный UX milestone)
