# E11.1 — Model Updates

## Описание

Добавление новых полей в модель Tariff для поддержки гибкого периода подписки, абонплаты и минимального платежа.

---

## Tasks

### T11.1.1 — Add PeriodUnit enum

**Описание:** Создать ENUM для единиц периода подписки.

**Файл:** `backend/src/db/models/tariff.py`

**Код:**
```python
class PeriodUnit(str, Enum):
    HOUR = "hour"    # для тестирования
    DAY = "day"
    MONTH = "month"
```

**DoD:**
- [ ] Enum PeriodUnit создан
- [ ] Добавлен в `__all__` модуля

---

### T11.1.2 — Update Tariff model

**Описание:** Добавить новые поля в модель Tariff.

**Файл:** `backend/src/db/models/tariff.py`

**Новые поля:**
```python
# Период подписки
period_unit: Mapped[PeriodUnit] = mapped_column(
    SQLEnum(PeriodUnit, name="period_unit"),
    default=PeriodUnit.MONTH,
    nullable=False
)
period_value: Mapped[int] = mapped_column(
    Integer,
    default=1,
    nullable=False
)

# Абонплата (токены)
subscription_fee: Mapped[int] = mapped_column(
    Integer,
    default=100,
    nullable=False
)

# Минимальный платёж (рубли)
min_payment: Mapped[Decimal] = mapped_column(
    Numeric(10, 2),
    default=Decimal("200.00"),
    nullable=False
)
```

**Constraints:**
- `period_value > 0`
- `subscription_fee >= 0`
- `min_payment > 0`

**DoD:**
- [ ] Все поля добавлены с правильными типами
- [ ] Default values установлены
- [ ] CHECK constraints определены

---

### T11.1.3 — Create migration

**Описание:** Создать Alembic миграцию для новых полей.

**Команда:**
```bash
cd backend && alembic revision --autogenerate -m "add_period_and_fee_to_tariff"
```

**Миграция должна включать:**
```sql
-- Создание ENUM типа
CREATE TYPE period_unit AS ENUM ('hour', 'day', 'month');

-- Добавление полей
ALTER TABLE tariffs ADD COLUMN period_unit period_unit NOT NULL DEFAULT 'month';
ALTER TABLE tariffs ADD COLUMN period_value INT NOT NULL DEFAULT 1;
ALTER TABLE tariffs ADD COLUMN subscription_fee INT NOT NULL DEFAULT 100;
ALTER TABLE tariffs ADD COLUMN min_payment DECIMAL(10,2) NOT NULL DEFAULT 200.00;

-- Constraints
ALTER TABLE tariffs ADD CONSTRAINT chk_tariffs_period_value CHECK (period_value > 0);
ALTER TABLE tariffs ADD CONSTRAINT chk_tariffs_subscription_fee CHECK (subscription_fee >= 0);
ALTER TABLE tariffs ADD CONSTRAINT chk_tariffs_min_payment CHECK (min_payment > 0);

-- Индекс
CREATE INDEX idx_tariffs_period ON tariffs(period_unit, period_value)
    WHERE is_active = true AND deleted_at IS NULL;
```

**Обновить seed данные:**
```sql
UPDATE tariffs SET
    period_unit = 'month',
    period_value = 1,
    subscription_fee = 100,
    min_payment = 200.00
WHERE slug = 'basic';
```

**DoD:**
- [ ] Миграция создана
- [ ] `alembic upgrade head` выполняется успешно
- [ ] `alembic downgrade -1` выполняется успешно
- [ ] Seed данные обновлены
