# E11.4 ‚Äî Balance Handler

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞ –±–∞–ª–∞–Ω—Å–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–æ–∫–µ–Ω–∞—Ö, —Å—Ç–∞—Ç—É—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –∫–Ω–æ–ø–∫–∞–º–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è.

---

## Tasks

### T11.4.1 ‚Äî Create balance messages

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å —Ç–µ–∫—Å—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –±–∞–ª–∞–Ω—Å–∞.

**–§–∞–π–ª:** `backend/src/bot/messages/balance.py`

**–ö–æ–¥:**
```python
BALANCE_ACTIVE = """
üìä **–í–∞—à –±–∞–ª–∞–Ω—Å**

üí≥ –ë–∞–ª–∞–Ω—Å: **{balance}** —Ç–æ–∫–µ–Ω–æ–≤
üìÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ: **{subscription_end}**

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚ÑπÔ∏è –ê–±–æ–Ω–ø–ª–∞—Ç–∞: {subscription_fee} —Ç–æ–∫–µ–Ω–æ–≤/–º–µ—Å.
–¢–æ–∫–µ–Ω—ã —Ä–∞—Å—Ö–æ–¥—É—é—Ç—Å—è –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã.
–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ: {min_payment}‚ÇΩ
"""

BALANCE_INACTIVE = """
üìä **–í–∞—à –±–∞–ª–∞–Ω—Å**

üí≥ –ë–∞–ª–∞–Ω—Å: **{balance}** —Ç–æ–∫–µ–Ω–æ–≤
‚ö†Ô∏è –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚ÑπÔ∏è –î–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–ø–æ–ª–Ω–∏—Ç–µ –º–∏–Ω–∏–º—É–º {min_payment}‚ÇΩ.
{subscription_fee} —Ç–æ–∫–µ–Ω–æ–≤ ‚Äî –∞–±–æ–Ω–ø–ª–∞—Ç–∞,
–æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –Ω–∞ –±–∞–ª–∞–Ω—Å.
"""

PAYMENT_SUCCESS = """
‚úÖ **–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω!**

üí∞ –ó–∞—á–∏—Å–ª–µ–Ω–æ: **{tokens_credited}** —Ç–æ–∫–µ–Ω–æ–≤
{subscription_info}
üí≥ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: **{new_balance}** —Ç–æ–∫–µ–Ω–æ–≤
"""

SUBSCRIPTION_ACTIVATED = "üéâ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –¥–æ: **{subscription_end}**"
SUBSCRIPTION_FEE_DEDUCTED = "üìã –°–ø–∏—Å–∞–Ω–æ –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É: {fee} —Ç–æ–∫–µ–Ω–æ–≤"
```

**DoD:**
- [ ] –í—Å–µ —Ç–µ–∫—Å—Ç—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] Placeholders –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

---

### T11.4.2 ‚Äî Create balance keyboard

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –±–∞–ª–∞–Ω—Å–∞.

**–§–∞–π–ª:** `backend/src/bot/keyboards/balance.py`

**–ö–æ–¥:**
```python
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from decimal import Decimal

def get_balance_keyboard(min_payment: Decimal = Decimal("200.00")) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —ç–∫—Ä–∞–Ω–∞ –±–∞–ª–∞–Ω—Å–∞."""
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(
                text=f"üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å {int(min_payment)}‚ÇΩ",
                callback_data=f"pay:{int(min_payment)}"
            ),
            InlineKeyboardButton(
                text="‚úèÔ∏è –î—Ä—É–≥–∞—è —Å—É–º–º–∞",
                callback_data="pay:custom"
            )
        ],
        [
            InlineKeyboardButton(text="üìã –ò—Å—Ç–æ—Ä–∏—è", callback_data="history"),
            InlineKeyboardButton(text="‚ùì –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç", callback_data="help:payment")
        ],
        [
            InlineKeyboardButton(text="‚óÄÔ∏è –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")
        ]
    ])
```

**DoD:**
- [ ] –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞
- [ ] –ö–Ω–æ–ø–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Å —Å—É–º–º–æ–π –∏–∑ —Ç–∞—Ä–∏—Ñ–∞
- [ ] –ö–Ω–æ–ø–∫–∞ "–î—Ä—É–≥–∞—è —Å—É–º–º–∞"
- [ ] –ö–Ω–æ–ø–∫–∏ –ò—Å—Ç–æ—Ä–∏—è –∏ –ü–æ–º–æ—â—å
- [ ] –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é

---

### T11.4.3 ‚Äî Create balance handler

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å handler –¥–ª—è –ø–æ–∫–∞–∑–∞ –±–∞–ª–∞–Ω—Å–∞.

**–§–∞–π–ª:** `backend/src/bot/handlers/balance.py`

**–ö–æ–¥:**
```python
from aiogram import Router, F
from aiogram.types import CallbackQuery
from datetime import datetime

from src.bot.keyboards.balance import get_balance_keyboard
from src.bot.messages.balance import BALANCE_ACTIVE, BALANCE_INACTIVE
from src.services.token_service import TokenService
from src.db.repositories.user_repository import UserRepository
from src.db.repositories.tariff_repository import TariffRepository

router = Router()

@router.callback_query(F.data == "balance")
async def on_balance(
    callback: CallbackQuery,
    session: AsyncSession
):
    """–ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –±–∞–ª–∞–Ω—Å–∞."""
    user_repo = UserRepository(session)
    tariff_repo = TariffRepository(session)
    token_service = TokenService(session)

    user = await user_repo.get_by_telegram_id(callback.from_user.id)
    tariff = await tariff_repo.get_active_tariff()
    balance = await token_service.get_balance(callback.from_user.id)

    is_active = user.subscription_end and user.subscription_end > datetime.utcnow()

    if is_active:
        text = BALANCE_ACTIVE.format(
            balance=balance,
            subscription_end=user.subscription_end.strftime("%d.%m.%Y"),
            subscription_fee=tariff.subscription_fee,
            min_payment=int(tariff.min_payment)
        )
    else:
        text = BALANCE_INACTIVE.format(
            balance=balance,
            subscription_fee=tariff.subscription_fee,
            min_payment=int(tariff.min_payment)
        )

    await callback.message.edit_text(
        text,
        parse_mode="Markdown",
        reply_markup=get_balance_keyboard(tariff.min_payment)
    )
    await callback.answer()
```

**DoD:**
- [ ] Handler —Å–æ–∑–¥–∞–Ω
- [ ] –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
- [ ] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –±–∞–ª–∞–Ω—Å–∞

---

### T11.4.4 ‚Äî Create quick payment handler

**–û–ø–∏—Å–∞–Ω–∏–µ:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—É–º–º—É.

**–§–∞–π–ª:** `backend/src/bot/handlers/balance.py`

**–ö–æ–¥:**
```python
from aiogram.filters.callback_data import CallbackData

class PayCallback(CallbackData, prefix="pay"):
    amount: str  # —á–∏—Å–ª–æ –∏–ª–∏ "custom"

@router.callback_query(PayCallback.filter(F.amount != "custom"))
async def on_quick_pay(
    callback: CallbackQuery,
    callback_data: PayCallback,
    session: AsyncSession
):
    """–ë—ã—Å—Ç—Ä–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—É–º–º—É."""
    amount = Decimal(callback_data.amount)

    # –°–æ–∑–¥–∞—ë–º invoice –∏ –ø–æ–ª—É—á–∞–µ–º URL –æ–ø–ª–∞—Ç—ã
    billing_service = BillingService(session)
    payment_url = await billing_service.create_payment(
        user_id=callback.from_user.id,
        amount=amount
    )

    await callback.message.edit_text(
        f"üí≥ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞ {int(amount)}‚ÇΩ\n\n"
        f"–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –æ–ø–ª–∞—Ç–µ:",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üí≥ –û–ø–ª–∞—Ç–∏—Ç—å", url=payment_url)],
            [InlineKeyboardButton(text="‚óÄÔ∏è –û—Ç–º–µ–Ω–∞", callback_data="balance")]
        ])
    )
    await callback.answer()
```

**DoD:**
- [ ] CallbackData –¥–ª—è –æ–ø–ª–∞—Ç—ã —Å–æ–∑–¥–∞–Ω
- [ ] Handler —Å–æ–∑–¥–∞—ë—Ç invoice
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É —Å URL –æ–ø–ª–∞—Ç—ã
- [ ] –ï—Å—Ç—å –∫–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã

---

### T11.4.5 ‚Äî Add main menu callback

**–û–ø–∏—Å–∞–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.

**–§–∞–π–ª:** `backend/src/bot/handlers/start.py`

**–ö–æ–¥:**
```python
@router.callback_query(F.data == "main_menu")
async def on_main_menu(callback: CallbackQuery):
    """–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é."""
    await callback.message.edit_text(
        "üëã –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=get_main_menu_keyboard()
    )
    await callback.answer()
```

**DoD:**
- [ ] Callback handler –¥–æ–±–∞–≤–ª–µ–Ω
- [ ] –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
- [ ] –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ)
