# E11.5 ‚Äî Custom Amount FSM

## –û–ø–∏—Å–∞–Ω–∏–µ

FSM –¥–ª—è –≤–≤–æ–¥–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–π —Å—É–º–º—ã –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞.

---

## Tasks

### T11.5.1 ‚Äî Create payment states

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –≤–≤–æ–¥–∞ —Å—É–º–º—ã.

**–§–∞–π–ª:** `backend/src/bot/states/payment.py`

**–ö–æ–¥:**
```python
from aiogram.fsm.state import State, StatesGroup

class PaymentStates(StatesGroup):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–ø–ª–∞—Ç—ã."""
    waiting_for_amount = State()
```

**DoD:**
- [ ] StatesGroup —Å–æ–∑–¥–∞–Ω
- [ ] –°–æ—Å—Ç–æ—è–Ω–∏–µ waiting_for_amount –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ

---

### T11.5.2 ‚Äî Create custom amount handler

**–û–ø–∏—Å–∞–Ω–∏–µ:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è "–î—Ä—É–≥–∞—è —Å—É–º–º–∞" –∏ –≤–≤–æ–¥–∞ –∑–Ω–∞—á–µ–Ω–∏—è.

**–§–∞–π–ª:** `backend/src/bot/handlers/balance.py`

**–ö–æ–¥:**
```python
from aiogram.fsm.context import FSMContext
from src.bot.states.payment import PaymentStates

@router.callback_query(PayCallback.filter(F.amount == "custom"))
async def on_custom_amount(
    callback: CallbackQuery,
    state: FSMContext,
    session: AsyncSession
):
    """–ù–∞—á–∞–ª–æ –≤–≤–æ–¥–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–π —Å—É–º–º—ã."""
    tariff_repo = TariffRepository(session)
    tariff = await tariff_repo.get_active_tariff()

    await state.set_state(PaymentStates.waiting_for_amount)
    await state.update_data(min_payment=int(tariff.min_payment))

    await callback.message.edit_text(
        f"‚úèÔ∏è **–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è**\n\n"
        f"–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: {int(tariff.min_payment)}‚ÇΩ\n\n"
        f"–û—Ç–ø—Ä–∞–≤—å—Ç–µ —á–∏—Å–ª–æ (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã):",
        parse_mode="Markdown",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="‚óÄÔ∏è –û—Ç–º–µ–Ω–∞", callback_data="balance")]
        ])
    )
    await callback.answer()


@router.message(PaymentStates.waiting_for_amount)
async def on_amount_input(
    message: Message,
    state: FSMContext,
    session: AsyncSession
):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–µ–¥—ë–Ω–Ω–æ–π —Å—É–º–º—ã."""
    data = await state.get_data()
    min_payment = data.get("min_payment", 200)

    # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞
    try:
        amount = int(message.text.strip())
    except ValueError:
        await message.answer(
            "‚ùå –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã).\n"
            f"–ú–∏–Ω–∏–º—É–º: {min_payment}‚ÇΩ"
        )
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å—É–º–º—ã
    if amount < min_payment:
        await message.answer(
            f"‚ùå –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: {min_payment}‚ÇΩ\n"
            f"–í—ã –≤–≤–µ–ª–∏: {amount}‚ÇΩ"
        )
        return

    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    await state.clear()

    # –°–æ–∑–¥–∞—ë–º –ø–ª–∞—Ç—ë–∂
    billing_service = BillingService(session)
    payment_url = await billing_service.create_payment(
        user_id=message.from_user.id,
        amount=Decimal(amount)
    )

    await message.answer(
        f"üí≥ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞ {amount}‚ÇΩ\n\n"
        f"–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –æ–ø–ª–∞—Ç–µ:",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üí≥ –û–ø–ª–∞—Ç–∏—Ç—å", url=payment_url)],
            [InlineKeyboardButton(text="‚óÄÔ∏è –û—Ç–º–µ–Ω–∞", callback_data="balance")]
        ])
    )
```

**DoD:**
- [ ] Handler –¥–ª—è "–î—Ä—É–≥–∞—è —Å—É–º–º–∞" —Å–æ–∑–¥–∞–Ω
- [ ] FSM —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
- [ ] Handler –¥–ª—è –≤–≤–æ–¥–∞ —Å—É–º–º—ã —Å–æ–∑–¥–∞–Ω
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —á–∏—Å–ª–æ
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å—É–º–º—ã

---

### T11.5.3 ‚Äî Handle FSM cancel

**–û–ø–∏—Å–∞–Ω–∏–µ:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã –≤–≤–æ–¥–∞ —Å—É–º–º—ã.

**–§–∞–π–ª:** `backend/src/bot/handlers/balance.py`

**–ö–æ–¥:**
```python
@router.callback_query(F.data == "balance", PaymentStates.waiting_for_amount)
async def on_cancel_amount_input(
    callback: CallbackQuery,
    state: FSMContext,
    session: AsyncSession
):
    """–û—Ç–º–µ–Ω–∞ –≤–≤–æ–¥–∞ —Å—É–º–º—ã –∏ –≤–æ–∑–≤—Ä–∞—Ç –∫ –±–∞–ª–∞–Ω—Å—É."""
    await state.clear()
    # –í—ã–∑—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π handler –±–∞–ª–∞–Ω—Å–∞
    await on_balance(callback, session)
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ ‚Äî middleware –¥–ª—è –∞–≤—Ç–æ–æ—Ç–º–µ–Ω—ã:**
```python
# –í middleware –ø—Ä–æ–≤–µ—Ä—è—Ç—å, –µ—Å–ª–∏ callback –Ω–µ —Å–≤—è–∑–∞–Ω —Å —Ç–µ–∫—É—â–∏–º FSM,
# –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
```

**DoD:**
- [ ] –û—Ç–º–µ–Ω–∞ FSM –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–ù–∞–∑–∞–¥"
- [ ] –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—á–∏—â–∞–µ—Ç—Å—è
- [ ] –í–æ–∑–≤—Ä–∞—Ç –∫ —ç–∫—Ä–∞–Ω—É –±–∞–ª–∞–Ω—Å–∞
