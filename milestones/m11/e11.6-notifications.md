# E11.6 ‚Äî Notifications

## –û–ø–∏—Å–∞–Ω–∏–µ

–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏: –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–ø–∏—Å–∞–Ω–∏–∏.

---

## Tasks

### T11.6.1 ‚Äî Create notification messages

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å —Ç–µ–∫—Å—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

**–§–∞–π–ª:** `backend/src/bot/messages/notifications.py`

**–ö–æ–¥:**
```python
# –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏
SUBSCRIPTION_EXPIRING_SOON = """
‚è∞ **–ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ {days} –¥–Ω.**

–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {balance} —Ç–æ–∫–µ–Ω–æ–≤
–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è: {subscription_fee} —Ç–æ–∫–µ–Ω–æ–≤

{action_text}
"""

ACTION_ENOUGH_BALANCE = "‚úÖ –ë–∞–ª–∞–Ω—Å –¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω ‚Äî –ø–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."
ACTION_LOW_BALANCE = "‚ö†Ô∏è –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å, —á—Ç–æ–±—ã –ø–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–∏–ª–∞—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."

# –£—Å–ø–µ—à–Ω–æ–µ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ
SUBSCRIPTION_RENEWED = """
‚úÖ **–ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∞!**

üìÖ –ù–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: {subscription_end}
üí≥ –°–ø–∏—Å–∞–Ω–æ: {subscription_fee} —Ç–æ–∫–µ–Ω–æ–≤
üí∞ –û—Å—Ç–∞—Ç–æ–∫: {balance} —Ç–æ–∫–µ–Ω–æ–≤
"""

# –ü–æ–¥–ø–∏—Å–∫–∞ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞
SUBSCRIPTION_DEACTIVATED = """
‚ö†Ô∏è **–ü–æ–¥–ø–∏—Å–∫–∞ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞**

–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è.
–¢—Ä–µ–±–æ–≤–∞–ª–æ—Å—å: {subscription_fee} —Ç–æ–∫–µ–Ω–æ–≤
–ë–∞–ª–∞–Ω—Å: {balance} —Ç–æ–∫–µ–Ω–æ–≤

–ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏.
"""

# –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω
BALANCE_TOPPED_UP = """
‚úÖ **–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω!**

üí∞ –ó–∞—á–∏—Å–ª–µ–Ω–æ: {tokens_credited} —Ç–æ–∫–µ–Ω–æ–≤
{subscription_info}
üí≥ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {new_balance} —Ç–æ–∫–µ–Ω–æ–≤
"""
```

**DoD:**
- [ ] –í—Å–µ —Ç–µ–∫—Å—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å–æ–∑–¥–∞–Ω—ã
- [ ] Placeholders –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

### T11.6.2 ‚Äî Update notification service

**–û–ø–∏—Å–∞–Ω–∏–µ:** –û–±–Ω–æ–≤–∏—Ç—å NotificationService –¥–ª—è –Ω–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.

**–§–∞–π–ª:** `backend/src/services/notification_service.py`

**–ö–æ–¥:**
```python
from aiogram import Bot
from src.bot.messages.notifications import (
    SUBSCRIPTION_EXPIRING_SOON,
    ACTION_ENOUGH_BALANCE,
    ACTION_LOW_BALANCE,
    SUBSCRIPTION_RENEWED,
    SUBSCRIPTION_DEACTIVATED,
)

class NotificationService:
    def __init__(self, bot: Bot):
        self.bot = bot

    async def notify_subscription_expiring(
        self,
        telegram_id: int,
        days: int,
        balance: int,
        subscription_fee: int
    ):
        """–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏."""
        enough_balance = balance >= subscription_fee
        action_text = ACTION_ENOUGH_BALANCE if enough_balance else ACTION_LOW_BALANCE

        text = SUBSCRIPTION_EXPIRING_SOON.format(
            days=days,
            balance=balance,
            subscription_fee=subscription_fee,
            action_text=action_text
        )

        await self.bot.send_message(
            chat_id=telegram_id,
            text=text,
            parse_mode="Markdown"
        )

    async def notify_subscription_renewed(
        self,
        telegram_id: int,
        subscription_end: str,
        subscription_fee: int,
        balance: int
    ):
        """–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –ø—Ä–æ–¥–ª–µ–Ω–∏–∏."""
        text = SUBSCRIPTION_RENEWED.format(
            subscription_end=subscription_end,
            subscription_fee=subscription_fee,
            balance=balance
        )

        await self.bot.send_message(
            chat_id=telegram_id,
            text=text,
            parse_mode="Markdown"
        )

    async def notify_subscription_deactivated(
        self,
        telegram_id: int,
        subscription_fee: int,
        balance: int
    ):
        """–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏."""
        text = SUBSCRIPTION_DEACTIVATED.format(
            subscription_fee=subscription_fee,
            balance=balance
        )

        await self.bot.send_message(
            chat_id=telegram_id,
            text=text,
            parse_mode="Markdown"
        )
```

**DoD:**
- [ ] –ú–µ—Ç–æ–¥ notify_subscription_expiring
- [ ] –ú–µ—Ç–æ–¥ notify_subscription_renewed
- [ ] –ú–µ—Ç–æ–¥ notify_subscription_deactivated
- [ ] –í—Å–µ –º–µ—Ç–æ–¥—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ –±–æ—Ç

---

### T11.6.3 ‚Äî Configure notification days

**–û–ø–∏—Å–∞–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–Ω–µ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

**–§–∞–π–ª:** `backend/src/core/config.py`

**–ö–æ–¥:**
```python
class Settings(BaseSettings):
    # ... existing settings ...

    # Subscription notifications
    SUBSCRIPTION_NOTIFY_DAYS: list[int] = [3, 1]  # –∑–∞ 3 –¥–Ω—è –∏ –∑–∞ 1 –¥–µ–Ω—å
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ tasks:**
```python
from src.core.config import settings

for days in settings.SUBSCRIPTION_NOTIFY_DAYS:
    # –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏—Å—Ç–µ—á–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ N –¥–Ω–µ–π
    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
```

**DoD:**
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SUBSCRIPTION_NOTIFY_DAYS –¥–æ–±–∞–≤–ª–µ–Ω–∞
- [ ] Default value: [3, 1]
- [ ] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ subscription_tasks
