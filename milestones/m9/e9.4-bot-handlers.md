# E9.4 ‚Äî Bot Handlers

## –û–ø–∏—Å–∞–Ω–∏–µ

–ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–æ–π.

---

## Tasks

### T9.4.1 ‚Äî Subscription handler

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å handler –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /subscription.

**–§–∞–π–ª:** `backend/src/bot/handlers/subscription.py`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
from aiogram import Router, F
from aiogram.filters import Command
from aiogram.types import Message, CallbackQuery
from datetime import datetime

from sqlalchemy.ext.asyncio import AsyncSession

from db.models.user import User
from services.subscription_service import SubscriptionService
from bot.keyboards.subscription import (
    get_subscription_keyboard,
    get_renewal_settings_keyboard,
)

router = Router()

@router.message(Command("subscription"))
async def cmd_subscription(
    message: Message,
    user: User,
    session: AsyncSession,
) -> None:
    """Show detailed subscription information"""
    service = SubscriptionService(session)

    status = await service.check_subscription_status(user.id)

    text = format_subscription_message(user, status)
    keyboard = get_subscription_keyboard(status, user.auto_renew_enabled)

    await message.answer(text, reply_markup=keyboard)

def format_subscription_message(user: User, status: dict) -> str:
    """Format subscription details"""
    lines = ["üìÖ <b>–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞</b>\n"]

    # Status indicator
    status_icons = {
        "active": "üü¢",
        "expiring_soon": "üü°",
        "expiring_today": "üî¥",
        "expired": "‚ùå",
        "none": "‚ö™",
    }

    icon = status_icons.get(status["status"], "‚ö™")
    lines.append(f"{icon} –°—Ç–∞—Ç—É—Å: <b>{status['message']}</b>")

    if status["active"]:
        lines.append(f"üìÜ –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: {status['expires_at'].strftime('%d.%m.%Y %H:%M')}")
        lines.append(f"‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: {status['days_left']} –¥–Ω–µ–π")

        if status["status"] in ["expiring_soon", "expiring_today"]:
            lines.append("\n‚ö†Ô∏è <i>–°–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞–µ—Ç! –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø—Ä–æ–¥–ª–∏—Ç—å.</i>")
    else:
        if status.get("expired_at"):
            lines.append(f"‚ùå –ò—Å—Ç–µ–∫–ª–∞: {status['expired_at'].strftime('%d.%m.%Y')}")

    # Auto-renewal status
    lines.append("")
    if user.auto_renew_enabled:
        lines.append("üîÑ –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ: <b>–≤–∫–ª—é—á–µ–Ω–æ</b>")
        lines.append(f"üí∞ –ë–∞–ª–∞–Ω—Å: {user.token_balance} —Ç–æ–∫–µ–Ω–æ–≤")
    else:
        lines.append("üîÑ –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ: <b>–≤—ã–∫–ª—é—á–µ–Ω–æ</b>")

    # Actions hint
    lines.append("")
    if not status["active"]:
        lines.append("üí≥ –û—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É: /tariffs")
    elif status["status"] in ["expiring_soon", "expiring_today"]:
        lines.append("üí≥ –ü—Ä–æ–¥–ª–∏—Ç—å —Å–µ–π—á–∞—Å: /tariffs")

    return "\n".join(lines)

@router.callback_query(F.data == "toggle_auto_renew")
async def toggle_auto_renewal(
    callback: CallbackQuery,
    user: User,
    session: AsyncSession,
) -> None:
    """Toggle auto-renewal setting"""
    service = SubscriptionService(session)

    new_value = not user.auto_renew_enabled
    await service.set_auto_renewal(user.id, enabled=new_value)

    if new_value:
        text = (
            "‚úÖ –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ <b>–≤–∫–ª—é—á–µ–Ω–æ</b>\n\n"
            "–ü–æ–¥–ø–∏—Å–∫–∞ –±—É–¥–µ—Ç –ø—Ä–æ–¥–ª–µ–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤."
        )
    else:
        text = (
            "‚ùå –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ <b>–≤—ã–∫–ª—é—á–µ–Ω–æ</b>\n\n"
            "–í–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø—Ä–æ–¥–ª–µ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤—Ä—É—á–Ω—É—é."
        )

    await callback.message.edit_text(text)
    await callback.answer("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")

@router.callback_query(F.data == "subscription_settings")
async def show_subscription_settings(
    callback: CallbackQuery,
    user: User,
    session: AsyncSession,
) -> None:
    """Show subscription settings"""
    service = SubscriptionService(session)

    text = format_subscription_settings(user)
    keyboard = get_renewal_settings_keyboard(user.auto_renew_enabled)

    await callback.message.edit_text(text, reply_markup=keyboard)
    await callback.answer()

def format_subscription_settings(user: User) -> str:
    """Format subscription settings"""
    lines = ["‚öôÔ∏è <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏</b>\n"]

    lines.append(f"üîÑ –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ: {'–í–∫–ª' if user.auto_renew_enabled else '–í—ã–∫–ª'}")

    if user.auto_renew_enabled:
        lines.append("")
        lines.append("‚ÑπÔ∏è –ü—Ä–∏ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–∏ —Å –±–∞–ª–∞–Ω—Å–∞ —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Ç–æ–∫–µ–Ω—ã")
        lines.append(f"üí∞ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {user.token_balance} —Ç–æ–∫–µ–Ω–æ–≤")

    return "\n".join(lines)
```

**DoD:**
- [ ] /subscription –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏
- [ ] –°—Ç–∞—Ç—É—Å —Å —Ü–≤–µ—Ç–æ–≤—ã–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º
- [ ] –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–∏
- [ ] toggle_auto_renew —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### T9.4.2 ‚Äî Subscription keyboards

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–æ–π.

**–§–∞–π–ª:** `backend/src/bot/keyboards/subscription.py`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
from aiogram.types import InlineKeyboardMarkup
from aiogram.utils.keyboard import InlineKeyboardBuilder

def get_subscription_keyboard(
    status: dict,
    auto_renew_enabled: bool,
) -> InlineKeyboardMarkup:
    """Keyboard for subscription view"""
    builder = InlineKeyboardBuilder()

    # Extend/buy subscription
    if not status["active"]:
        builder.button(text="üí≥ –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", callback_data="show_tariffs")
    elif status["status"] in ["expiring_soon", "expiring_today"]:
        builder.button(text="üí≥ –ü—Ä–æ–¥–ª–∏—Ç—å —Å–µ–π—á–∞—Å", callback_data="show_tariffs")

    # Settings
    builder.button(text="‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", callback_data="subscription_settings")

    # Quick toggle
    if auto_renew_enabled:
        builder.button(text="üîÑ –í—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ", callback_data="toggle_auto_renew")
    else:
        builder.button(text="üîÑ –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ", callback_data="toggle_auto_renew")

    # Back
    builder.button(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="show_profile")

    builder.adjust(1)
    return builder.as_markup()

def get_renewal_settings_keyboard(
    auto_renew_enabled: bool,
) -> InlineKeyboardMarkup:
    """Keyboard for renewal settings"""
    builder = InlineKeyboardBuilder()

    if auto_renew_enabled:
        builder.button(
            text="‚ùå –í—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ",
            callback_data="toggle_auto_renew",
        )
    else:
        builder.button(
            text="‚úÖ –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ",
            callback_data="toggle_auto_renew",
        )

    # Select tariff for renewal (optional)
    builder.button(
        text="üì¶ –í—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è",
        callback_data="select_renewal_tariff",
    )

    builder.button(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ –ø–æ–¥–ø–∏—Å–∫–µ", callback_data="show_subscription")

    builder.adjust(1)
    return builder.as_markup()

def get_expiring_notification_keyboard() -> InlineKeyboardMarkup:
    """Keyboard for expiring subscription notification"""
    builder = InlineKeyboardBuilder()

    builder.button(text="üí≥ –ü—Ä–æ–¥–ª–∏—Ç—å —Å–µ–π—á–∞—Å", callback_data="show_tariffs")
    builder.button(text="üîï –ù–µ –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å", callback_data="mute_expiry_notifications")

    builder.adjust(1)
    return builder.as_markup()
```

**DoD:**
- [ ] get_subscription_keyboard —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏
- [ ] get_renewal_settings_keyboard
- [ ] get_expiring_notification_keyboard
- [ ] –ö–Ω–æ–ø–∫–∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
