# M9: Subscription Management

## Обзор

Реализовать управление подписками: автопродление, уведомления об истечении, grace period. Полный lifecycle подписки.

---

## Epics & Tasks

| Epic | Задачи | Оценка |
|------|--------|--------|
| [E9.1 — Subscription Service](e9.1-subscription-service.md) | Сервис управления подписками | 3 tasks |
| [E9.2 — Scheduled Tasks](e9.2-scheduled-tasks.md) | Планировщик задач | 3 tasks |
| [E9.3 — Notifications](e9.3-notifications.md) | Уведомления о подписке | 2 tasks |
| [E9.4 — Bot Handlers](e9.4-bot-handlers.md) | Команда /subscription | 2 tasks |

---

## Definition of Done

- [ ] Cron-задача находит подписки, истекающие в ближайшие N дней
- [ ] Уведомления отправляются за 3 дня и за 1 день до истечения
- [ ] Автопродление списывает токены и продлевает подписку
- [ ] При недостатке токенов автопродление не происходит, отправляется уведомление
- [ ] После истечения подписки пользователь не может тратить токены
- [ ] Транзакция типа `subscription` создаётся при автопродлении
- [ ] Graceful handling при ошибках (не блокирует обработку других пользователей)
- [ ] Логирование всех операций
- [ ] Unit-тесты для subscription_service

---

## Зависимости

- M8: Token Spending

## Разблокирует

- M10: Docker & Deploy
