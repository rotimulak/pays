# E9.3 ‚Äî Notifications

## –û–ø–∏—Å–∞–Ω–∏–µ

–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏.

---

## Tasks

### T9.3.1 ‚Äî Subscription notifications

**–û–ø–∏—Å–∞–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–µ.

**–§–∞–π–ª:** `backend/src/services/notification_service.py` (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)

**–î–æ–±–∞–≤–ª–µ–Ω–∏—è:**
```python
class NotificationService:
    # ... existing methods ...

    async def notify_subscription_expiring(
        self,
        user_id: int,
        days_left: int,
    ) -> bool:
        """
        Send subscription expiring warning.

        Args:
            user_id: Telegram user ID
            days_left: Days until subscription expires

        Returns:
            True if sent successfully
        """
        if days_left == 0:
            message = (
                "‚ö†Ô∏è <b>–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç —Å–µ–≥–æ–¥–Ω—è!</b>\n\n"
                "–ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –≤—ã –Ω–µ —Å–º–æ–∂–µ—Ç–µ "
                "–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å.\n\n"
                "–ü—Ä–æ–¥–ª–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –¥–æ—Å—Ç—É–ø.\n\n"
                "üí≥ –ü—Ä–æ–¥–ª–∏—Ç—å: /tariffs"
            )
        elif days_left == 1:
            message = (
                "‚ö†Ô∏è <b>–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç –∑–∞–≤—Ç—Ä–∞!</b>\n\n"
                "–ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É.\n\n"
                "üí≥ –ü—Ä–æ–¥–ª–∏—Ç—å: /tariffs"
            )
        else:
            message = (
                f"üìÖ –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ <b>{days_left} –¥–Ω–µ–π</b>.\n\n"
                "–ü—Ä–æ–¥–ª–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –∑–∞—Ä–∞–Ω–µ–µ, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É.\n\n"
                "üí≥ –ü—Ä–æ–¥–ª–∏—Ç—å: /tariffs"
            )

        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üí≥ –ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", callback_data="show_tariffs")],
            [InlineKeyboardButton(text="üìä –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å", callback_data="show_profile")],
        ])

        return await self._send_message(user_id, message, keyboard)

    async def notify_subscription_expired(
        self,
        user_id: int,
    ) -> bool:
        """Send notification when subscription has expired"""
        message = (
            "‚ùå <b>–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞</b>\n\n"
            "–í—ã –±–æ–ª—å—à–µ –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å.\n\n"
            "–û—Ñ–æ—Ä–º–∏—Ç–µ –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É.\n\n"
            "üí≥ –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É: /tariffs"
        )

        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üí≥ –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", callback_data="show_tariffs")],
        ])

        return await self._send_message(user_id, message, keyboard)

    async def notify_renewal_success(
        self,
        user_id: int,
        new_end: datetime,
        tokens_spent: int,
    ) -> bool:
        """Send notification about successful auto-renewal"""
        message = (
            "‚úÖ <b>–ü–æ–¥–ø–∏—Å–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–ª–µ–Ω–∞!</b>\n\n"
            f"üìÖ –ê–∫—Ç–∏–≤–Ω–∞ –¥–æ: {new_end.strftime('%d.%m.%Y')}\n"
            f"üí∞ –°–ø–∏—Å–∞–Ω–æ: {tokens_spent} —Ç–æ–∫–µ–Ω–æ–≤\n\n"
            "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –æ—Å—Ç–∞—ë—Ç–µ—Å—å —Å –Ω–∞–º–∏! üôè"
        )

        return await self._send_message(user_id, message)

    async def notify_renewal_failed(
        self,
        user_id: int,
        reason: str,
        required: int | None = None,
        available: int | None = None,
    ) -> bool:
        """Send notification about failed auto-renewal"""
        if reason == "insufficient_balance":
            message = (
                "‚ö†Ô∏è <b>–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</b>\n\n"
                f"–î–ª—è –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è –Ω—É–∂–Ω–æ: {required} —Ç–æ–∫–µ–Ω–æ–≤\n"
                f"–ù–∞ –±–∞–ª–∞–Ω—Å–µ: {available} —Ç–æ–∫–µ–Ω–æ–≤\n\n"
                "–ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å, —á—Ç–æ–±—ã –ø—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É.\n\n"
                "üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å: /tariffs"
            )
        else:
            message = (
                "‚ö†Ô∏è <b>–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</b>\n\n"
                f"–ü—Ä–∏—á–∏–Ω–∞: {reason}\n\n"
                "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤—Ä—É—á–Ω—É—é.\n\n"
                "üí≥ –ü—Ä–æ–¥–ª–∏—Ç—å: /tariffs"
            )

        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å", callback_data="show_tariffs")],
        ])

        return await self._send_message(user_id, message, keyboard)
```

**DoD:**
- [ ] notify_subscription_expiring —Å —Ä–∞–∑–Ω—ã–º–∏ –¥–Ω—è–º–∏
- [ ] notify_subscription_expired
- [ ] notify_renewal_success
- [ ] notify_renewal_failed —Å –ø—Ä–∏—á–∏–Ω–æ–π
- [ ] Keyboards —Å –¥–µ–π—Å—Ç–≤–∏—è–º–∏

---

### T9.3.2 ‚Äî Notification tracking

**–û–ø–∏—Å–∞–Ω–∏–µ:** –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

**–ù–æ–≤–∞—è –º–æ–¥–µ–ª—å:**
```python
# db/models/notification.py
from uuid import UUID
from datetime import datetime
from sqlalchemy.orm import Mapped, mapped_column
from sqlalchemy import String, BigInteger, Boolean, ForeignKey

from db.session import Base

class NotificationLog(Base):
    """Log of sent notifications"""
    __tablename__ = "notification_logs"

    id: Mapped[UUID] = mapped_column(primary_key=True)
    user_id: Mapped[int] = mapped_column(BigInteger, index=True)
    type: Mapped[str] = mapped_column(String(50), index=True)
    # Types: subscription_expiring_3d, subscription_expiring_1d,
    #        subscription_expired, renewal_success, renewal_failed,
    #        low_balance, payment_success

    sent_at: Mapped[datetime] = mapped_column(default=datetime.utcnow)
    success: Mapped[bool] = mapped_column(default=True)
    error: Mapped[str | None] = mapped_column(String(500), nullable=True)

    # Reference to related entity (invoice_id, etc.)
    reference_id: Mapped[str | None] = mapped_column(String(255), nullable=True)
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ NotificationService:**
```python
class NotificationService:
    def __init__(self, bot: Bot, session: AsyncSession | None = None):
        self.bot = bot
        self.session = session

    async def _log_notification(
        self,
        user_id: int,
        type: str,
        success: bool,
        error: str | None = None,
        reference_id: str | None = None,
    ) -> None:
        """Log sent notification"""
        if not self.session:
            return

        log = NotificationLog(
            id=uuid4(),
            user_id=user_id,
            type=type,
            success=success,
            error=error,
            reference_id=reference_id,
        )
        self.session.add(log)

    async def was_notification_sent(
        self,
        user_id: int,
        type: str,
        since: datetime,
    ) -> bool:
        """Check if notification was already sent"""
        if not self.session:
            return False

        result = await self.session.execute(
            select(NotificationLog)
            .where(NotificationLog.user_id == user_id)
            .where(NotificationLog.type == type)
            .where(NotificationLog.sent_at >= since)
            .where(NotificationLog.success == True)
            .limit(1)
        )
        return result.scalar_one_or_none() is not None

    async def notify_subscription_expiring(
        self,
        user_id: int,
        days_left: int,
    ) -> bool:
        # Check if already notified today
        today = datetime.utcnow().replace(hour=0, minute=0, second=0, microsecond=0)
        notification_type = f"subscription_expiring_{days_left}d"

        if await self.was_notification_sent(user_id, notification_type, today):
            return False  # Already sent

        # ... send message ...

        success = await self._send_message(user_id, message, keyboard)

        await self._log_notification(
            user_id=user_id,
            type=notification_type,
            success=success,
        )

        return success
```

**DoD:**
- [ ] NotificationLog –º–æ–¥–µ–ª—å
- [ ] _log_notification –¥–ª—è –∑–∞–ø–∏—Å–∏
- [ ] was_notification_sent –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
- [ ] –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã
