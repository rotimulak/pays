# E1.3 — SQLAlchemy Models

## Описание

Создание SQLAlchemy моделей для всех сущностей проекта.

---

## Tasks

### T1.3.1 — User model

**Описание:** Создать модель пользователя.

**Файл:** `backend/src/db/models/user.py`

**Поля:**
| Поле | Тип | Описание |
|------|-----|----------|
| `id` | BIGINT, PK | Telegram user_id |
| `username` | VARCHAR(255), nullable | Telegram username |
| `first_name` | VARCHAR(255), nullable | Имя |
| `last_name` | VARCHAR(255), nullable | Фамилия |
| `token_balance` | INTEGER, default 0 | Баланс токенов |
| `balance_version` | INTEGER, default 0 | Версия для optimistic lock |
| `subscription_end` | TIMESTAMP, nullable | Окончание подписки |
| `is_blocked` | BOOLEAN, default false | Заблокирован |
| `created_at` | TIMESTAMP | Создан |
| `updated_at` | TIMESTAMP | Обновлён |

**Constraints:**
- CHECK: `token_balance >= 0`

**DoD:**
- [ ] Модель создана со всеми полями
- [ ] CHECK constraint добавлен
- [ ] Timestamps автоматически обновляются

---

### T1.3.2 — Tariff model

**Описание:** Создать модель тарифа.

**Файл:** `backend/src/db/models/tariff.py`

**Поля:**
| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID, PK | Идентификатор |
| `slug` | VARCHAR(50), unique | URL-friendly имя |
| `name` | VARCHAR(100) | Название |
| `description` | TEXT, nullable | Описание |
| `price` | DECIMAL(10,2) | Цена в рублях |
| `tokens` | INTEGER | Кол-во токенов |
| `subscription_days` | INTEGER, default 0 | Дней подписки |
| `sort_order` | INTEGER, default 0 | Порядок сортировки |
| `is_active` | BOOLEAN, default true | Активен |
| `version` | INTEGER, default 1 | Версия тарифа |
| `created_at` | TIMESTAMP | Создан |
| `updated_at` | TIMESTAMP | Обновлён |

**Constraints:**
- CHECK: `price > 0`
- CHECK: `tokens >= 0`
- CHECK: `subscription_days >= 0`

**DoD:**
- [ ] Модель создана со всеми полями
- [ ] Все CHECK constraints добавлены
- [ ] Unique constraint на slug

---

### T1.3.3 — Invoice model

**Описание:** Создать модель счёта на оплату.

**Файл:** `backend/src/db/models/invoice.py`

**Поля:**
| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID, PK | Идентификатор |
| `inv_id` | BIGINT, unique | ID для Robokassa |
| `user_id` | BIGINT, FK | Пользователь |
| `tariff_id` | UUID, FK | Тариф |
| `promo_code_id` | UUID, FK, nullable | Промокод |
| `amount` | DECIMAL(10,2) | Сумма к оплате |
| `original_amount` | DECIMAL(10,2) | Сумма до скидки |
| `tokens` | INTEGER | Токенов к начислению |
| `subscription_days` | INTEGER | Дней подписки |
| `status` | ENUM | pending, paid, expired, cancelled, refunded |
| `idempotency_key` | VARCHAR(255), unique | Ключ идемпотентности |
| `payment_url` | TEXT, nullable | URL оплаты |
| `paid_at` | TIMESTAMP, nullable | Время оплаты |
| `expires_at` | TIMESTAMP | Время истечения |
| `created_at` | TIMESTAMP | Создан |
| `updated_at` | TIMESTAMP | Обновлён |

**Constraints:**
- CHECK: `amount > 0`
- FK: `user_id` → `users.id`
- FK: `tariff_id` → `tariffs.id`
- FK: `promo_code_id` → `promo_codes.id`

**Индексы:**
- `idx_invoices_user_id`
- `idx_invoices_status`
- `idx_invoices_idempotency_key`
- `idx_invoices_inv_id`

**DoD:**
- [ ] Модель создана со всеми полями
- [ ] ENUM для статуса создан
- [ ] Все FK и индексы добавлены

---

### T1.3.4 — Transaction model

**Описание:** Создать модель транзакции токенов.

**Файл:** `backend/src/db/models/transaction.py`

**Поля:**
| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID, PK | Идентификатор |
| `user_id` | BIGINT, FK | Пользователь |
| `type` | ENUM | topup, spend, refund, adjustment |
| `tokens_delta` | INTEGER | Изменение (+/-) |
| `balance_after` | INTEGER | Баланс после |
| `description` | TEXT, nullable | Описание |
| `invoice_id` | UUID, FK, nullable | Связанный invoice |
| `metadata` | JSONB, nullable | Доп. данные |
| `created_at` | TIMESTAMP | Создан |

**Индексы:**
- `idx_transactions_user_id`
- `idx_transactions_created_at`
- `idx_transactions_type`

**DoD:**
- [ ] Модель создана со всеми полями
- [ ] ENUM для типа создан
- [ ] Все индексы добавлены

---

### T1.3.5 — PromoCode model

**Описание:** Создать модель промокода.

**Файл:** `backend/src/db/models/promo_code.py`

**Поля:**
| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID, PK | Идентификатор |
| `code` | VARCHAR(50), unique | Код промокода |
| `discount_type` | ENUM | percent, fixed |
| `discount_value` | DECIMAL(10,2) | Размер скидки |
| `max_uses` | INTEGER, nullable | Макс. использований |
| `uses_count` | INTEGER, default 0 | Текущее кол-во |
| `valid_from` | TIMESTAMP | Начало действия |
| `valid_until` | TIMESTAMP, nullable | Конец действия |
| `tariff_id` | UUID, FK, nullable | Ограничение на тариф |
| `is_active` | BOOLEAN, default true | Активен |
| `created_at` | TIMESTAMP | Создан |
| `updated_at` | TIMESTAMP | Обновлён |

**Constraints:**
- CHECK: `discount_value > 0`
- CHECK: `uses_count >= 0`
- CHECK: `max_uses IS NULL OR max_uses > 0`

**DoD:**
- [ ] Модель создана со всеми полями
- [ ] ENUM для типа скидки создан
- [ ] Все constraints добавлены

---

### T1.3.6 — AuditLog model

**Описание:** Создать модель аудит-лога.

**Файл:** `backend/src/db/models/audit_log.py`

**Поля:**
| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID, PK | Идентификатор |
| `user_id` | BIGINT, nullable | Пользователь (если применимо) |
| `action` | VARCHAR(100) | Действие |
| `entity_type` | VARCHAR(50) | Тип сущности |
| `entity_id` | VARCHAR(255), nullable | ID сущности |
| `old_value` | JSONB, nullable | Старое значение |
| `new_value` | JSONB, nullable | Новое значение |
| `metadata` | JSONB, nullable | Доп. данные |
| `created_at` | TIMESTAMP | Создан |

**Индексы:**
- `idx_audit_log_user_id`
- `idx_audit_log_action`
- `idx_audit_log_created_at`

**DoD:**
- [ ] Модель создана со всеми полями
- [ ] Все индексы добавлены
- [ ] Модель не имеет FK (независимая таблица)
