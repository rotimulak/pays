# E1.4 — Migrations

## Описание

Создание начальной миграции со всеми таблицами, constraints и индексами.

---

## Tasks

### T1.4.1 — Generate initial migration

**Описание:** Сгенерировать начальную миграцию со всеми таблицами.

**Файл:** `backend/migrations/versions/001_initial.py`

**Таблицы:**
- `users`
- `tariffs`
- `invoices`
- `transactions`
- `promo_codes`
- `audit_logs`

**ENUM типы:**
- `invoice_status` (pending, paid, expired, cancelled, refunded)
- `transaction_type` (topup, spend, refund, adjustment)
- `discount_type` (percent, fixed)

**DoD:**
- [ ] Миграция сгенерирована через `alembic revision --autogenerate`
- [ ] Все таблицы создаются
- [ ] Все ENUM типы создаются
- [ ] `alembic upgrade head` работает без ошибок

---

### T1.4.2 — Add CHECK constraints

**Описание:** Добавить CHECK constraints для валидации данных на уровне БД.

**Constraints:**
| Таблица | Constraint | Правило |
|---------|------------|---------|
| `users` | `chk_users_token_balance` | `token_balance >= 0` |
| `tariffs` | `chk_tariffs_price` | `price > 0` |
| `tariffs` | `chk_tariffs_tokens` | `tokens >= 0` |
| `tariffs` | `chk_tariffs_subscription_days` | `subscription_days >= 0` |
| `invoices` | `chk_invoices_amount` | `amount > 0` |
| `promo_codes` | `chk_promo_codes_discount_value` | `discount_value > 0` |
| `promo_codes` | `chk_promo_codes_uses_count` | `uses_count >= 0` |
| `promo_codes` | `chk_promo_codes_max_uses` | `max_uses IS NULL OR max_uses > 0` |

**DoD:**
- [ ] Все CHECK constraints добавлены в миграцию
- [ ] Constraints именованы согласно naming convention
- [ ] Попытка вставить невалидные данные вызывает ошибку

---

### T1.4.3 — Add indexes

**Описание:** Добавить индексы для оптимизации запросов.

**Индексы:**
| Таблица | Индекс | Поля |
|---------|--------|------|
| `invoices` | `idx_invoices_user_id` | `user_id` |
| `invoices` | `idx_invoices_status` | `status` |
| `invoices` | `idx_invoices_idempotency_key` | `idempotency_key` |
| `invoices` | `idx_invoices_inv_id` | `inv_id` |
| `invoices` | `idx_invoices_expires_at` | `expires_at` WHERE `status = 'pending'` |
| `transactions` | `idx_transactions_user_id` | `user_id` |
| `transactions` | `idx_transactions_created_at` | `created_at` |
| `transactions` | `idx_transactions_type` | `type` |
| `audit_logs` | `idx_audit_log_user_id` | `user_id` |
| `audit_logs` | `idx_audit_log_action` | `action` |
| `audit_logs` | `idx_audit_log_created_at` | `created_at` |
| `tariffs` | `idx_tariffs_is_active` | `is_active` WHERE `is_active = true` |

**DoD:**
- [ ] Все индексы добавлены
- [ ] Partial indexes используются где уместно
- [ ] EXPLAIN показывает использование индексов
