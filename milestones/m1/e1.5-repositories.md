# E1.5 — Repositories

## Описание

Создание базовых репозиториев для работы с User и Tariff моделями.

---

## Tasks

### T1.5.1 — User repository

**Описание:** Создать репозиторий для работы с пользователями.

**Файл:** `backend/src/db/repositories/user_repository.py`

**Методы:**
```python
class UserRepository:
    async def get_by_id(self, user_id: int) -> User | None:
        """Get user by Telegram ID"""

    async def get_or_create(
        self,
        user_id: int,
        username: str | None = None,
        first_name: str | None = None,
        last_name: str | None = None
    ) -> tuple[User, bool]:
        """Get existing or create new user. Returns (user, created)"""

    async def update_balance(
        self,
        user_id: int,
        delta: int,
        expected_version: int
    ) -> User:
        """Update token balance with optimistic locking"""

    async def update_subscription(
        self,
        user_id: int,
        end_date: datetime
    ) -> User:
        """Update subscription end date"""

    async def update(self, user: User) -> User:
        """Update user fields"""
```

**DoD:**
- [ ] Все методы реализованы
- [ ] Optimistic locking работает для баланса
- [ ] `get_or_create` использует ON CONFLICT
- [ ] Unit-тесты для всех методов

---

### T1.5.2 — Tariff repository

**Описание:** Создать репозиторий для работы с тарифами.

**Файл:** `backend/src/db/repositories/tariff_repository.py`

**Методы:**
```python
class TariffRepository:
    async def get_by_id(self, tariff_id: UUID) -> Tariff | None:
        """Get tariff by ID"""

    async def get_by_slug(self, slug: str) -> Tariff | None:
        """Get tariff by slug"""

    async def get_active(self) -> list[Tariff]:
        """Get all active tariffs sorted by sort_order"""

    async def create(self, tariff: Tariff) -> Tariff:
        """Create new tariff"""

    async def update(self, tariff: Tariff) -> Tariff:
        """Update tariff"""

    async def deactivate(self, tariff_id: UUID) -> Tariff:
        """Set is_active=False"""
```

**DoD:**
- [ ] Все методы реализованы
- [ ] `get_active` сортирует по `sort_order`
- [ ] Soft delete через `is_active`
- [ ] Unit-тесты для всех методов
