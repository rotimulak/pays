# E2.4 ‚Äî Keyboards & Entry Point

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä –∏ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞.

---

## Tasks

### T2.4.1 ‚Äî Main menu keyboard

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (Reply keyboard).

**–§–∞–π–ª:** `backend/src/bot/keyboards/main_menu.py`

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
```python
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton

def get_main_menu() -> ReplyKeyboardMarkup:
    """
    Create main menu reply keyboard.

    Layout:
    [üí∞ –¢–∞—Ä–∏—Ñ—ã] [üë§ –ü—Ä–æ—Ñ–∏–ª—å]
    [üìú –ò—Å—Ç–æ—Ä–∏—è] [‚ùì –ü–æ–º–æ—â—å]
    """
    return ReplyKeyboardMarkup(
        keyboard=[
            [
                KeyboardButton(text="üí∞ –¢–∞—Ä–∏—Ñ—ã"),
                KeyboardButton(text="üë§ –ü—Ä–æ—Ñ–∏–ª—å"),
            ],
            [
                KeyboardButton(text="üìú –ò—Å—Ç–æ—Ä–∏—è"),
                KeyboardButton(text="‚ùì –ü–æ–º–æ—â—å"),
            ],
        ],
        resize_keyboard=True,
    )
```

**Text handlers:**
```python
# –í —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö handlers –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–æ–∫
@router.message(F.text == "üí∞ –¢–∞—Ä–∏—Ñ—ã")
async def btn_tariffs(message: Message):
    # redirect to /tariffs handler

@router.message(F.text == "üë§ –ü—Ä–æ—Ñ–∏–ª—å")
async def btn_profile(message: Message):
    # redirect to /profile handler
```

**DoD:**
- [ ] Reply keyboard —Å–æ–∑–¥–∞–Ω–∞
- [ ] –ö–Ω–æ–ø–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∫–æ–º–∞–Ω–¥–∞–º
- [ ] Text handlers –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –Ω–∞–∂–∞—Ç–∏—è
- [ ] `resize_keyboard=True` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

---

### T2.4.2 ‚Äî Entry point (main.py)

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞.

**–§–∞–π–ª:** `backend/src/main.py`

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
```python
import asyncio
import logging

from aiogram import Bot, Dispatcher
from aiogram.types import BotCommand

from core.config import settings
from bot import create_bot, create_dispatcher
from bot.handlers import start, profile, help
from bot.middlewares.db_session import DbSessionMiddleware
from bot.middlewares.auth import AuthMiddleware

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

async def set_commands(bot: Bot) -> None:
    """Set bot commands for menu"""
    commands = [
        BotCommand(command="start", description="–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É"),
        BotCommand(command="profile", description="–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å"),
        BotCommand(command="tariffs", description="–¢–∞—Ä–∏—Ñ—ã"),
        BotCommand(command="balance", description="–ë–∞–ª–∞–Ω—Å"),
        BotCommand(command="history", description="–ò—Å—Ç–æ—Ä–∏—è"),
        BotCommand(command="help", description="–ü–æ–º–æ—â—å"),
    ]
    await bot.set_my_commands(commands)

async def on_startup(bot: Bot) -> None:
    """Startup hook"""
    await set_commands(bot)
    logger.info("Bot started")

async def on_shutdown(bot: Bot) -> None:
    """Shutdown hook"""
    logger.info("Bot stopped")

async def main() -> None:
    """Entry point"""
    bot = create_bot(settings.TELEGRAM_BOT_TOKEN)
    dp = create_dispatcher()

    # Register middlewares
    dp.message.middleware(DbSessionMiddleware())
    dp.callback_query.middleware(DbSessionMiddleware())
    dp.message.middleware(AuthMiddleware())
    dp.callback_query.middleware(AuthMiddleware())

    # Register routers
    dp.include_router(start.router)
    dp.include_router(profile.router)
    dp.include_router(help.router)

    # Register hooks
    dp.startup.register(on_startup)
    dp.shutdown.register(on_shutdown)

    # Start polling
    try:
        await dp.start_polling(bot)
    finally:
        await bot.session.close()

if __name__ == "__main__":
    asyncio.run(main())
```

**Graceful shutdown:**
- –û–±—Ä–∞–±–æ—Ç–∫–∞ SIGINT/SIGTERM
- –ó–∞–∫—Ä—ã—Ç–∏–µ DB connections
- –ó–∞–∫—Ä—ã—Ç–∏–µ Bot session

**DoD:**
- [ ] main.py –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞
- [ ] –í—Å–µ handlers –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –í—Å–µ middlewares –ø–æ–¥–∫–ª—é—á–µ–Ω—ã
- [ ] Bot commands —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- [ ] Graceful shutdown —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
