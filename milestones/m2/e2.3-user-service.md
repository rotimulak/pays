# E2.3 — User Service

## Описание

Создание сервиса для работы с пользователями.

---

## Tasks

### T2.3.1 — User service implementation

**Описание:** Создать сервис для работы с пользователями.

**Файл:** `backend/src/services/user_service.py`

**Методы:**
```python
class UserService:
    def __init__(self, session: AsyncSession):
        self.session = session
        self.user_repo = UserRepository(session)

    async def get_or_create_user(
        self,
        telegram_id: int,
        username: str | None = None,
        first_name: str | None = None,
        last_name: str | None = None
    ) -> tuple[User, bool]:
        """
        Get existing user or create new one.
        Updates username/first_name/last_name if changed.
        Returns (user, created).
        """

    async def get_user(self, user_id: int) -> User | None:
        """Get user by Telegram ID"""

    async def get_user_profile(self, user_id: int) -> UserProfile:
        """
        Get user profile with formatted data.
        Returns UserProfile DTO with subscription_status.
        """
```

**DoD:**
- [ ] Все методы реализованы
- [ ] Обновляет username при изменении
- [ ] Возвращает tuple (user, created) для логирования
- [ ] Unit-тесты для всех методов

---

### T2.3.2 — User DTOs

**Описание:** Создать DTO для профиля пользователя.

**Файл:** `backend/src/services/dto/user.py`

**Классы:**
```python
from pydantic import BaseModel
from datetime import datetime
from enum import Enum

class SubscriptionStatus(str, Enum):
    ACTIVE = "active"
    INACTIVE = "inactive"
    EXPIRING_TODAY = "expiring_today"
    EXPIRED = "expired"

class UserProfile(BaseModel):
    """DTO for user profile display"""
    id: int
    username: str | None
    first_name: str | None
    last_name: str | None
    token_balance: int
    subscription_end: datetime | None
    subscription_status: SubscriptionStatus
    subscription_status_text: str  # "активна до 01.02.2024"

    @property
    def display_name(self) -> str:
        """Return first_name or 'Пользователь'"""
```

**DoD:**
- [ ] UserProfile DTO создан
- [ ] SubscriptionStatus enum создан
- [ ] Форматирование статуса подписки
- [ ] display_name property работает
