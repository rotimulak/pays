# E2.1 — Bot Foundation

## Описание

Создание базовой структуры Telegram-бота: инициализация Bot и Dispatcher, настройка middlewares.

---

## Tasks

### T2.1.1 — Bot initialization

**Описание:** Создать `bot/__init__.py` с инициализацией Bot и Dispatcher.

**Файл:** `backend/src/bot/__init__.py`

**Компоненты:**
```python
from aiogram import Bot, Dispatcher
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode

def create_bot(token: str) -> Bot:
    """Create Bot instance with default properties"""
    return Bot(
        token=token,
        default=DefaultBotProperties(parse_mode=ParseMode.HTML)
    )

def create_dispatcher() -> Dispatcher:
    """Create Dispatcher with middlewares and routers"""
```

**DoD:**
- [ ] Bot создаётся с HTML parse mode
- [ ] Dispatcher создаётся и настраивается
- [ ] Функции экспортируются из модуля

---

### T2.1.2 — Database session middleware

**Описание:** Создать middleware для передачи DB session в handlers.

**Файл:** `backend/src/bot/middlewares/db_session.py`

**Компоненты:**
```python
from aiogram import BaseMiddleware
from aiogram.types import TelegramObject

class DbSessionMiddleware(BaseMiddleware):
    async def __call__(
        self,
        handler: Callable,
        event: TelegramObject,
        data: dict
    ) -> Any:
        """
        1. Create async session
        2. Add to data["session"]
        3. Call handler
        4. Commit or rollback
        5. Close session
        """
```

**DoD:**
- [ ] Middleware создаёт сессию перед handler
- [ ] Session доступна через `data["session"]`
- [ ] При успехе — commit, при ошибке — rollback
- [ ] Session закрывается в finally

---

### T2.1.3 — Auth middleware

**Описание:** Создать middleware для автоматической регистрации пользователей.

**Файл:** `backend/src/bot/middlewares/auth.py`

**Компоненты:**
```python
class AuthMiddleware(BaseMiddleware):
    async def __call__(
        self,
        handler: Callable,
        event: Message | CallbackQuery,
        data: dict
    ) -> Any:
        """
        1. Extract user from event
        2. Get or create user in DB
        3. Add user to data["user"]
        4. Call handler
        """
```

**DoD:**
- [ ] Middleware извлекает user из Message или CallbackQuery
- [ ] Вызывает UserService.get_or_create
- [ ] User доступен через `data["user"]`
- [ ] Работает для Message и CallbackQuery
