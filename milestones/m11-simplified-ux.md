# M11: Simplified Payment UX

## Ğ¦ĞµĞ»ÑŒ

Ğ£Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¼ĞµĞ½Ñ Ğ±Ğ¾Ñ‚Ğ° Ğ´Ğ¾ 2 ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ¹, ÑƒĞ±Ñ€Ğ°Ñ‚ÑŒ ÑĞ²Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ¸Ğ½Ñ‚ÑƒĞ¸Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¼. Ğ¢Ğ°Ñ€Ğ¸Ñ„ Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ, Ğ½Ğ¾ ÑĞºÑ€Ñ‹Ñ‚ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ â€” Ğ¾Ğ½ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ.

---

## ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹

### Ğ‘Ñ‹Ğ»Ğ¾ (M3)
- `/tariffs` â€” ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ¾Ğ²
- `/pay` â€” Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ° â†’ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°
- ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ñ‚Ğ°Ñ€Ğ¸Ñ„

### Ğ¡Ñ‚Ğ°Ğ»Ğ¾ (M11)
- `/start` â†’ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ
- `[Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ]` â†’ ÑÑ‚Ğ°Ñ‚ÑƒÑ + Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ
- ĞĞ´Ğ¸Ğ½ ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¹ Ñ‚Ğ°Ñ€Ğ¸Ñ„, Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ°Ğ±Ğ¾Ğ½Ğ¿Ğ»Ğ°Ñ‚Ñ‹

---

## Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°

### ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹

| ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|----------|----------|
| ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶ | 200â‚½ |
| ĞĞ±Ğ¾Ğ½Ğ¿Ğ»Ğ°Ñ‚Ğ° | 100 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²/Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ |
| Ğ¢Ğ¾ĞºĞµĞ½Ñ‹ Ğ¿Ñ€Ğ¸ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ | (ÑÑƒĞ¼Ğ¼Ğ° - Ğ°Ğ±Ğ¾Ğ½Ğ¿Ğ»Ğ°Ñ‚Ğ°) Ğ¸Ğ»Ğ¸ Ğ²ÑÑ ÑÑƒĞ¼Ğ¼Ğ° |
| ĞŸĞµÑ€Ğ¸Ğ¾Ğ´ | 1 Ğ¼ĞµÑÑÑ† (Ğ½Ğ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼Ğ¾) |

### Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ·Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ñ

```
ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶ Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ¸ÑÑ‚ĞµĞºĞ»Ğ°:
â”œâ”€â”€ 200â‚½ â†’ 100 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² Ğ°Ğ±Ğ¾Ğ½Ğ¿Ğ»Ğ°Ñ‚Ğ° (ÑĞ¿Ğ¸ÑÑ‹Ğ²Ğ°ÑÑ‚ÑÑ ÑÑ€Ğ°Ğ·Ñƒ)
â”‚         â†’ 100 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² Ğ½Ğ° Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
â””â”€â”€ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ½Ğ° 1 Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´

ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶ (Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°):
â””â”€â”€ 200â‚½ â†’ 200 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² Ğ½Ğ° Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
           (Ğ°Ğ±Ğ¾Ğ½Ğ¿Ğ»Ğ°Ñ‚Ğ° ÑĞ¿Ğ¸ÑˆĞµÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ² Ğ´ĞµĞ½ÑŒ Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ¸Ñ)
```

### ĞĞ²Ñ‚Ğ¾Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ¸Ğµ

```
Ğ•Ğ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°:
â”œâ”€â”€ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ¸ÑÑ‚ĞµĞºĞ°ĞµÑ‚ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ?
â”‚   â”œâ”€â”€ Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ >= 100 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² â†’ ÑĞ¿Ğ¸ÑĞ°Ñ‚ÑŒ, Ğ¿Ñ€Ğ¾Ğ´Ğ»Ğ¸Ñ‚ÑŒ Ğ½Ğ° 1 Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´
â”‚   â””â”€â”€ Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ < 100 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² â†’ Ğ´ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ
â”‚
â””â”€â”€ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ¸ÑÑ‚ĞµĞºĞ°ĞµÑ‚ Ñ‡ĞµÑ€ĞµĞ· N Ğ´Ğ½ĞµĞ¹?
    â””â”€â”€ Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ·Ğ° 3 Ğ´Ğ½Ñ, Ğ·Ğ° 1 Ğ´ĞµĞ½ÑŒ)
```

---

## Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸

### 11.1 Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ² Ğ¼Ğ¾Ğ´ĞµĞ»ÑÑ…

- [ ] Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² `Tariff`:
  ```python
  class PeriodUnit(str, Enum):
      HOUR = "hour"      # Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
      DAY = "day"
      MONTH = "month"

  # ĞĞ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ
  period_unit: PeriodUnit = PeriodUnit.MONTH
  period_value: int = 1  # ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ĞµĞ´Ğ¸Ğ½Ğ¸Ñ†
  subscription_fee: int = 100  # Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² Ğ·Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´
  min_payment: Decimal = Decimal("200.00")  # Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶
  ```

- [ ] ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ: Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ, Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ seed Ñ‚Ğ°Ñ€Ğ¸Ñ„

### 11.2 ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ PaymentService

- [ ] `services/payment_service.py`:
  ```python
  async def process_payment(user_id: int, amount: Decimal) -> PaymentResult:
      """
      Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°:
      1. Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ½ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ° â€” ÑĞ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ°Ğ±Ğ¾Ğ½Ğ¿Ğ»Ğ°Ñ‚Ñƒ, Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
      2. ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº Ğ·Ğ°Ñ‡Ğ¸ÑĞ»Ğ¸Ñ‚ÑŒ Ğ½Ğ° Ğ±Ğ°Ğ»Ğ°Ğ½Ñ ĞºĞ°Ğº Ñ‚Ğ¾ĞºĞµĞ½Ñ‹
      """
  ```

- [ ] Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¼ĞµÑ‚Ğ¾Ğ´ `is_subscription_active(user_id) -> bool`
- [ ] Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¼ĞµÑ‚Ğ¾Ğ´ `activate_subscription(user_id, tariff) -> datetime`

### 11.3 Ğ£Ğ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¼ĞµĞ½Ñ Ğ±Ğ¾Ñ‚Ğ°

- [ ] Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ `bot/handlers/tariffs.py` (Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ°)
- [ ] Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ `/pay` Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ¾Ğ¼ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ°

- [ ] ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ `bot/handlers/start.py`:
  ```python
  # Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ
  keyboard = InlineKeyboardMarkup(inline_keyboard=[
      [InlineKeyboardButton(text="ğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ", callback_data="balance")],
      [InlineKeyboardButton(text="â“ ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ", callback_data="help")]
  ])
  ```

- [ ] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ `bot/handlers/balance.py`:
  ```python
  # Ğ­ĞºÑ€Ğ°Ğ½ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°
  - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ (Ñ‚Ğ¾ĞºĞµĞ½Ñ‹)
  - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ (Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ° Ğ´Ğ¾ / Ğ½ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°)
  - ĞĞ±ÑŠÑÑĞ½Ğ¸Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹
  - ĞšĞ½Ğ¾Ğ¿ĞºĞ¸: [ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ 200â‚½] [Ğ”Ñ€ÑƒĞ³Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ°] [Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ] [ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ Ğ¿Ğ¾ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ]
  ```

- [ ] ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ `bot/keyboards/` â€” Ğ½Ğ¾Ğ²Ñ‹Ğµ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñ‹

### 11.4 ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° "Ğ”Ñ€ÑƒĞ³Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ°"

- [ ] FSM ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ²Ğ²Ğ¾Ğ´Ğ° ÑÑƒĞ¼Ğ¼Ñ‹
- [ ] Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ: ÑÑƒĞ¼Ğ¼Ğ° >= min_payment (200â‚½)
- [ ] Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞµ ĞµÑĞ»Ğ¸ ÑÑƒĞ¼Ğ¼Ğ° < 200â‚½

### 11.5 Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞµ

- [ ] ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ `services/notification_service.py`:
  - Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ° 3 Ğ´Ğ½Ñ Ğ´Ğ¾ Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ñ
  - Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ° 1 Ğ´ĞµĞ½ÑŒ Ğ´Ğ¾ Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ñ
  - Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞµ ÑÑ€ĞµĞ´ÑÑ‚Ğ² Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ¸Ñ
  - Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ¼ Ğ°Ğ²Ñ‚Ğ¾Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ¸Ğ¸

### 11.6 Scheduler Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ

- [ ] ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ `tasks/subscription_tasks.py`:
  ```python
  async def process_subscription_renewals():
      """
      Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ¸ÑÑ‚ĞµĞºĞ°ÑÑ‰ĞµĞ¹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸:
      1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ >= subscription_fee
      2. Ğ•ÑĞ»Ğ¸ Ğ´Ğ°: ÑĞ¿Ğ¸ÑĞ°Ñ‚ÑŒ, Ğ¿Ñ€Ğ¾Ğ´Ğ»Ğ¸Ñ‚ÑŒ
      3. Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚: Ğ´ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ, ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ
      """
  ```

- [ ] ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° period_unit Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ° ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ¹ Ğ´Ğ°Ñ‚Ñ‹

### 11.7 Ğ¢ĞµĞºÑÑ‚Ñ‹ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹

- [ ] `bot/messages/balance.py`:
  ```python
  BALANCE_ACTIVE = """
  ğŸ“Š Ğ’Ğ°Ñˆ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ

  ğŸ’³ Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: {balance} Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²
  ğŸ“… ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ° Ğ´Ğ¾: {subscription_end}

  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  â„¹ï¸ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°: {subscription_fee} Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²/Ğ¼ĞµÑ.
  Ğ¢Ğ¾ĞºĞµĞ½Ñ‹ Ñ€Ğ°ÑÑ…Ğ¾Ğ´ÑƒÑÑ‚ÑÑ Ğ½Ğ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹.
  ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ: {min_payment}â‚½
  """

  BALANCE_INACTIVE = """
  ğŸ“Š Ğ’Ğ°Ñˆ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ

  ğŸ’³ Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: {balance} Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²
  âš ï¸ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ½ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°

  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  â„¹ï¸ Ğ”Ğ»Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ {min_payment}â‚½.
  {subscription_fee} Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² â€” Ğ°Ğ±Ğ¾Ğ½Ğ¿Ğ»Ğ°Ñ‚Ğ°,
  Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ â€” Ğ½Ğ° Ğ±Ğ°Ğ»Ğ°Ğ½Ñ.
  """
  ```

---

## Definition of Done (DoD)

### Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ

- [ ] `/start` Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ´Ğ²ÑƒÑ…ĞºĞ½Ğ¾Ğ¿Ğ¾Ñ‡Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ: Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ, ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ
- [ ] ĞšĞ½Ğ¾Ğ¿ĞºĞ° "Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ" Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸
- [ ] ĞšĞ½Ğ¾Ğ¿ĞºĞ° "ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ 200â‚½" ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ invoice Ğ¸ Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¸Ñ‚ Ğ½Ğ° Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñƒ
- [ ] "Ğ”Ñ€ÑƒĞ³Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ°" Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ğ²Ğ²Ğ¾Ğ´ >= 200â‚½
- [ ] ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶: 100 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² Ğ½Ğ° Ğ°Ğ±Ğ¾Ğ½Ğ¿Ğ»Ğ°Ñ‚Ñƒ, Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº Ğ½Ğ° Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
- [ ] ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶ (Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°): Ğ²ÑÑ ÑÑƒĞ¼Ğ¼Ğ° Ğ½Ğ° Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
- [ ] ĞĞ²Ñ‚Ğ¾Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ 100 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² Ğ¿Ñ€Ğ¸ Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸
- [ ] ĞŸÑ€Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞµ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ´ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ
- [ ] Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ° 3 Ğ¸ 1 Ğ´ĞµĞ½ÑŒ Ğ´Ğ¾ Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ñ

### Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾

- [ ] ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° `/tariffs` ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°
- [ ] ĞœĞµĞ½Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾
- [ ] Ğ¡Ñ‚Ğ°Ñ€Ğ°Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° `/pay` Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ¾Ğ¼ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°

### Ğ¢ĞµÑÑ‚Ñ‹

- [ ] Unit-Ñ‚ĞµÑÑ‚Ñ‹: Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾/Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°
- [ ] Unit-Ñ‚ĞµÑÑ‚Ñ‹: Ğ°Ğ²Ñ‚Ğ¾Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ¸Ğµ (Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾/Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ ÑÑ€ĞµĞ´ÑÑ‚Ğ²)
- [ ] Unit-Ñ‚ĞµÑÑ‚Ñ‹: Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑÑƒĞ¼Ğ¼Ñ‹
- [ ] Integration-Ñ‚ĞµÑÑ‚: Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ flow Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ

### ĞšĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾

- [ ] `mypy --strict` Ğ±ĞµĞ· Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
- [ ] `ruff check && ruff format` Ğ±ĞµĞ· Ğ·Ğ°Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğ¹

---

## User Flow

```
[/start]
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ           â”‚
â”‚  [ğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ]  [â“ ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼ (ĞºĞ»Ğ¸Ğº Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ğŸ“Š Ğ’Ğ°Ñˆ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ            â”‚
â”‚                             â”‚
â”‚  ğŸ’³ 150 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²             â”‚
â”‚  ğŸ“… ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ° Ğ´Ğ¾: 15.02.2026  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â„¹ï¸ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°: 100 Ñ‚Ğ¾Ğº/Ğ¼ĞµÑ   â”‚
â”‚                             â”‚
â”‚  [ğŸ’³ 200â‚½] [âœï¸ Ğ”Ñ€ÑƒĞ³Ğ°Ñ]      â”‚
â”‚  [ğŸ“‹ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ] [â“ ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                    â”‚
    â–¼                    â–¼
[Robokassa]      [Ğ’Ğ²Ğ¾Ğ´ ÑÑƒĞ¼Ğ¼Ñ‹ >= 200]
    â”‚                    â”‚
    â–¼                    â–¼
[Webhook]           [Robokassa]
    â”‚                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½!        â”‚
â”‚                             â”‚
â”‚  Ğ—Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¾: 200 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²     â”‚
â”‚  Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: 350 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²        â”‚
â”‚  ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°: Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ĞÑ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹

```
backend/src/
â”œâ”€â”€ models/
â”‚   â””â”€â”€ tariff.py          # +period_unit, +subscription_fee, +min_payment
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ payment_service.py # Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½Ğ½Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°
â”‚   â””â”€â”€ notification_service.py
â”œâ”€â”€ tasks/
â”‚   â””â”€â”€ subscription_tasks.py
â”œâ”€â”€ bot/
â”‚   â”œâ”€â”€ handlers/
â”‚   â”‚   â”œâ”€â”€ start.py       # Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ
â”‚   â”‚   â”œâ”€â”€ balance.py     # NEW: ÑĞºÑ€Ğ°Ğ½ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°
â”‚   â”‚   â””â”€â”€ payment.py     # Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½Ğ½Ñ‹Ğ¹ flow
â”‚   â”œâ”€â”€ keyboards/
â”‚   â”‚   â”œâ”€â”€ main_menu.py   # NEW
â”‚   â”‚   â””â”€â”€ balance.py     # NEW
â”‚   â”œâ”€â”€ states/
â”‚   â”‚   â””â”€â”€ payment.py     # FSM Ğ´Ğ»Ñ Ğ²Ğ²Ğ¾Ğ´Ğ° ÑÑƒĞ¼Ğ¼Ñ‹
â”‚   â””â”€â”€ messages/
â”‚       â””â”€â”€ balance.py     # NEW: Ñ‚ĞµĞºÑÑ‚Ñ‹
â””â”€â”€ tests/
    â”œâ”€â”€ test_payment_service.py
    â””â”€â”€ test_subscription_renewal.py

migrations/
â””â”€â”€ versions/
    â””â”€â”€ xxx_add_period_unit_to_tariff.py
```

---

## Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸

```
M9 (Subscription Management) â”€â”€> M11 (Simplified UX)
```

M11 Ñ€Ğ°ÑÑˆĞ¸Ñ€ÑĞµÑ‚ M9, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑÑ:
- ĞĞ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ² Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ°
- Ğ£Ğ¿Ñ€Ğ¾Ñ‰Ñ‘Ğ½Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ
- Ğ˜Ğ·Ğ¼ĞµĞ½Ñ‘Ğ½Ğ½ÑƒÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ·Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ñ

---

## ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ

```python
# core/config.py
class Settings(BaseSettings):
    # Subscription (Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾)
    SUBSCRIPTION_DEFAULT_PERIOD_UNIT: str = "month"
    SUBSCRIPTION_DEFAULT_PERIOD_VALUE: int = 1
    SUBSCRIPTION_FEE: int = 100  # Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²
    MIN_PAYMENT: Decimal = Decimal("200.00")
    SUBSCRIPTION_NOTIFY_DAYS: list[int] = [3, 1]
```

---

## Ğ¡Ğ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ² Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### Entity: tariffs (Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ)

#### ĞĞ¾Ğ²Ñ‹Ğµ Ğ°Ñ‚Ñ€Ğ¸Ğ±ÑƒÑ‚Ñ‹

| ĞÑ‚Ñ€Ğ¸Ğ±ÑƒÑ‚ | Ğ¢Ğ¸Ğ¿ | Nullable | Default | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|---------|-----|----------|---------|----------|
| period_unit | ENUM | No | 'month' | Ğ•Ğ´Ğ¸Ğ½Ğ¸Ñ†Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°: hour/day/month |
| period_value | INT | No | 1 | ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ĞµĞ´Ğ¸Ğ½Ğ¸Ñ† Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ° |
| subscription_fee | INT | No | 100 | Ğ¢Ğ¾ĞºĞµĞ½Ñ‹ Ğ°Ğ±Ğ¾Ğ½Ğ¿Ğ»Ğ°Ñ‚Ñ‹ Ğ·Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ |
| min_payment | DECIMAL(10,2) | No | 200.00 | ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶ Ğ² Ñ€ÑƒĞ±Ğ»ÑÑ… |

#### SQL Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ

```sql
-- Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ENUM Ñ‚Ğ¸Ğ¿Ğ°
CREATE TYPE period_unit AS ENUM ('hour', 'day', 'month');

-- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ¿Ğ¾Ğ»ĞµĞ¹
ALTER TABLE tariffs ADD COLUMN period_unit period_unit NOT NULL DEFAULT 'month';
ALTER TABLE tariffs ADD COLUMN period_value INT NOT NULL DEFAULT 1;
ALTER TABLE tariffs ADD COLUMN subscription_fee INT NOT NULL DEFAULT 100;
ALTER TABLE tariffs ADD COLUMN min_payment DECIMAL(10,2) NOT NULL DEFAULT 200.00;

-- ĞĞ¾Ğ²Ñ‹Ğµ constraints
ALTER TABLE tariffs ADD CONSTRAINT chk_tariffs_period_value
  CHECK (period_value > 0);
ALTER TABLE tariffs ADD CONSTRAINT chk_tariffs_subscription_fee
  CHECK (subscription_fee >= 0);
ALTER TABLE tariffs ADD CONSTRAINT chk_tariffs_min_payment
  CHECK (min_payment > 0);
```

#### ĞĞ¾Ğ²Ñ‹Ğµ Ğ¸Ğ½Ğ´ĞµĞºÑÑ‹

```sql
CREATE INDEX idx_tariffs_period ON tariffs(period_unit, period_value)
  WHERE is_active = true AND deleted_at IS NULL;
```

#### Ğ¡ĞµĞ¼Ğ°Ğ½Ñ‚Ğ¸ĞºĞ° Ğ¿Ğ¾Ğ»ĞµĞ¹

```
tariff.tokens          â€” Ñ‚Ğ¾ĞºĞµĞ½Ñ‹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ñ€Ğ¸ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ
tariff.subscription_fee â€” Ñ‚Ğ¾ĞºĞµĞ½Ñ‹, ÑĞ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼Ñ‹Ğµ ĞºĞ°Ğº Ğ°Ğ±Ğ¾Ğ½Ğ¿Ğ»Ğ°Ñ‚Ğ° Ğ¿Ñ€Ğ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸/Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ¸Ğ¸
tariff.min_payment     â€” Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ° Ğ² Ñ€ÑƒĞ±Ğ»ÑÑ…
```

---

## State Machine: Payment Processing

### Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğµ

| Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|-----------|----------|
| inactive | ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ½ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ° (subscription_end IS NULL OR subscription_end < now()) |
| active | ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ° (subscription_end > now()) |

### ĞœĞ°Ñ‚Ñ€Ğ¸Ñ†Ğ° Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¾Ğ² Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°

| Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ | Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ | Guard | Action | Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ |
|--------------------|---------|-------|--------|-----------|
| inactive | payment_received | amount >= min_payment | deduct_subscription_fee, credit_remaining, activate_subscription | active |
| active | payment_received | amount >= min_payment | credit_full_amount | active |

### Ğ”Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°

```
                    payment_received
                          â”‚
                          â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ subscription_active?  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚           â”‚
                 No â”‚           â”‚ Yes
                    â–¼           â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ tokens =     â”‚  â”‚ tokens =     â”‚
         â”‚ amount -     â”‚  â”‚ amount       â”‚
         â”‚ sub_fee      â”‚  â”‚ (full)       â”‚
         â”‚              â”‚  â”‚              â”‚
         â”‚ activate     â”‚  â”‚              â”‚
         â”‚ subscription â”‚  â”‚              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚           â”‚
                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                          â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ credit_tokens(tokens) â”‚
              â”‚ create_transaction()  â”‚
              â”‚ notify_user()         â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ĞĞ²Ñ‚Ğ¾Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ¸Ğµ (State Machine)

```
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ active  â”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                   â”‚
         subscription_end <= now()
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ balance >= sub_fee? â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚         â”‚
           Yesâ”‚         â”‚No
              â–¼         â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ deduct_fee  â”‚  â”‚ deactivate  â”‚
     â”‚ extend_sub  â”‚  â”‚ notify_user â”‚
     â”‚ notify_user â”‚  â”‚             â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚              â”‚
              â–¼              â–¼
        [active]        [inactive]
```

---

## Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ¹ Ğ´Ğ°Ñ‚Ñ‹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸

```python
from datetime import datetime, timedelta
from dateutil.relativedelta import relativedelta

def calculate_next_subscription_end(
    current_end: datetime | None,
    unit: PeriodUnit,
    value: int
) -> datetime:
    """
    Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ»ĞµĞ´ÑƒÑÑ‰ÑƒÑ Ğ´Ğ°Ñ‚Ñƒ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸.

    Ğ”Ğ»Ñ month Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ relativedelta (ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚
    Ñ€Ğ°Ğ·Ğ½ÑƒÑ Ğ´Ğ»Ğ¸Ğ½Ñƒ Ğ¼ĞµÑÑÑ†ĞµĞ²).
    """
    base = current_end or datetime.utcnow()

    if unit == PeriodUnit.HOUR:
        return base + timedelta(hours=value)
    elif unit == PeriodUnit.DAY:
        return base + timedelta(days=value)
    elif unit == PeriodUnit.MONTH:
        return base + relativedelta(months=value)
    else:
        raise ValueError(f"Unknown period unit: {unit}")
```

---

## ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### 1. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ `tariffs`

Ğ¡Ğ¼. SQL Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ²Ñ‹ÑˆĞµ.

### 2. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ Ñ‚Ğ°Ñ€Ğ¸Ñ„

```sql
UPDATE tariffs SET
    period_unit = 'month',
    period_value = 1,
    subscription_fee = 100,
    min_payment = 200.00
WHERE slug = 'basic';
```

### 3. Ğ”ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ»Ğ¸ÑˆĞ½Ğ¸Ğµ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ñ‹ (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ)

```sql
UPDATE tariffs SET is_active = false
WHERE slug != 'basic';
```

### 4. ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹

Ğ¡ÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¾Ğ¹:
- `subscription_end` ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹
- ĞŸÑ€Ğ¸ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ¼ Ğ°Ğ²Ñ‚Ğ¾Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ Ğ½Ğ¾Ğ²Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° (ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ subscription_fee)

ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸:
- ĞŸÑ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğµ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ Ğ½Ğ¾Ğ²Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° (subscription_fee ÑĞ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ÑÑ ÑÑ€Ğ°Ğ·Ñƒ)

**Ğ’Ğ°Ğ¶Ğ½Ğ¾**: ĞĞµÑ‚ breaking changes Ğ´Ğ»Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹. Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹.

---

## ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ architecture.md

ĞŸĞ¾ÑĞ»Ğµ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ M11 Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ [docs/architecture.md](../docs/architecture.md):

1. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ² ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Entity: tariffs
2. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ CHECK constraints
3. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¸Ğ½Ğ´ĞµĞºÑ idx_tariffs_period
4. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ State Machine: Subscription Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¾Ğ¹
