# E4.4 — Payment Service

## Описание

Создание сервиса для работы с платежами.

---

## Tasks

### T4.4.1 — Payment service implementation

**Описание:** Создать сервис для генерации платёжных URL и обработки webhooks.

**Файл:** `backend/src/services/payment_service.py`

**Реализация:**
```python
from uuid import UUID
from decimal import Decimal
import logging

from sqlalchemy.ext.asyncio import AsyncSession

from payments.providers.base import PaymentProvider
from payments.schemas import WebhookData, PaymentResult
from db.repositories.invoice_repository import InvoiceRepository
from db.models.invoice import Invoice, InvoiceStatus
from core.exceptions import NotFoundError, PaymentError

logger = logging.getLogger(__name__)

class PaymentService:
    """Service for payment operations"""

    def __init__(self, session: AsyncSession, provider: PaymentProvider):
        self.session = session
        self.provider = provider
        self.invoice_repo = InvoiceRepository(session)

    async def create_payment(self, invoice_id: UUID) -> str:
        """
        Generate payment URL for invoice.

        Args:
            invoice_id: UUID of invoice to pay

        Returns:
            Payment URL for redirect

        Raises:
            NotFoundError: Invoice not found
            PaymentError: Invoice not in pending status
        """
        invoice = await self.invoice_repo.get_by_id(invoice_id)

        if not invoice:
            raise NotFoundError(f"Invoice {invoice_id} not found")

        if invoice.status != InvoiceStatus.PENDING:
            raise PaymentError(
                f"Invoice {invoice_id} is not pending (status={invoice.status})"
            )

        # Generate payment URL
        payment_url = self.provider.generate_payment_url(invoice)

        # Save payment URL to invoice
        invoice.payment_url = payment_url
        await self.session.commit()

        logger.info(
            f"Payment URL generated: invoice_id={invoice_id}, "
            f"provider={self.provider.get_provider_name()}"
        )

        return payment_url

    async def process_webhook(self, data: WebhookData) -> PaymentResult:
        """
        Process ResultURL callback.

        Steps:
        1. Find invoice by shp_invoice_id
        2. Validate inv_id matches
        3. Check idempotency (status != pending → skip)
        4. Update invoice status to PAID
        5. Return result for billing processing

        Args:
            data: Parsed webhook data

        Returns:
            PaymentResult with invoice info

        Raises:
            NotFoundError: Invoice not found
            PaymentError: InvId mismatch
        """
        # 1. Find invoice
        invoice = await self.invoice_repo.get_by_id(data.shp_invoice_id)

        if not invoice:
            raise NotFoundError(f"Invoice {data.shp_invoice_id} not found")

        # 2. Validate inv_id
        if invoice.inv_id != data.inv_id:
            raise PaymentError(
                f"InvId mismatch: expected {invoice.inv_id}, got {data.inv_id}"
            )

        # 3. Check idempotency
        if invoice.status != InvoiceStatus.PENDING:
            logger.info(
                f"Invoice already processed: {invoice.id}, status={invoice.status}"
            )
            return PaymentResult(
                success=True,
                invoice_id=invoice.id,
                inv_id=invoice.inv_id,
                amount=invoice.amount,
            )

        # 4. Update status
        # Note: actual billing (tokens, subscription) happens in BillingService
        # This method only marks payment as received

        logger.info(
            f"Payment received: invoice_id={invoice.id}, "
            f"amount={data.out_sum}, inv_id={data.inv_id}"
        )

        return PaymentResult(
            success=True,
            invoice_id=invoice.id,
            inv_id=invoice.inv_id,
            amount=data.out_sum,
        )

    async def get_payment_status(self, invoice_id: UUID) -> InvoiceStatus:
        """Get current payment status"""
        invoice = await self.invoice_repo.get_by_id(invoice_id)
        if not invoice:
            raise NotFoundError(f"Invoice {invoice_id} not found")
        return invoice.status
```

**DoD:**
- [ ] create_payment генерирует URL
- [ ] process_webhook обрабатывает callback
- [ ] Idempotency: повторные webhooks игнорируются
- [ ] Валидация inv_id
- [ ] Логирование операций
- [ ] Unit-тесты

---

### T4.4.2 — Integration with invoice service

**Описание:** Интегрировать PaymentService с InvoiceService для полного flow.

**Обновления в InvoiceService:**
```python
# В services/invoice_service.py

from services.payment_service import PaymentService

class InvoiceService:
    # ... existing code ...

    async def create_invoice_with_payment(
        self,
        user_id: int,
        tariff_id: UUID,
        payment_provider: PaymentProvider,
    ) -> tuple[Invoice, str]:
        """
        Create invoice and generate payment URL.

        Returns:
            (invoice, payment_url)
        """
        # 1. Create or get invoice
        invoice, created = await self.get_or_create_invoice(user_id, tariff_id)

        # 2. Generate payment URL if new or URL expired
        payment_service = PaymentService(self.session, payment_provider)

        if created or not invoice.payment_url:
            payment_url = await payment_service.create_payment(invoice.id)
        else:
            payment_url = invoice.payment_url

        return invoice, payment_url
```

**Обновления в buy handler:**
```python
# В bot/handlers/buy.py

@router.callback_query(TariffCallback.filter())
async def process_tariff_selection(
    callback: CallbackQuery,
    callback_data: TariffCallback,
    user: User,
    session: AsyncSession,
) -> None:
    tariff_service = TariffService(session)
    invoice_service = InvoiceService(session)
    provider = get_payment_provider()

    tariff = await tariff_service.get_tariff_by_id(callback_data.tariff_id)

    invoice, payment_url = await invoice_service.create_invoice_with_payment(
        user_id=user.id,
        tariff_id=tariff.id,
        payment_provider=provider,
    )

    # Show payment keyboard with URL
    keyboard = get_payment_keyboard(payment_url, invoice.amount, invoice.id)
    await callback.message.edit_text(
        format_invoice_message(invoice, tariff),
        reply_markup=keyboard,
    )
```

**DoD:**
- [ ] InvoiceService интегрирован с PaymentService
- [ ] Bot handler использует create_invoice_with_payment
- [ ] Payment URL показывается пользователю
- [ ] Integration test: tariff → invoice → payment URL
