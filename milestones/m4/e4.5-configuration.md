# E4.5 — Configuration

## Описание

Настройка конфигурации и factory для выбора payment provider.

---

## Tasks

### T4.5.1 — Update config

**Описание:** Добавить настройки платёжного провайдера в конфигурацию.

**Файл:** `backend/src/core/config.py` (обновление)

**Добавления:**
```python
from typing import Literal
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # ... existing settings ...

    # Payment provider selection
    PAYMENT_PROVIDER: Literal["mock", "robokassa"] = "mock"

    # Mock provider settings (same structure as Robokassa for consistency)
    MOCK_MERCHANT_LOGIN: str = "test_merchant"
    MOCK_PASSWORD_1: str = "test_password_1"
    MOCK_PASSWORD_2: str = "test_password_2"

    # Robokassa settings (for M6)
    ROBOKASSA_MERCHANT_LOGIN: str = ""
    ROBOKASSA_PASSWORD_1: str = ""
    ROBOKASSA_PASSWORD_2: str = ""
    ROBOKASSA_IS_TEST: bool = True

    # Callback URLs
    WEBHOOK_BASE_URL: str  # e.g., https://yourdomain.com
    SUCCESS_URL: str | None = None  # Redirect after payment
    FAIL_URL: str | None = None     # Redirect after cancel

    # Invoice settings
    INVOICE_TTL_HOURS: int = 24  # How long invoice stays pending

    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"

settings = Settings()
```

**.env.example обновление:**
```env
# Payment Provider
PAYMENT_PROVIDER=mock  # mock or robokassa

# Mock Provider (for testing)
MOCK_MERCHANT_LOGIN=test_merchant
MOCK_PASSWORD_1=test_password_1
MOCK_PASSWORD_2=test_password_2

# Robokassa (for production)
ROBOKASSA_MERCHANT_LOGIN=
ROBOKASSA_PASSWORD_1=
ROBOKASSA_PASSWORD_2=
ROBOKASSA_IS_TEST=true

# Callbacks
WEBHOOK_BASE_URL=http://localhost:8000
SUCCESS_URL=
FAIL_URL=

# Invoice
INVOICE_TTL_HOURS=24
```

**DoD:**
- [ ] Все настройки добавлены в Settings
- [ ] Literal type для PAYMENT_PROVIDER
- [ ] Defaults для mock режима
- [ ] .env.example обновлён

---

### T4.5.2 — Provider factory

**Описание:** Создать factory для создания payment provider.

**Файл:** `backend/src/payments/providers/__init__.py`

**Реализация:**
```python
from typing import Literal

from payments.providers.base import PaymentProvider
from payments.providers.mock.provider import MockPaymentProvider
from core.config import settings

# Provider registry
_providers: dict[str, type[PaymentProvider]] = {
    "mock": MockPaymentProvider,
}

# Cached provider instances
_provider_instances: dict[str, PaymentProvider] = {}

def get_payment_provider(
    provider_name: Literal["mock", "robokassa"] | None = None
) -> PaymentProvider:
    """
    Get payment provider instance.

    Args:
        provider_name: Provider name. If None, uses PAYMENT_PROVIDER from settings.

    Returns:
        Configured PaymentProvider instance

    Raises:
        ValueError: Unknown provider name
    """
    name = provider_name or settings.PAYMENT_PROVIDER

    # Return cached instance if exists
    if name in _provider_instances:
        return _provider_instances[name]

    # Create new instance
    if name == "mock":
        provider = MockPaymentProvider(
            merchant_login=settings.MOCK_MERCHANT_LOGIN,
            password_1=settings.MOCK_PASSWORD_1,
            password_2=settings.MOCK_PASSWORD_2,
            base_url=settings.WEBHOOK_BASE_URL,
        )
    elif name == "robokassa":
        # Will be implemented in M6
        raise NotImplementedError("Robokassa provider not yet implemented")
    else:
        raise ValueError(f"Unknown payment provider: {name}")

    # Cache and return
    _provider_instances[name] = provider
    return provider

def register_provider(name: str, provider_class: type[PaymentProvider]) -> None:
    """Register custom payment provider"""
    _providers[name] = provider_class

def clear_provider_cache() -> None:
    """Clear cached provider instances (for testing)"""
    _provider_instances.clear()
```

**Usage:**
```python
from payments.providers import get_payment_provider

# Get provider from settings
provider = get_payment_provider()

# Get specific provider
mock_provider = get_payment_provider("mock")
```

**DoD:**
- [ ] Factory создаёт правильный провайдер
- [ ] Провайдеры кэшируются (singleton)
- [ ] Mock провайдер создаётся с настройками
- [ ] Robokassa выбрасывает NotImplementedError
- [ ] clear_provider_cache для тестов
