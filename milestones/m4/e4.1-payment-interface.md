# E4.1 — Payment Interface

## Описание

Создание абстрактного интерфейса платёжного провайдера и схем данных.

---

## Tasks

### T4.1.1 — Payment provider interface

**Описание:** Создать абстрактный базовый класс PaymentProvider.

**Файл:** `backend/src/payments/providers/base.py`

**Интерфейс:**
```python
from abc import ABC, abstractmethod
from decimal import Decimal
from uuid import UUID

from db.models.invoice import Invoice
from payments.schemas import WebhookData, PaymentResult

class PaymentProvider(ABC):
    """Abstract base class for payment providers"""

    @abstractmethod
    def generate_payment_url(self, invoice: Invoice) -> str:
        """
        Generate redirect URL for payment initiation.

        Args:
            invoice: Invoice to pay

        Returns:
            URL string for redirect (Robokassa payment page or mock page)
        """

    @abstractmethod
    def verify_result_signature(self, data: WebhookData) -> bool:
        """
        Verify ResultURL callback signature.

        Args:
            data: Parsed webhook data

        Returns:
            True if signature is valid
        """

    @abstractmethod
    def parse_webhook(self, raw_data: dict) -> WebhookData:
        """
        Parse incoming webhook to unified format.

        Args:
            raw_data: Raw form/query data from webhook

        Returns:
            WebhookData with parsed fields
        """

    @abstractmethod
    def format_success_response(self, inv_id: int) -> str:
        """
        Format response for successful webhook processing.

        Args:
            inv_id: Robokassa InvId

        Returns:
            Response string (e.g., "OK12345" for Robokassa)
        """

    @abstractmethod
    def get_provider_name(self) -> str:
        """Get provider name for logging"""
```

**DoD:**
- [ ] ABC создан со всеми методами
- [ ] Docstrings описывают контракт
- [ ] Type hints для всех параметров и возвратов

---

### T4.1.2 — Payment schemas

**Описание:** Создать Pydantic схемы для платёжных данных.

**Файл:** `backend/src/payments/schemas.py`

**Схемы:**
```python
from pydantic import BaseModel, Field
from decimal import Decimal
from datetime import datetime
from uuid import UUID
from enum import IntEnum

class PaymentInitParams(BaseModel):
    """
    Parameters for payment initiation.
    Matches Robokassa payment URL format.
    """
    merchant_login: str
    out_sum: Decimal = Field(..., description="Amount in RUB (123.45)")
    inv_id: int = Field(..., ge=1, description="1 - 9223372036854775807")
    description: str = Field(..., max_length=100)
    signature: str = Field(..., description="MD5 hash")

    # Optional
    culture: str = "ru"
    email: str | None = None
    expiration_date: datetime | None = None  # ISO 8601
    is_test: bool = False

    # Custom params (Shp_*)
    shp_invoice_id: UUID = Field(..., description="Our UUID invoice")
    shp_user_id: int = Field(..., description="Telegram user_id")

class WebhookData(BaseModel):
    """
    ResultURL callback data.
    Matches Robokassa webhook format.
    """
    out_sum: Decimal
    inv_id: int
    signature: str

    # Optional from Robokassa
    fee: Decimal | None = None
    email: str | None = None
    payment_method: str | None = None

    # Custom params
    shp_invoice_id: UUID
    shp_user_id: int

class PaymentStatus(IntEnum):
    """
    OpStateExt status codes from Robokassa.
    """
    INITIALIZED = 5
    CANCELLED = 10
    RESERVED = 50       # Hold
    CANCELLED_AFTER_RESERVE = 60
    TRANSFERRED = 80
    COMPLETED = 100

class PaymentResult(BaseModel):
    """Result of payment processing"""
    success: bool
    invoice_id: UUID
    inv_id: int
    amount: Decimal
    error_message: str | None = None
```

**Валидация:**
- `out_sum` > 0
- `inv_id` >= 1
- `description` <= 100 символов
- UUID форматы для shp_invoice_id

**DoD:**
- [ ] Все схемы созданы
- [ ] Валидация на полях
- [ ] Field descriptions для документации
- [ ] PaymentStatus enum соответствует Robokassa
