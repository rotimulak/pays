# E4.3 — Webhook Handler

## Описание

Создание FastAPI endpoint для обработки ResultURL callbacks от платёжной системы.

---

## Tasks

### T4.3.1 — Webhook router

**Описание:** Создать endpoint для ResultURL callback.

**Файл:** `backend/src/api/routes/webhook.py`

**Реализация:**
```python
from fastapi import APIRouter, Form, Depends, HTTPException
from fastapi.responses import PlainTextResponse
from decimal import Decimal
from uuid import UUID
import logging

from sqlalchemy.ext.asyncio import AsyncSession

from api.dependencies import get_session, get_payment_provider
from payments.providers.base import PaymentProvider
from payments.schemas import WebhookData
from services.payment_service import PaymentService

router = APIRouter(prefix="/webhook", tags=["webhook"])
logger = logging.getLogger(__name__)

@router.post("/robokassa", response_class=PlainTextResponse)
async def robokassa_result_url(
    OutSum: Decimal = Form(...),
    InvId: int = Form(...),
    SignatureValue: str = Form(...),
    Shp_invoice_id: UUID = Form(...),
    Shp_user_id: int = Form(...),
    # Optional fields
    Fee: Decimal | None = Form(None),
    EMail: str | None = Form(None),
    PaymentMethod: str | None = Form(None),
    session: AsyncSession = Depends(get_session),
    provider: PaymentProvider = Depends(get_payment_provider),
) -> str:
    """
    ResultURL callback handler for Robokassa and Mock provider.

    Process:
    1. Parse form data to WebhookData
    2. Verify signature
    3. Process payment via PaymentService
    4. Return "OK{InvId}" on success

    Returns:
        "OK{InvId}" - Robokassa expects this exact format
    """
    logger.info(
        f"Webhook received: InvId={InvId}, OutSum={OutSum}, "
        f"invoice_id={Shp_invoice_id}, user_id={Shp_user_id}"
    )

    # 1. Create WebhookData
    webhook_data = WebhookData(
        out_sum=OutSum,
        inv_id=InvId,
        signature=SignatureValue,
        shp_invoice_id=Shp_invoice_id,
        shp_user_id=Shp_user_id,
        fee=Fee,
        email=EMail,
        payment_method=PaymentMethod,
    )

    # 2. Verify signature
    if not provider.verify_result_signature(webhook_data):
        logger.warning(f"Invalid signature for InvId={InvId}")
        raise HTTPException(status_code=400, detail="Invalid signature")

    # 3. Process payment
    payment_service = PaymentService(session, provider)

    try:
        result = await payment_service.process_webhook(webhook_data)
        logger.info(f"Payment processed: InvId={InvId}, success={result.success}")
    except Exception as e:
        logger.error(f"Payment processing failed: InvId={InvId}, error={e}")
        raise HTTPException(status_code=500, detail="Processing failed")

    # 4. Return success response
    return provider.format_success_response(InvId)
```

**Error handling:**
- 400: Invalid signature
- 404: Invoice not found
- 409: Invoice already processed (idempotency)
- 500: Internal error

**DoD:**
- [ ] Endpoint принимает Form data
- [ ] Подпись верифицируется
- [ ] PaymentService вызывается
- [ ] Возвращается `OK{InvId}`
- [ ] Логирование всех шагов
- [ ] Обработка ошибок

---

### T4.3.2 — API dependencies

**Описание:** Создать FastAPI dependencies для DI.

**Файл:** `backend/src/api/dependencies.py`

**Реализация:**
```python
from typing import AsyncGenerator
from fastapi import Depends

from sqlalchemy.ext.asyncio import AsyncSession

from db.session import async_session_factory
from payments.providers.base import PaymentProvider
from payments.providers import get_payment_provider as _get_payment_provider
from core.config import settings

async def get_session() -> AsyncGenerator[AsyncSession, None]:
    """
    Dependency for database session.
    Creates new session per request, commits on success, rollbacks on error.
    """
    async with async_session_factory() as session:
        try:
            yield session
            await session.commit()
        except Exception:
            await session.rollback()
            raise

def get_payment_provider() -> PaymentProvider:
    """
    Dependency for payment provider.
    Returns configured provider based on PAYMENT_PROVIDER setting.
    """
    return _get_payment_provider(settings.PAYMENT_PROVIDER)

# Typed dependencies for FastAPI
SessionDep = Depends(get_session)
PaymentProviderDep = Depends(get_payment_provider)
```

**DoD:**
- [ ] get_session создаёт и закрывает сессию
- [ ] Commit на успех, rollback на ошибку
- [ ] get_payment_provider возвращает настроенный провайдер
- [ ] Typed dependencies для удобства
