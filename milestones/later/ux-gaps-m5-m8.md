# UX-анализ M5-M8: выявленные пробелы

> Дата анализа: 2026-01-01
> Роль: UX/Product Specialist (docs/roles/ux-product.md)

## Применяемые критерии

- Эвристики Нильсена (#1-10)
- Состояния: empty, loading, error, success, disabled
- User Flow: Триггер → Вход → Шаги → Результат → Error path

---

## M5: Billing Flow

### Хорошо покрыто

- Уведомление об успешной оплате
- Идемпотентность webhook
- Пустое состояние в `/history`
- Pagination в истории
- Предупреждение об истекающей подписке

### Пробелы

| # | Проблема | Эвристика | Решение |
|---|----------|-----------|---------|
| 1 | **Нет уведомления о неуспешной оплате** | #1 Видимость статуса | Добавить `notify_payment_failed()` — пользователь нажал "Оплатить", но закрыл страницу |
| 2 | **Нет статуса "в обработке"** | #1 Видимость статуса | После нажатия кнопки оплаты показать сообщение "Ожидаем подтверждения оплаты..." |
| 3 | **Нет возможности отменить ожидающий invoice** | #3 Свобода и контроль | Добавить кнопку "Отменить счёт" пока он pending |
| 4 | **Нет команды `/invoices`** | #6 Узнавание | Добавить просмотр текущих счетов (pending/paid) |
| 5 | **Invoice expiration молча происходит** | #1 Видимость статуса | Уведомить пользователя: "Счёт на 200₽ истёк" |
| 6 | **Нет retry для неотправленных уведомлений** | #5 Предотвращение ошибок | Если бот заблокирован → сохранить в очередь |

---

## M6: Robokassa Provider

### Хорошо покрыто

- Signature verification
- Test mode support
- Переключение провайдеров

### Пробелы

| # | Проблема | Эвристика | Решение |
|---|----------|-----------|---------|
| 1 | **Нет обработки ошибок Robokassa** | #9 Понятные ошибки | При ошибке API показать "Платёжная система временно недоступна, попробуйте позже" |
| 2 | **Нет timeout handling** | #1 Видимость статуса | Если Robokassa не отвечает — показать fallback сообщение |
| 3 | **Нет SuccessURL/FailURL обработки** | #4 Консистентность | Создать landing страницы с инструкцией вернуться в бот |

---

## M7: Promo Codes

### Хорошо покрыто

- FSM для ввода промокода
- Кнопка "Отмена"
- Возможность убрать/изменить промокод
- Понятные ошибки валидации

### Пробелы

| # | Проблема | Эвристика | Решение |
|---|----------|-----------|---------|
| 1 | **Нет подсказки формата промокода** | #10 Контекстная справка | Добавить пример: "Например: WELCOME2024" |
| 2 | **Нет истории использованных промокодов** | #6 Узнавание | В `/history` показывать примененные скидки |
| 3 | **Нет сообщения если промокод уже использован этим пользователем** | #9 Понятные ошибки | "Вы уже использовали этот промокод ранее" |
| 4 | **Нет обработки "промокод почти истёк"** | #5 Предотвращение | "Промокод действует ещё 2 часа!" |
| 5 | **Состояние `confirming_purchase` не имеет timeout** | #3 Свобода | Добавить auto-clear FSM через N минут |

---

## M8: Token Spending

### Хорошо покрыто

- Детальный `/balance`
- Цветовые индикаторы
- Low balance notifications с порогами
- Статистика за неделю
- Понятные ошибки (InsufficientBalance, SubscriptionExpired)

### Пробелы

| # | Проблема | Эвристика | Решение |
|---|----------|-----------|---------|
| 1 | **Нет preview перед списанием** | #5 Предотвращение | В API добавить endpoint `POST /tokens/preview` |
| 2 | **Нет уведомления после списания** | #1 Видимость статуса | Показать "Списано 5 токенов. Баланс: 45" |
| 3 | **Нет "отката" ошибочного списания** | #3 Свобода и контроль | Добавить refund механизм для админа |
| 4 | **Rate limit error не понятен пользователю** | #9 Понятные ошибки | "Слишком много запросов, подождите 30 секунд" |
| 5 | **Нет объяснения почему нельзя тратить** | #9 Понятные ошибки | Сейчас `balance.reason` — нужно убедиться, что он человекочитаемый |
| 6 | **Нет прогноза "токенов хватит на X дней"** | #10 Контекстная справка | На основе avg_daily показать прогноз |

---

## Общие пробелы (cross-milestone)

| # | Проблема | Затронутые M | Решение |
|---|----------|--------------|---------|
| 1 | **Нет loading состояний** | M5-M8 | При долгих операциях показывать "⏳ Загрузка..." |
| 2 | **Нет единого error handler** | M5-M8 | Централизованный middleware с человекочитаемыми ошибками |
| 3 | **Нет команды `/help`** | M5-M8 | Добавить справку по всем командам |
| 4 | **Нет onboarding flow** | M5 | Новому пользователю: "Добро пожаловать! Начните с /tariffs" |
| 5 | **Нет deep links** | M5, M7 | `t.me/bot?start=tariff_123` или `?start=promo_WELCOME` |

---

## Приоритетные рекомендации (RICE)

| Приоритет | Задача | Impact | Effort |
|-----------|--------|--------|--------|
| HIGH | Добавить `/invoices` для просмотра счетов | High | Low |
| HIGH | Уведомление об expired invoice | High | Low |
| HIGH | SuccessURL/FailURL страницы для Robokassa | High | Medium |
| MED | Loading states во всех handlers | Medium | Low |
| MED | Кнопка отмены pending invoice | Medium | Medium |
| LOW | Прогноз "хватит на X дней" | Low | Low |
| LOW | Deep links для тарифов | Low | Medium |
