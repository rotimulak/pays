# E6.2 — Signature Utilities

## Описание

Утилиты для генерации и проверки MD5 подписей согласно спецификации Robokassa.

---

## Tasks

### T6.2.1 — Signature generation

**Описание:** Создать функции для генерации подписей.

**Файл:** `backend/src/payments/providers/robokassa/signature.py`

**Реализация:**
```python
import hashlib
from decimal import Decimal

def generate_init_signature(
    merchant_login: str,
    out_sum: Decimal,
    inv_id: int,
    password: str,
    shp_params: dict[str, str] | None = None,
    receipt: str | None = None,
) -> str:
    """
    Generate signature for payment URL (init).

    Formula WITHOUT Shp_* and Receipt:
        MD5(MerchantLogin:OutSum:InvId:Password_1)

    Formula WITH Shp_* (sorted alphabetically):
        MD5(MerchantLogin:OutSum:InvId:Receipt:Password_1:Shp_a=x:Shp_b=y)

    Note: Receipt included only if present, before Password_1

    Args:
        merchant_login: Robokassa merchant login
        out_sum: Payment amount
        inv_id: Invoice number
        password: Password_1 from Robokassa
        shp_params: Custom parameters (Shp_*)
        receipt: JSON receipt string for 54-ФЗ

    Returns:
        MD5 hash string (lowercase)
    """
    # Format amount: always 2 decimal places
    out_sum_str = f"{out_sum:.2f}"

    # Build signature parts
    parts = [merchant_login, out_sum_str, str(inv_id)]

    # Add receipt if present (before password)
    if receipt:
        parts.append(receipt)

    parts.append(password)

    # Add Shp_* parameters sorted alphabetically
    if shp_params:
        for key, value in sorted(shp_params.items()):
            parts.append(f"{key}={value}")

    signature_string = ":".join(parts)
    return hashlib.md5(signature_string.encode("utf-8")).hexdigest()


def generate_result_signature(
    out_sum: Decimal,
    inv_id: int,
    password: str,
    shp_params: dict[str, str] | None = None,
) -> str:
    """
    Generate signature for ResultURL verification.

    Formula WITHOUT Shp_*:
        MD5(OutSum:InvId:Password_2)

    Formula WITH Shp_* (sorted alphabetically):
        MD5(OutSum:InvId:Password_2:Shp_a=x:Shp_b=y)

    Args:
        out_sum: Payment amount from callback
        inv_id: Invoice number from callback
        password: Password_2 from Robokassa
        shp_params: Custom parameters from callback

    Returns:
        MD5 hash string (lowercase)
    """
    out_sum_str = f"{out_sum:.2f}"

    parts = [out_sum_str, str(inv_id), password]

    if shp_params:
        for key, value in sorted(shp_params.items()):
            parts.append(f"{key}={value}")

    signature_string = ":".join(parts)
    return hashlib.md5(signature_string.encode("utf-8")).hexdigest()


def generate_success_signature(
    out_sum: Decimal,
    inv_id: int,
    password: str,
    shp_params: dict[str, str] | None = None,
) -> str:
    """
    Generate signature for SuccessURL verification.
    Same formula as ResultURL but with Password_1.

    Formula:
        MD5(OutSum:InvId:Password_1:Shp_*)
    """
    out_sum_str = f"{out_sum:.2f}"
    parts = [out_sum_str, str(inv_id), password]

    if shp_params:
        for key, value in sorted(shp_params.items()):
            parts.append(f"{key}={value}")

    signature_string = ":".join(parts)
    return hashlib.md5(signature_string.encode("utf-8")).hexdigest()
```

**Примеры подписей:**
```python
# Init signature (payment URL):
# merchant=demo, sum=100.00, inv_id=1, pass=secret
# Shp_invoice_id=abc-123, Shp_user_id=456
# → MD5("demo:100.00:1:secret:Shp_invoice_id=abc-123:Shp_user_id=456")
# = "e10adc3949ba59abbe56e057f20f883e"

# Result signature (webhook):
# sum=100.00, inv_id=1, pass=secret2
# Shp_invoice_id=abc-123, Shp_user_id=456
# → MD5("100.00:1:secret2:Shp_invoice_id=abc-123:Shp_user_id=456")
```

**DoD:**
- [ ] Init signature с Shp_* параметрами
- [ ] Init signature с Receipt для 54-ФЗ
- [ ] Result signature генерация
- [ ] Success signature для SuccessURL
- [ ] Unit-тесты с известными значениями

---

### T6.2.2 — Signature verification

**Описание:** Создать функции для проверки подписей.

**Добавление в signature.py:**
```python
def verify_result_signature(
    signature: str,
    out_sum: Decimal,
    inv_id: int,
    password: str,
    shp_params: dict[str, str] | None = None,
) -> bool:
    """
    Verify ResultURL callback signature.

    Args:
        signature: Signature from callback
        out_sum: OutSum from callback
        inv_id: InvId from callback
        password: Password_2
        shp_params: Shp_* params from callback

    Returns:
        True if signature is valid
    """
    expected = generate_result_signature(out_sum, inv_id, password, shp_params)
    return _constant_time_compare(signature.lower(), expected.lower())


def verify_success_signature(
    signature: str,
    out_sum: Decimal,
    inv_id: int,
    password: str,
    shp_params: dict[str, str] | None = None,
) -> bool:
    """
    Verify SuccessURL callback signature.

    Args:
        signature: Signature from callback
        out_sum: OutSum from callback
        inv_id: InvId from callback
        password: Password_1
        shp_params: Shp_* params from callback

    Returns:
        True if signature is valid
    """
    expected = generate_success_signature(out_sum, inv_id, password, shp_params)
    return _constant_time_compare(signature.lower(), expected.lower())


def _constant_time_compare(a: str, b: str) -> bool:
    """
    Constant-time string comparison to prevent timing attacks.
    """
    import hmac
    return hmac.compare_digest(a.encode(), b.encode())


def extract_shp_params(raw_data: dict) -> dict[str, str]:
    """
    Extract Shp_* parameters from webhook data.

    Args:
        raw_data: Raw form/query data

    Returns:
        Dict with Shp_* parameters only
    """
    return {
        key: str(value)
        for key, value in raw_data.items()
        if key.startswith("Shp_")
    }
```

**Security considerations:**
- Constant-time comparison для предотвращения timing attacks
- Case-insensitive comparison (MD5 может быть в любом регистре)
- Валидация всех Shp_* параметров

**DoD:**
- [ ] verify_result_signature реализован
- [ ] verify_success_signature реализован
- [ ] Constant-time comparison
- [ ] extract_shp_params helper
- [ ] Unit-тесты для валидных и невалидных подписей
