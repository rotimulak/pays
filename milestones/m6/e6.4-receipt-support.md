# E6.4 — Receipt Support (54-ФЗ)

## Описание

Поддержка онлайн-касс согласно 54-ФЗ. Robokassa требует передачи чека для фискализации.

---

## Tasks

### T6.4.1 — Receipt builder

**Описание:** Создать builder для формирования чека.

**Файл:** `backend/src/payments/providers/robokassa/receipt.py`

**Реализация:**
```python
import json
from dataclasses import dataclass, field
from decimal import Decimal
from enum import Enum
from urllib.parse import quote

class TaxType(str, Enum):
    """НДС типы для Robokassa"""
    NONE = "none"           # Без НДС
    VAT0 = "vat0"           # НДС 0%
    VAT10 = "vat10"         # НДС 10%
    VAT20 = "vat20"         # НДС 20%
    VAT110 = "vat110"       # НДС 10/110
    VAT120 = "vat120"       # НДС 20/120

class SNOType(str, Enum):
    """Системы налогообложения"""
    OSN = "osn"                     # Общая
    USN_INCOME = "usn_income"       # УСН доходы
    USN_INCOME_OUTCOME = "usn_income_outcome"  # УСН доходы-расходы
    ENVD = "envd"                   # ЕНВД
    ESN = "esn"                     # ЕСН
    PATENT = "patent"               # Патент

class PaymentMethod(str, Enum):
    """Способы расчёта"""
    FULL_PAYMENT = "full_payment"           # Полный расчёт
    FULL_PREPAYMENT = "full_prepayment"     # 100% предоплата
    PREPAYMENT = "prepayment"               # Предоплата
    ADVANCE = "advance"                     # Аванс
    PARTIAL_PAYMENT = "partial_payment"     # Частичный расчёт

class PaymentObject(str, Enum):
    """Предмет расчёта"""
    COMMODITY = "commodity"         # Товар
    EXCISE = "excise"              # Подакцизный товар
    JOB = "job"                    # Работа
    SERVICE = "service"            # Услуга
    PAYMENT = "payment"            # Платёж
    ANOTHER = "another"            # Иное

@dataclass
class ReceiptItem:
    """Позиция чека"""
    name: str                                   # Название (max 128 chars)
    quantity: int | float                       # Количество
    sum: Decimal                                # Сумма в рублях
    tax: TaxType = TaxType.NONE                # НДС
    payment_method: PaymentMethod = PaymentMethod.FULL_PAYMENT
    payment_object: PaymentObject = PaymentObject.SERVICE

    def to_dict(self) -> dict:
        """Convert to Robokassa format"""
        return {
            "name": self.name[:128],
            "quantity": self.quantity,
            "sum": float(self.sum),
            "tax": self.tax.value,
            "payment_method": self.payment_method.value,
            "payment_object": self.payment_object.value,
        }

@dataclass
class Receipt:
    """Чек для Robokassa"""
    items: list[ReceiptItem] = field(default_factory=list)
    sno: SNOType = SNOType.USN_INCOME

    def add_item(
        self,
        name: str,
        quantity: int | float,
        sum: Decimal,
        tax: TaxType = TaxType.NONE,
    ) -> "Receipt":
        """Add item to receipt"""
        self.items.append(ReceiptItem(
            name=name,
            quantity=quantity,
            sum=sum,
            tax=tax,
        ))
        return self

    def to_json(self) -> str:
        """Convert to JSON string for Robokassa"""
        data = {
            "sno": self.sno.value,
            "items": [item.to_dict() for item in self.items],
        }
        return json.dumps(data, ensure_ascii=False)

    def to_url_encoded(self) -> str:
        """Convert to URL-encoded JSON for payment URL"""
        return quote(self.to_json())

def create_tariff_receipt(
    tariff_name: str,
    amount: Decimal,
    sno: SNOType = SNOType.USN_INCOME,
    tax: TaxType = TaxType.NONE,
) -> Receipt:
    """
    Create receipt for tariff purchase.

    Args:
        tariff_name: Tariff name for receipt
        amount: Payment amount
        sno: Tax system
        tax: VAT type

    Returns:
        Receipt ready for Robokassa
    """
    receipt = Receipt(sno=sno)
    receipt.add_item(
        name=f"Оплата тарифа: {tariff_name}",
        quantity=1,
        sum=amount,
        tax=tax,
    )
    return receipt
```

**DoD:**
- [ ] Receipt dataclass с всеми полями
- [ ] ReceiptItem с типами оплаты/объекта
- [ ] Enums для SNO и Tax
- [ ] JSON сериализация
- [ ] URL encoding

---

### T6.4.2 — Provider receipt integration

**Описание:** Интегрировать чеки в RobokassaPaymentProvider.

**Обновление provider.py:**
```python
from payments.providers.robokassa.receipt import (
    Receipt,
    create_tariff_receipt,
    SNOType,
    TaxType,
)

class RobokassaPaymentProvider(PaymentProvider):
    def __init__(
        self,
        merchant_login: str,
        password_1: str,
        password_2: str,
        is_test: bool = True,
        receipt_enabled: bool = False,
        receipt_sno: SNOType = SNOType.USN_INCOME,
        receipt_tax: TaxType = TaxType.NONE,
    ):
        # ... existing init ...
        self.receipt_enabled = receipt_enabled
        self.receipt_sno = receipt_sno
        self.receipt_tax = receipt_tax

    def generate_payment_url(self, invoice: Invoice) -> str:
        """Generate payment URL with optional receipt"""
        shp_params = {
            "Shp_invoice_id": str(invoice.id),
            "Shp_user_id": str(invoice.user_id),
        }

        # Create receipt if enabled
        receipt_json = None
        if self.receipt_enabled:
            receipt = create_tariff_receipt(
                tariff_name=self._get_tariff_name(invoice),
                amount=invoice.amount,
                sno=self.receipt_sno,
                tax=self.receipt_tax,
            )
            receipt_json = receipt.to_json()

        # Generate signature (includes receipt if present)
        signature = generate_init_signature(
            merchant_login=self.merchant_login,
            out_sum=invoice.amount,
            inv_id=invoice.inv_id,
            password=self.password_1,
            shp_params=shp_params,
            receipt=receipt_json,
        )

        # Build URL
        builder = RobokassaURLBuilder(
            merchant_login=self.merchant_login,
            out_sum=invoice.amount,
            inv_id=invoice.inv_id,
            description=self._get_description(invoice),
            signature=signature,
            is_test=self.is_test,
            shp_params=shp_params,
            receipt=receipt_json,
        )

        return builder.build()

    def _get_tariff_name(self, invoice: Invoice) -> str:
        """Get tariff name for receipt"""
        # TODO: Load from tariff or store in invoice
        return f"Тариф #{invoice.inv_id}"
```

**Обновление factory:**
```python
def _create_robokassa_provider() -> RobokassaPaymentProvider:
    """Create Robokassa with receipt support"""
    return RobokassaPaymentProvider(
        merchant_login=settings.ROBOKASSA_MERCHANT_LOGIN,
        password_1=settings.ROBOKASSA_PASSWORD_1,
        password_2=settings.ROBOKASSA_PASSWORD_2,
        is_test=settings.ROBOKASSA_IS_TEST,
        receipt_enabled=settings.ROBOKASSA_RECEIPT_ENABLED,
        receipt_sno=SNOType(settings.ROBOKASSA_RECEIPT_SNO),
        receipt_tax=TaxType(settings.ROBOKASSA_RECEIPT_TAX),
    )
```

**DoD:**
- [ ] Receipt создаётся при ROBOKASSA_RECEIPT_ENABLED=true
- [ ] Receipt включается в signature
- [ ] Receipt передаётся в URL
- [ ] SNO и Tax настраиваются через env
- [ ] Unit-тесты
