# E6.1 — Robokassa Provider

## Описание

Реализация RobokassaPaymentProvider с полной поддержкой API Robokassa.

---

## Tasks

### T6.1.1 — Robokassa provider implementation

**Описание:** Создать провайдер для интеграции с Robokassa.

**Файл:** `backend/src/payments/providers/robokassa/provider.py`

**Реализация:**
```python
from decimal import Decimal
from urllib.parse import urlencode
from uuid import UUID
from datetime import datetime, timedelta

from payments.providers.base import PaymentProvider
from payments.schemas import WebhookData
from payments.providers.robokassa.signature import (
    generate_init_signature,
    generate_result_signature,
)
from db.models.invoice import Invoice
from core.config import settings

class RobokassaPaymentProvider(PaymentProvider):
    """
    Robokassa payment provider.

    Documentation: https://docs.robokassa.ru/
    """

    # Robokassa URLs
    PAYMENT_URL = "https://auth.robokassa.ru/Merchant/Index.aspx"
    TEST_PAYMENT_URL = "https://auth.robokassa.ru/Merchant/Index.aspx"

    def __init__(
        self,
        merchant_login: str,
        password_1: str,
        password_2: str,
        is_test: bool = True,
    ):
        self.merchant_login = merchant_login
        self.password_1 = password_1
        self.password_2 = password_2
        self.is_test = is_test

    def generate_payment_url(self, invoice: Invoice) -> str:
        """
        Generate Robokassa payment URL.

        URL format:
        https://auth.robokassa.ru/Merchant/Index.aspx?
            MerchantLogin={login}
            &OutSum={amount}
            &InvId={inv_id}
            &Description={description}
            &SignatureValue={signature}
            &IsTest=1
            &Shp_invoice_id={uuid}
            &Shp_user_id={telegram_id}
        """
        # Custom parameters (Shp_*)
        shp_params = {
            "Shp_invoice_id": str(invoice.id),
            "Shp_user_id": str(invoice.user_id),
        }

        # Generate signature
        signature = generate_init_signature(
            merchant_login=self.merchant_login,
            out_sum=invoice.amount,
            inv_id=invoice.inv_id,
            password=self.password_1,
            shp_params=shp_params,
        )

        # Build URL parameters
        params = {
            "MerchantLogin": self.merchant_login,
            "OutSum": f"{invoice.amount:.2f}",
            "InvId": str(invoice.inv_id),
            "Description": self._get_description(invoice),
            "SignatureValue": signature,
            "Culture": "ru",
            "Encoding": "utf-8",
        }

        # Add test mode flag
        if self.is_test:
            params["IsTest"] = "1"

        # Add custom parameters
        params.update(shp_params)

        return f"{self.PAYMENT_URL}?{urlencode(params)}"

    def verify_result_signature(self, data: WebhookData) -> bool:
        """Verify ResultURL callback signature"""
        shp_params = {
            "Shp_invoice_id": str(data.shp_invoice_id),
            "Shp_user_id": str(data.shp_user_id),
        }

        expected = generate_result_signature(
            out_sum=data.out_sum,
            inv_id=data.inv_id,
            password=self.password_2,
            shp_params=shp_params,
        )

        return data.signature.lower() == expected.lower()

    def parse_webhook(self, raw_data: dict) -> WebhookData:
        """Parse Robokassa webhook data"""
        return WebhookData(
            out_sum=Decimal(raw_data["OutSum"]),
            inv_id=int(raw_data["InvId"]),
            signature=raw_data["SignatureValue"],
            shp_invoice_id=UUID(raw_data["Shp_invoice_id"]),
            shp_user_id=int(raw_data["Shp_user_id"]),
            fee=Decimal(raw_data["Fee"]) if "Fee" in raw_data else None,
            email=raw_data.get("EMail"),
            payment_method=raw_data.get("PaymentMethod"),
        )

    def format_success_response(self, inv_id: int) -> str:
        """Return OK{InvId} as required by Robokassa"""
        return f"OK{inv_id}"

    def get_provider_name(self) -> str:
        return "robokassa"

    def _get_description(self, invoice: Invoice) -> str:
        """Generate payment description (max 100 chars)"""
        description = f"Оплата счёта #{invoice.inv_id}"
        return description[:100]
```

**DoD:**
- [ ] Все методы интерфейса реализованы
- [ ] URL генерируется согласно документации
- [ ] Тестовый режим поддерживается
- [ ] Description ограничен 100 символами

---

### T6.1.2 — Payment URL builder

**Описание:** Создать builder для гибкого построения URL.

**Файл:** `backend/src/payments/providers/robokassa/url_builder.py`

**Реализация:**
```python
from dataclasses import dataclass, field
from decimal import Decimal
from datetime import datetime
from urllib.parse import urlencode
from typing import Any

@dataclass
class RobokassaURLBuilder:
    """
    Builder for Robokassa payment URLs.

    Supports all optional parameters:
    - Receipt (54-ФЗ)
    - Expiration date
    - Email
    - Custom parameters (Shp_*)
    """
    merchant_login: str
    out_sum: Decimal
    inv_id: int
    description: str
    signature: str

    # Optional
    culture: str = "ru"
    encoding: str = "utf-8"
    email: str | None = None
    expiration_date: datetime | None = None
    is_test: bool = False
    receipt: str | None = None  # JSON receipt for 54-ФЗ

    # Custom parameters
    shp_params: dict[str, str] = field(default_factory=dict)

    BASE_URL = "https://auth.robokassa.ru/Merchant/Index.aspx"

    def build(self) -> str:
        """Build complete payment URL"""
        params = self._build_params()
        return f"{self.BASE_URL}?{urlencode(params)}"

    def _build_params(self) -> dict[str, str]:
        """Build URL parameters dict"""
        params = {
            "MerchantLogin": self.merchant_login,
            "OutSum": f"{self.out_sum:.2f}",
            "InvId": str(self.inv_id),
            "Description": self.description[:100],
            "SignatureValue": self.signature,
            "Culture": self.culture,
            "Encoding": self.encoding,
        }

        if self.email:
            params["Email"] = self.email

        if self.expiration_date:
            params["ExpirationDate"] = self.expiration_date.isoformat()

        if self.is_test:
            params["IsTest"] = "1"

        if self.receipt:
            params["Receipt"] = self.receipt

        # Add custom parameters (sorted alphabetically)
        for key, value in sorted(self.shp_params.items()):
            params[key] = value

        return params
```

**DoD:**
- [ ] Builder поддерживает все параметры Robokassa
- [ ] Receipt параметр для 54-ФЗ
- [ ] Expiration date
- [ ] Unit-тесты
