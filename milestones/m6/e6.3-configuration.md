# E6.3 — Configuration & Factory

## Описание

Настройка конфигурации для Robokassa и обновление factory для переключения провайдеров.

---

## Tasks

### T6.3.1 — Robokassa configuration

**Описание:** Добавить настройки Robokassa в конфигурацию.

**Файл:** `backend/src/core/config.py` (обновление)

**Добавления:**
```python
from typing import Literal
from pydantic import Field, field_validator
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # ... existing settings ...

    # Payment provider selection
    PAYMENT_PROVIDER: Literal["mock", "robokassa"] = "mock"

    # Robokassa settings
    ROBOKASSA_MERCHANT_LOGIN: str = ""
    ROBOKASSA_PASSWORD_1: str = ""
    ROBOKASSA_PASSWORD_2: str = ""
    ROBOKASSA_IS_TEST: bool = True

    # Robokassa URLs (optional overrides)
    ROBOKASSA_RESULT_URL: str | None = None  # ResultURL callback
    ROBOKASSA_SUCCESS_URL: str | None = None  # Redirect on success
    ROBOKASSA_FAIL_URL: str | None = None     # Redirect on failure

    # Receipt settings (54-ФЗ)
    ROBOKASSA_RECEIPT_ENABLED: bool = False
    ROBOKASSA_RECEIPT_SNO: str = "usn_income"  # Система налогообложения
    ROBOKASSA_RECEIPT_TAX: str = "none"        # НДС

    @field_validator("ROBOKASSA_MERCHANT_LOGIN", "ROBOKASSA_PASSWORD_1", "ROBOKASSA_PASSWORD_2")
    @classmethod
    def validate_robokassa_required(cls, v, info):
        """Validate Robokassa credentials when provider is robokassa"""
        # Validation happens at runtime when provider is selected
        return v

    def get_robokassa_result_url(self) -> str:
        """Get ResultURL for Robokassa callbacks"""
        if self.ROBOKASSA_RESULT_URL:
            return self.ROBOKASSA_RESULT_URL
        return f"{self.WEBHOOK_BASE_URL}/webhook/robokassa"

    def get_robokassa_success_url(self) -> str | None:
        """Get SuccessURL for redirect after payment"""
        return self.ROBOKASSA_SUCCESS_URL

    def get_robokassa_fail_url(self) -> str | None:
        """Get FailURL for redirect after cancel"""
        return self.ROBOKASSA_FAIL_URL

    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"

settings = Settings()
```

**.env.example обновление:**
```env
# Payment Provider
PAYMENT_PROVIDER=mock  # mock or robokassa

# Robokassa Credentials
ROBOKASSA_MERCHANT_LOGIN=your_login
ROBOKASSA_PASSWORD_1=your_password_1
ROBOKASSA_PASSWORD_2=your_password_2
ROBOKASSA_IS_TEST=true

# Robokassa URLs (optional)
ROBOKASSA_RESULT_URL=
ROBOKASSA_SUCCESS_URL=
ROBOKASSA_FAIL_URL=

# Receipt (54-ФЗ)
ROBOKASSA_RECEIPT_ENABLED=false
ROBOKASSA_RECEIPT_SNO=usn_income
ROBOKASSA_RECEIPT_TAX=none
```

**DoD:**
- [ ] Все настройки Robokassa в Settings
- [ ] Валидация credentials
- [ ] Helper методы для URL
- [ ] .env.example обновлён

---

### T6.3.2 — Provider factory update

**Описание:** Обновить factory для поддержки Robokassa.

**Файл:** `backend/src/payments/providers/__init__.py` (обновление)

**Реализация:**
```python
from typing import Literal
import logging

from payments.providers.base import PaymentProvider
from payments.providers.mock.provider import MockPaymentProvider
from payments.providers.robokassa.provider import RobokassaPaymentProvider
from core.config import settings

logger = logging.getLogger(__name__)

# Cached provider instances
_provider_instances: dict[str, PaymentProvider] = {}

def get_payment_provider(
    provider_name: Literal["mock", "robokassa"] | None = None
) -> PaymentProvider:
    """
    Get payment provider instance.

    Args:
        provider_name: Provider name. If None, uses PAYMENT_PROVIDER from settings.

    Returns:
        Configured PaymentProvider instance

    Raises:
        ValueError: Unknown provider name
        RuntimeError: Missing configuration for selected provider
    """
    name = provider_name or settings.PAYMENT_PROVIDER

    # Return cached instance if exists
    if name in _provider_instances:
        return _provider_instances[name]

    logger.info(f"Creating payment provider: {name}")

    # Create provider based on name
    if name == "mock":
        provider = _create_mock_provider()
    elif name == "robokassa":
        provider = _create_robokassa_provider()
    else:
        raise ValueError(f"Unknown payment provider: {name}")

    # Cache and return
    _provider_instances[name] = provider
    return provider


def _create_mock_provider() -> MockPaymentProvider:
    """Create mock payment provider"""
    return MockPaymentProvider(
        merchant_login=settings.MOCK_MERCHANT_LOGIN,
        password_1=settings.MOCK_PASSWORD_1,
        password_2=settings.MOCK_PASSWORD_2,
        base_url=settings.WEBHOOK_BASE_URL,
    )


def _create_robokassa_provider() -> RobokassaPaymentProvider:
    """Create Robokassa payment provider"""
    # Validate required settings
    if not settings.ROBOKASSA_MERCHANT_LOGIN:
        raise RuntimeError("ROBOKASSA_MERCHANT_LOGIN is required")
    if not settings.ROBOKASSA_PASSWORD_1:
        raise RuntimeError("ROBOKASSA_PASSWORD_1 is required")
    if not settings.ROBOKASSA_PASSWORD_2:
        raise RuntimeError("ROBOKASSA_PASSWORD_2 is required")

    return RobokassaPaymentProvider(
        merchant_login=settings.ROBOKASSA_MERCHANT_LOGIN,
        password_1=settings.ROBOKASSA_PASSWORD_1,
        password_2=settings.ROBOKASSA_PASSWORD_2,
        is_test=settings.ROBOKASSA_IS_TEST,
    )


def clear_provider_cache() -> None:
    """Clear cached provider instances (for testing)"""
    _provider_instances.clear()


def validate_provider_config(provider_name: str) -> list[str]:
    """
    Validate configuration for provider.

    Returns:
        List of missing/invalid settings
    """
    errors = []

    if provider_name == "robokassa":
        if not settings.ROBOKASSA_MERCHANT_LOGIN:
            errors.append("ROBOKASSA_MERCHANT_LOGIN is required")
        if not settings.ROBOKASSA_PASSWORD_1:
            errors.append("ROBOKASSA_PASSWORD_1 is required")
        if not settings.ROBOKASSA_PASSWORD_2:
            errors.append("ROBOKASSA_PASSWORD_2 is required")

    return errors
```

**DoD:**
- [ ] Factory создаёт RobokassaPaymentProvider
- [ ] Валидация required settings
- [ ] Понятные ошибки при отсутствии config
- [ ] validate_provider_config для проверки перед запуском
