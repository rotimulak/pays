# E7.5 — Admin CLI

## Описание

CLI скрипт для управления промокодами.

---

## Tasks

### T7.5.1 — Promo management script

**Описание:** Создать CLI для создания и управления промокодами.

**Файл:** `backend/scripts/manage_promos.py`

**Реализация:**
```python
"""
CLI for promo code management.

Usage:
    # Create percent discount
    python -m scripts.manage_promos create SALE20 --type percent --value 20

    # Create fixed discount
    python -m scripts.manage_promos create FIXED100 --type fixed --value 100

    # Create bonus tokens
    python -m scripts.manage_promos create BONUS50 --type bonus_tokens --value 50

    # With options
    python -m scripts.manage_promos create VIP --type percent --value 30 \
        --max-uses 100 \
        --valid-until 2024-12-31 \
        --tariff premium

    # List promos
    python -m scripts.manage_promos list
    python -m scripts.manage_promos list --active

    # Show promo details
    python -m scripts.manage_promos show SALE20

    # Deactivate promo
    python -m scripts.manage_promos deactivate SALE20

    # Stats
    python -m scripts.manage_promos stats SALE20
"""

import asyncio
import argparse
from datetime import datetime
from decimal import Decimal
from uuid import uuid4

from db.session import async_session_factory
from db.models.promo_code import PromoCode, DiscountType
from db.repositories.promo_code_repository import PromoCodeRepository
from db.repositories.tariff_repository import TariffRepository

async def create_promo(args) -> None:
    """Create new promo code"""
    async with async_session_factory() as session:
        repo = PromoCodeRepository(session)

        # Check if exists
        existing = await repo.get_by_code(args.code)
        if existing:
            print(f"❌ Promo code '{args.code}' already exists")
            return

        # Get tariff if specified
        tariff_id = None
        if args.tariff:
            tariff_repo = TariffRepository(session)
            tariff = await tariff_repo.get_by_slug(args.tariff)
            if not tariff:
                print(f"❌ Tariff '{args.tariff}' not found")
                return
            tariff_id = tariff.id

        # Parse dates
        valid_from = None
        if args.valid_from:
            valid_from = datetime.fromisoformat(args.valid_from)

        valid_until = None
        if args.valid_until:
            valid_until = datetime.fromisoformat(args.valid_until)

        # Create promo
        promo = PromoCode(
            id=uuid4(),
            code=args.code.upper(),
            discount_type=DiscountType(args.type),
            discount_value=Decimal(str(args.value)),
            max_uses=args.max_uses,
            uses_count=0,
            valid_from=valid_from,
            valid_until=valid_until,
            tariff_id=tariff_id,
            is_active=True,
        )

        await repo.create(promo)
        await session.commit()

        print(f"✅ Created promo code: {promo.code}")
        print(f"   Type: {promo.discount_type.value}")
        print(f"   Value: {promo.discount_value}")
        if promo.max_uses:
            print(f"   Max uses: {promo.max_uses}")
        if promo.valid_until:
            print(f"   Valid until: {promo.valid_until}")

async def list_promos(args) -> None:
    """List promo codes"""
    async with async_session_factory() as session:
        repo = PromoCodeRepository(session)

        if args.active:
            promos = await repo.get_active()
        else:
            # Get all (need to add method)
            promos = await repo.get_active()  # TODO: get_all

        if not promos:
            print("No promo codes found")
            return

        print(f"{'Code':<15} {'Type':<12} {'Value':<10} {'Uses':<10} {'Status':<10}")
        print("-" * 60)

        for p in promos:
            uses = f"{p.uses_count}/{p.max_uses}" if p.max_uses else str(p.uses_count)
            status = "Active" if p.is_active else "Inactive"
            print(f"{p.code:<15} {p.discount_type.value:<12} {p.discount_value:<10} {uses:<10} {status:<10}")

async def show_promo(args) -> None:
    """Show promo code details"""
    async with async_session_factory() as session:
        repo = PromoCodeRepository(session)
        promo = await repo.get_by_code(args.code)

        if not promo:
            print(f"❌ Promo code '{args.code}' not found")
            return

        print(f"Code: {promo.code}")
        print(f"ID: {promo.id}")
        print(f"Type: {promo.discount_type.value}")
        print(f"Value: {promo.discount_value}")
        print(f"Uses: {promo.uses_count}/{promo.max_uses or '∞'}")
        print(f"Active: {promo.is_active}")
        print(f"Valid from: {promo.valid_from or 'N/A'}")
        print(f"Valid until: {promo.valid_until or 'N/A'}")
        print(f"Tariff: {promo.tariff_id or 'Any'}")
        print(f"Created: {promo.created_at}")

async def deactivate_promo(args) -> None:
    """Deactivate promo code"""
    async with async_session_factory() as session:
        repo = PromoCodeRepository(session)
        promo = await repo.get_by_code(args.code)

        if not promo:
            print(f"❌ Promo code '{args.code}' not found")
            return

        await repo.deactivate(promo.id)
        await session.commit()
        print(f"✅ Deactivated promo code: {args.code}")

def main():
    parser = argparse.ArgumentParser(description="Promo code management")
    subparsers = parser.add_subparsers(dest="command", required=True)

    # Create
    create_parser = subparsers.add_parser("create", help="Create promo code")
    create_parser.add_argument("code", help="Promo code (will be uppercased)")
    create_parser.add_argument("--type", "-t", required=True,
                               choices=["percent", "fixed", "bonus_tokens"])
    create_parser.add_argument("--value", "-v", type=float, required=True,
                               help="Discount value")
    create_parser.add_argument("--max-uses", "-m", type=int,
                               help="Maximum uses limit")
    create_parser.add_argument("--valid-from", help="Start date (ISO format)")
    create_parser.add_argument("--valid-until", help="End date (ISO format)")
    create_parser.add_argument("--tariff", help="Restrict to tariff slug")

    # List
    list_parser = subparsers.add_parser("list", help="List promo codes")
    list_parser.add_argument("--active", "-a", action="store_true",
                             help="Show only active")

    # Show
    show_parser = subparsers.add_parser("show", help="Show promo details")
    show_parser.add_argument("code", help="Promo code")

    # Deactivate
    deact_parser = subparsers.add_parser("deactivate", help="Deactivate promo")
    deact_parser.add_argument("code", help="Promo code")

    args = parser.parse_args()

    if args.command == "create":
        asyncio.run(create_promo(args))
    elif args.command == "list":
        asyncio.run(list_promos(args))
    elif args.command == "show":
        asyncio.run(show_promo(args))
    elif args.command == "deactivate":
        asyncio.run(deactivate_promo(args))

if __name__ == "__main__":
    main()
```

**DoD:**
- [ ] create с всеми опциями
- [ ] list с фильтрацией
- [ ] show детали промокода
- [ ] deactivate для отключения
- [ ] Понятный вывод
