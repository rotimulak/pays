# E7.4 ‚Äî Bot Handlers

## –û–ø–∏—Å–∞–Ω–∏–µ

FSM –∏ handlers –¥–ª—è –≤–≤–æ–¥–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤.

---

## Tasks

### T7.4.1 ‚Äî Promo FSM states

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å FSM –¥–ª—è –≤–≤–æ–¥–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞.

**–§–∞–π–ª:** `backend/src/bot/states/promo.py`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
from aiogram.fsm.state import State, StatesGroup

class PromoStates(StatesGroup):
    """FSM states for promo code input"""

    waiting_for_code = State()
    """User should enter promo code"""

    confirming_purchase = State()
    """User confirms purchase with applied promo"""
```

**–§–∞–π–ª:** `backend/src/bot/handlers/promo.py`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
from aiogram import Router, F
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.types import Message, CallbackQuery

from sqlalchemy.ext.asyncio import AsyncSession

from bot.states.promo import PromoStates
from bot.keyboards.promo import (
    get_promo_input_keyboard,
    get_promo_result_keyboard,
)
from services.promo_service import PromoService
from services.invoice_service import InvoiceService
from core.exceptions import ValidationError

router = Router()

@router.callback_query(F.data.startswith("apply_promo:"))
async def start_promo_input(
    callback: CallbackQuery,
    state: FSMContext,
) -> None:
    """
    Start promo code input flow.
    Callback data: apply_promo:{tariff_id}
    """
    tariff_id = callback.data.split(":")[1]

    await state.update_data(tariff_id=tariff_id)
    await state.set_state(PromoStates.waiting_for_code)

    await callback.message.edit_text(
        "üéü –í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥:\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ–º –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–û—Ç–º–µ–Ω–∞¬ª",
        reply_markup=get_promo_input_keyboard(),
    )
    await callback.answer()

@router.message(PromoStates.waiting_for_code)
async def process_promo_code(
    message: Message,
    state: FSMContext,
    session: AsyncSession,
) -> None:
    """Process entered promo code"""
    code = message.text.strip().upper()
    data = await state.get_data()
    tariff_id = data.get("tariff_id")

    promo_service = PromoService(session)
    invoice_service = InvoiceService(session)

    try:
        # Validate and preview
        preview = await invoice_service.preview_invoice(
            user_id=message.from_user.id,
            tariff_id=tariff_id,
            promo_code=code,
        )

        # Save promo code in state
        await state.update_data(promo_code=code)

        # Show result
        text = format_promo_result(preview, code)
        keyboard = get_promo_result_keyboard(tariff_id, has_promo=True)

        await message.answer(text, reply_markup=keyboard)
        await state.set_state(PromoStates.confirming_purchase)

    except ValidationError as e:
        # Invalid promo code
        await message.answer(
            f"‚ùå {e.message}\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø—Ä–æ–º–æ–∫–æ–¥ –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ –±–µ–∑ —Å–∫–∏–¥–∫–∏.",
            reply_markup=get_promo_input_keyboard(show_skip=True),
        )

@router.callback_query(F.data == "cancel_promo")
async def cancel_promo_input(
    callback: CallbackQuery,
    state: FSMContext,
) -> None:
    """Cancel promo code input"""
    await state.clear()
    await callback.message.edit_text(
        "–í–≤–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –æ—Ç–º–µ–Ω—ë–Ω.",
    )
    await callback.answer()

@router.callback_query(F.data == "skip_promo")
async def skip_promo(
    callback: CallbackQuery,
    state: FSMContext,
) -> None:
    """Continue without promo code"""
    data = await state.get_data()
    tariff_id = data.get("tariff_id")

    # Clear promo from state
    await state.update_data(promo_code=None)

    # Redirect to payment
    # ... continue to buy flow

def format_promo_result(preview, code: str) -> str:
    """Format promo code result message"""
    lines = [f"‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ <b>{code}</b> –ø—Ä–∏–º–µ–Ω—ë–Ω!\n"]

    if preview.has_discount:
        lines.append(
            f"üí∞ –¶–µ–Ω–∞: <s>{preview.original_amount_display}</s> ‚Üí "
            f"<b>{preview.final_amount_display}</b>"
        )

        if preview.discount_info:
            lines.append(f"üéÅ {preview.discount_info}")

        if preview.bonus_tokens > 0:
            lines.append(f"üé´ +{preview.bonus_tokens} –±–æ–Ω—É—Å–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤")

    lines.append(f"\nüì¶ {preview.tariff_name}")
    lines.append(f"üé´ {preview.tokens} —Ç–æ–∫–µ–Ω–æ–≤")

    if preview.subscription_days > 0:
        lines.append(f"üìÖ {preview.subscription_days} –¥–Ω–µ–π –ø–æ–¥–ø–∏—Å–∫–∏")

    return "\n".join(lines)
```

**DoD:**
- [ ] FSM states –¥–ª—è –≤–≤–æ–¥–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞
- [ ] Handler –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–¥–∞
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ –æ—à–∏–±–∫–∞–º–∏
- [ ] –û—Ç–º–µ–Ω–∞ –∏ –ø—Ä–æ–ø—É—Å–∫ –ø—Ä–æ–º–æ–∫–æ–¥–∞
- [ ] –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

---

### T7.4.2 ‚Äî Promo keyboards

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤.

**–§–∞–π–ª:** `backend/src/bot/keyboards/promo.py`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
from aiogram.types import InlineKeyboardMarkup
from aiogram.utils.keyboard import InlineKeyboardBuilder
from uuid import UUID

def get_promo_input_keyboard(show_skip: bool = False) -> InlineKeyboardMarkup:
    """Keyboard for promo code input state"""
    builder = InlineKeyboardBuilder()

    if show_skip:
        builder.button(text="‚è≠ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –ø—Ä–æ–º–æ–∫–æ–¥–∞", callback_data="skip_promo")

    builder.button(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_promo")
    builder.adjust(1)

    return builder.as_markup()

def get_promo_result_keyboard(
    tariff_id: str,
    has_promo: bool = False,
) -> InlineKeyboardMarkup:
    """Keyboard after promo code validation"""
    builder = InlineKeyboardBuilder()

    builder.button(
        text="üí≥ –û–ø–ª–∞—Ç–∏—Ç—å",
        callback_data=f"confirm_purchase:{tariff_id}",
    )

    if has_promo:
        builder.button(
            text="üîÑ –î—Ä—É–≥–æ–π –ø—Ä–æ–º–æ–∫–æ–¥",
            callback_data=f"apply_promo:{tariff_id}",
        )
        builder.button(
            text="‚ùå –£–±—Ä–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥",
            callback_data=f"remove_promo:{tariff_id}",
        )

    builder.button(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="show_tariffs")
    builder.adjust(1)

    return builder.as_markup()

def get_tariff_keyboard_with_promo(
    tariff_id: UUID,
    payment_url: str,
    amount_display: str,
) -> InlineKeyboardMarkup:
    """Payment keyboard with promo option"""
    builder = InlineKeyboardBuilder()

    # Pay button
    builder.button(
        text=f"üí≥ –û–ø–ª–∞—Ç–∏—Ç—å {amount_display}",
        url=payment_url,
    )

    # Promo button
    builder.button(
        text="üéü –í–≤–µ—Å—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥",
        callback_data=f"apply_promo:{tariff_id}",
    )

    builder.button(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_invoice")
    builder.adjust(1)

    return builder.as_markup()
```

**DoD:**
- [ ] Keyboard –¥–ª—è –≤–≤–æ–¥–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞
- [ ] Keyboard –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
- [ ] –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –≤ payment keyboard
- [ ] –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥
