# E7.2 — Promo Service

## Описание

Сервис для валидации промокодов и расчёта скидок.

---

## Tasks

### T7.2.1 — Promo service implementation

**Описание:** Создать сервис для работы с промокодами.

**Файл:** `backend/src/services/promo_service.py`

**Реализация:**
```python
from uuid import UUID
from decimal import Decimal
from dataclasses import dataclass

from sqlalchemy.ext.asyncio import AsyncSession

from db.repositories.promo_code_repository import PromoCodeRepository
from db.models.promo_code import PromoCode, DiscountType
from core.exceptions import ValidationError

@dataclass
class DiscountResult:
    """Result of discount calculation"""
    original_amount: Decimal
    final_amount: Decimal
    discount_amount: Decimal
    bonus_tokens: int
    promo_code: PromoCode
    description: str  # "Скидка 20%" или "50 ₽ скидка"

class PromoService:
    """Service for promo code operations"""

    def __init__(self, session: AsyncSession):
        self.session = session
        self.promo_repo = PromoCodeRepository(session)

    async def validate_promo(
        self,
        code: str,
        tariff_id: UUID | None = None,
    ) -> PromoCode:
        """
        Validate promo code and return it.

        Args:
            code: Promo code string
            tariff_id: Optional tariff to validate against

        Returns:
            Valid PromoCode

        Raises:
            ValidationError: If promo code is invalid
        """
        promo, error = await self.promo_repo.can_use(code, tariff_id)

        if error:
            raise ValidationError(error)

        return promo

    async def calculate_discount(
        self,
        code: str,
        original_amount: Decimal,
        tariff_id: UUID | None = None,
    ) -> DiscountResult:
        """
        Calculate discount for promo code.

        Args:
            code: Promo code string
            original_amount: Original price
            tariff_id: Tariff ID for validation

        Returns:
            DiscountResult with calculated values

        Raises:
            ValidationError: If promo code is invalid
        """
        promo = await self.validate_promo(code, tariff_id)

        final_amount, bonus_tokens, description = self._apply_discount(
            promo, original_amount
        )

        return DiscountResult(
            original_amount=original_amount,
            final_amount=final_amount,
            discount_amount=original_amount - final_amount,
            bonus_tokens=bonus_tokens,
            promo_code=promo,
            description=description,
        )

    def _apply_discount(
        self,
        promo: PromoCode,
        amount: Decimal,
    ) -> tuple[Decimal, int, str]:
        """
        Apply discount to amount.

        Returns:
            (final_amount, bonus_tokens, description)
        """
        bonus_tokens = 0

        match promo.discount_type:
            case DiscountType.PERCENT:
                discount = amount * promo.discount_value / 100
                final = amount - discount
                description = f"Скидка {int(promo.discount_value)}%"

            case DiscountType.FIXED:
                # Minimum amount is 1 ruble
                final = max(amount - promo.discount_value, Decimal("1.00"))
                actual_discount = amount - final
                description = f"Скидка {actual_discount:.0f} ₽"

            case DiscountType.BONUS_TOKENS:
                final = amount
                bonus_tokens = int(promo.discount_value)
                description = f"+{bonus_tokens} бонусных токенов"

            case _:
                final = amount
                description = ""

        # Round to 2 decimal places
        final = final.quantize(Decimal("0.01"))

        return final, bonus_tokens, description

    async def use_promo(self, promo_id: UUID) -> int:
        """
        Mark promo code as used.

        Returns:
            New uses_count
        """
        return await self.promo_repo.increment_uses(promo_id)
```

**DoD:**
- [ ] validate_promo с понятными ошибками
- [ ] calculate_discount для всех типов скидок
- [ ] use_promo для инкремента счётчика
- [ ] Unit-тесты

---

### T7.2.2 — Discount types implementation

**Описание:** Реализовать все типы скидок.

**Типы скидок:**

| Тип | Описание | Пример |
|-----|----------|--------|
| `percent` | Скидка N% от суммы | 20% от 500₽ = 400₽ |
| `fixed` | Скидка N рублей | 100₽ от 500₽ = 400₽ |
| `bonus_tokens` | Бонусные токены | +50 токенов к покупке |

**Граничные случаи:**
```python
def test_discount_edge_cases():
    # Percent: округление
    # 19.99% от 100₽ = 80.01₽ (не 80.009999...)

    # Fixed: минимальная сумма
    # 200₽ скидка на 150₽ = 1₽ (не отрицательная)

    # Fixed: точное совпадение
    # 100₽ скидка на 100₽ = 1₽ (минимум)

    # Bonus: не влияет на сумму
    # +50 токенов, сумма остаётся 100₽
```

**DoD:**
- [ ] Percent с округлением до копеек
- [ ] Fixed с минимальной суммой 1₽
- [ ] Bonus tokens без изменения суммы
- [ ] Тесты граничных случаев

---

### T7.2.3 — Promo DTOs

**Описание:** Создать DTO для отображения промокодов.

**Файл:** `backend/src/services/dto/promo.py`

**DTOs:**
```python
from pydantic import BaseModel
from uuid import UUID
from datetime import datetime
from decimal import Decimal

from db.models.promo_code import DiscountType

class PromoCodeDTO(BaseModel):
    """DTO for promo code display"""
    id: UUID
    code: str
    discount_type: DiscountType
    discount_value: Decimal
    discount_display: str  # "20%" or "100 ₽" or "+50 токенов"
    max_uses: int | None
    uses_count: int
    uses_left: int | None  # max_uses - uses_count
    valid_from: datetime | None
    valid_until: datetime | None
    tariff_id: UUID | None
    is_active: bool
    is_valid: bool  # Can be used right now

class PromoValidationResult(BaseModel):
    """Result of promo code validation"""
    valid: bool
    error: str | None = None
    promo: PromoCodeDTO | None = None

class DiscountPreviewDTO(BaseModel):
    """Preview of discount before applying"""
    original_amount: Decimal
    original_amount_display: str  # "500 ₽"
    final_amount: Decimal
    final_amount_display: str  # "400 ₽"
    discount_amount: Decimal
    discount_display: str  # "-100 ₽" or "-20%"
    bonus_tokens: int
    promo_description: str  # "Скидка 20% по промокоду SALE20"
```

**DoD:**
- [ ] PromoCodeDTO с форматированием
- [ ] PromoValidationResult для API
- [ ] DiscountPreviewDTO для отображения в боте
