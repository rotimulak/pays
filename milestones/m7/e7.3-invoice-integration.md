# E7.3 — Invoice Integration

## Описание

Интеграция промокодов с InvoiceService.

---

## Tasks

### T7.3.1 — Update InvoiceService

**Описание:** Обновить InvoiceService для поддержки промокодов.

**Файл:** `backend/src/services/invoice_service.py` (обновление)

**Изменения:**
```python
from services.promo_service import PromoService, DiscountResult

class InvoiceService:
    def __init__(self, session: AsyncSession):
        self.session = session
        self.invoice_repo = InvoiceRepository(session)
        self.tariff_repo = TariffRepository(session)
        self.promo_service = PromoService(session)

    async def create_invoice(
        self,
        user_id: int,
        tariff_id: UUID,
        promo_code: str | None = None,
    ) -> Invoice:
        """
        Create invoice with optional promo code.

        Args:
            user_id: Telegram user ID
            tariff_id: Tariff to purchase
            promo_code: Optional promo code string

        Returns:
            Created invoice

        Raises:
            ValidationError: Invalid promo code
            NotFoundError: Tariff not found
        """
        # Get tariff
        tariff = await self.tariff_repo.get_by_id(tariff_id)
        if not tariff:
            raise NotFoundError(f"Tariff {tariff_id} not found")

        # Calculate amount and bonus
        original_amount = tariff.price
        final_amount = original_amount
        bonus_tokens = 0
        promo_code_id = None
        discount_result: DiscountResult | None = None

        # Apply promo code if provided
        if promo_code:
            discount_result = await self.promo_service.calculate_discount(
                code=promo_code,
                original_amount=original_amount,
                tariff_id=tariff_id,
            )
            final_amount = discount_result.final_amount
            bonus_tokens = discount_result.bonus_tokens
            promo_code_id = discount_result.promo_code.id

        # Generate inv_id
        inv_id = await self.invoice_repo.get_next_inv_id()

        # Create invoice
        invoice = Invoice(
            id=uuid4(),
            inv_id=inv_id,
            user_id=user_id,
            tariff_id=tariff_id,
            promo_code_id=promo_code_id,
            amount=final_amount,
            original_amount=original_amount,
            tokens=tariff.tokens + bonus_tokens,
            subscription_days=tariff.subscription_days,
            status=InvoiceStatus.PENDING,
            idempotency_key=self.generate_idempotency_key(user_id, tariff_id),
            expires_at=datetime.utcnow() + timedelta(hours=settings.INVOICE_TTL_HOURS),
        )

        created = await self.invoice_repo.create(invoice)

        # Increment promo usage
        if promo_code_id:
            await self.promo_service.use_promo(promo_code_id)

        return created

    async def preview_invoice(
        self,
        user_id: int,
        tariff_id: UUID,
        promo_code: str | None = None,
    ) -> InvoicePreviewDTO:
        """
        Preview invoice without creating it.
        Used to show price before confirmation.
        """
        tariff = await self.tariff_repo.get_by_id(tariff_id)
        if not tariff:
            raise NotFoundError(f"Tariff {tariff_id} not found")

        original_amount = tariff.price
        final_amount = original_amount
        discount_info = None
        bonus_tokens = 0

        if promo_code:
            try:
                discount_result = await self.promo_service.calculate_discount(
                    code=promo_code,
                    original_amount=original_amount,
                    tariff_id=tariff_id,
                )
                final_amount = discount_result.final_amount
                bonus_tokens = discount_result.bonus_tokens
                discount_info = discount_result.description
            except ValidationError:
                # Invalid promo code - ignore in preview
                pass

        return InvoicePreviewDTO(
            tariff_name=tariff.name,
            original_amount=original_amount,
            final_amount=final_amount,
            discount_info=discount_info,
            tokens=tariff.tokens + bonus_tokens,
            bonus_tokens=bonus_tokens,
            subscription_days=tariff.subscription_days,
        )
```

**DoD:**
- [ ] create_invoice с promo_code
- [ ] preview_invoice для предпросмотра
- [ ] Bonus tokens добавляются к invoice.tokens
- [ ] promo_code_id сохраняется в invoice
- [ ] uses_count инкрементируется

---

### T7.3.2 — Invoice DTO updates

**Описание:** Обновить DTO для отображения скидок.

**Файл:** `backend/src/services/dto/invoice.py` (обновление)

**Добавления:**
```python
class InvoicePreviewDTO(BaseModel):
    """Preview before invoice creation"""
    tariff_name: str
    original_amount: Decimal
    original_amount_display: str  # "500 ₽"
    final_amount: Decimal
    final_amount_display: str  # "400 ₽"
    discount_info: str | None  # "Скидка 20%" or None
    has_discount: bool
    tokens: int
    bonus_tokens: int  # Extra tokens from promo
    subscription_days: int

    @property
    def original_amount_display(self) -> str:
        return f"{self.original_amount:.0f} ₽"

    @property
    def final_amount_display(self) -> str:
        return f"{self.final_amount:.0f} ₽"

    @property
    def has_discount(self) -> bool:
        return self.final_amount < self.original_amount or self.bonus_tokens > 0

class InvoiceDTO(BaseModel):
    """Full invoice DTO"""
    # ... existing fields ...

    # Promo code info
    promo_code_id: UUID | None
    original_amount: Decimal | None
    discount_amount: Decimal | None  # original - final
    discount_display: str | None  # "-100 ₽"
    bonus_tokens: int  # Extra tokens from promo

    def format_amount(self) -> str:
        """Format amount with optional strikethrough original"""
        if self.original_amount and self.original_amount != self.amount:
            return f"<s>{self.original_amount:.0f} ₽</s> → {self.amount:.0f} ₽"
        return f"{self.amount:.0f} ₽"
```

**DoD:**
- [ ] InvoicePreviewDTO для предпросмотра
- [ ] InvoiceDTO с информацией о скидке
- [ ] Форматирование с зачёркнутой ценой
