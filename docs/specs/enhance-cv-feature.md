# –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è: –ê–Ω–∞–ª–∏–∑ CV

> –í–µ—Ä—Å–∏—è: 1.1
> –°—Ç–∞—Ç—É—Å: Draft
> –î–∞—Ç–∞: 2026-01-05

---

## 1. –û–±–∑–æ—Ä

–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã `/cv` –≤ –±–æ—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–∑—é–º–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–π HHH Runner —Å–µ—Ä–≤–∏—Å.

### –ö–ª—é—á–µ–≤—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π —Å–ª–æ–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Runner (–ª–µ–≥–∫–æ –∑–∞–º–µ–Ω—è–µ–º—ã–π)
- –ó–∞–≥—Ä—É–∑–∫–∞ CV –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF –∏–ª–∏ TXT (–¥–æ 1 –ú–ë)
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –Ω–∞ Runner
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç—Ä–∏–º–∏–Ω–≥–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç Runner
- –û—Ç–º–µ–Ω–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –¥—Ä—É–≥—É—é –∫–æ–º–∞–Ω–¥—É

---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 2.1 –°–ª–æ–∏ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     Bot Handlers                            ‚îÇ
‚îÇ  (cv.py - –∫–æ–º–∞–Ω–¥—ã, —Å–æ—Å—Ç–æ—è–Ω–∏—è, UI)                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Service Layer                              ‚îÇ
‚îÇ  CVAnalyzer - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ CV                     ‚îÇ
‚îÇ  (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç RunnerClient)                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Runner Client (Abstract)                   ‚îÇ
‚îÇ  RunnerClient - –±–∞–∑–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –¥–ª—è Runner API              ‚îÇ
‚îÇ  - health_check()                                           ‚îÇ
‚îÇ  - stream_request(endpoint, data) -> AsyncIterator         ‚îÇ
‚îÇ  (–≤ –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –¥—Ä—É–≥—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  HHH Runner API                             ‚îÇ
‚îÇ  http://155.212.245.141:8000                               ‚îÇ
‚îÇ  - GET  /health                                             ‚îÇ
‚îÇ  - POST /analyze-cv (SSE stream)                           ‚îÇ
‚îÇ  - POST /... (–±—É–¥—É—â–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã)                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2.2 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
backend/src/
‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cv.py                 # Handler –¥–ª—è /cv
‚îÇ   ‚îî‚îÄ‚îÄ states/
‚îÇ       ‚îî‚îÄ‚îÄ cv.py                 # FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ runner/
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py           # –≠–∫—Å–ø–æ—Ä—Ç + —Ñ–∞–±—Ä–∏–∫–∞ get_runner_client()
‚îÇ       ‚îú‚îÄ‚îÄ client.py             # RunnerClient (–±–∞–∑–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç)
‚îÇ       ‚îú‚îÄ‚îÄ cv_analyzer.py        # CVAnalyzer (–∞–Ω–∞–ª–∏–∑ CV)
‚îÇ       ‚îî‚îÄ‚îÄ models.py             # StreamMessage, CVFile –∏ –¥—Ä.
‚îî‚îÄ‚îÄ core/
    ‚îî‚îÄ‚îÄ config.py                 # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ runner
```

---

## 3. Runner Client (–±–∞–∑–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç)

### 3.1 client.py

```python
from abc import ABC, abstractmethod
from typing import AsyncIterator
import aiohttp
import asyncio

from .models import StreamMessage


class BaseRunnerClient(ABC):
    """–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –¥–ª—è Runner API.

    –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–º–µ–Ω–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏.
    """

    @abstractmethod
    async def health_check(self) -> tuple[bool, str]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Runner."""
        pass

    @abstractmethod
    async def stream_request(
        self,
        endpoint: str,
        data: aiohttp.FormData,
        user_id: int
    ) -> AsyncIterator[StreamMessage]:
        """–°—Ç—Ä–∏–º–∏–Ω–≥–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ Runner."""
        pass

    @abstractmethod
    async def cancel_stream(self, user_id: int) -> bool:
        """–û—Ç–º–µ–Ω–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —Å—Ç—Ä–∏–º –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        pass


class RunnerClient(BaseRunnerClient):
    """HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è HHH Runner API."""

    def __init__(self, base_url: str, api_key: str):
        self.base_url = base_url
        self.api_key = api_key
        self._cancel_flags: dict[int, asyncio.Event] = {}

    async def health_check(self) -> tuple[bool, str]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ health endpoint."""
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(
                    f"{self.base_url}/health",
                    headers={"X-API-Key": self.api_key},
                    timeout=aiohttp.ClientTimeout(total=10),
                ) as response:
                    if response.status == 200:
                        data = await response.json()
                        status = data.get("status", "unknown")
                        if status == "healthy":
                            return True, "healthy"
                        return False, f"status: {status}"
                    return False, f"HTTP {response.status}"
        except Exception as e:
            return False, str(e)

    async def stream_request(
        self,
        endpoint: str,
        data: aiohttp.FormData,
        user_id: int
    ) -> AsyncIterator[StreamMessage]:
        """SSE —Å—Ç—Ä–∏–º –æ—Ç Runner."""
        self._cancel_flags[user_id] = asyncio.Event()

        try:
            async with aiohttp.ClientSession() as session:
                async with session.post(
                    f"{self.base_url}{endpoint}",
                    data=data,
                    headers={"X-API-Key": self.api_key},
                    timeout=aiohttp.ClientTimeout(total=300),
                ) as response:
                    if response.status != 200:
                        yield StreamMessage(type="error", content=f"HTTP {response.status}")
                        return

                    async for line in response.content:
                        if self._cancel_flags[user_id].is_set():
                            yield StreamMessage(type="cancelled", content="")
                            return

                        line = line.decode("utf-8").strip()
                        if line.startswith("data: "):
                            import json
                            try:
                                msg = json.loads(line[6:])
                                yield StreamMessage(
                                    type=msg.get("type", "result"),
                                    content=msg.get("content", ""),
                                    metadata=msg.get("metadata")
                                )
                                if msg.get("type") == "done":
                                    return
                            except json.JSONDecodeError:
                                yield StreamMessage(type="result", content=line[6:])
        finally:
            self._cancel_flags.pop(user_id, None)

    async def cancel_stream(self, user_id: int) -> bool:
        if user_id in self._cancel_flags:
            self._cancel_flags[user_id].set()
            return True
        return False
```

### 3.2 models.py

```python
from dataclasses import dataclass
from enum import Enum


@dataclass
class StreamMessage:
    """–°–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ SSE —Å—Ç—Ä–∏–º–∞ Runner."""
    type: str  # "progress" | "result" | "error" | "done" | "cancelled"
    content: str
    metadata: dict | None = None


class FileValidationError(Enum):
    INVALID_FORMAT = "invalid_format"
    FILE_TOO_LARGE = "file_too_large"
    EMPTY_FILE = "empty_file"


@dataclass
class CVFile:
    """–í–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª CV."""
    content: bytes
    filename: str
    mime_type: str
    size: int

    MAX_SIZE = 1 * 1024 * 1024  # 1 MB
    ALLOWED_EXTENSIONS = {".pdf", ".txt"}

    @classmethod
    def validate(cls, content: bytes, filename: str, mime_type: str) -> "CVFile | FileValidationError":
        """–í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–∞ CV."""
        if len(content) > cls.MAX_SIZE:
            return FileValidationError.FILE_TOO_LARGE

        if len(content) == 0:
            return FileValidationError.EMPTY_FILE

        ext = "." + filename.rsplit(".", 1)[-1].lower() if "." in filename else ""
        if ext not in cls.ALLOWED_EXTENSIONS:
            return FileValidationError.INVALID_FORMAT

        return cls(
            content=content,
            filename=filename,
            mime_type=mime_type,
            size=len(content)
        )
```

---

## 4. CV Analyzer (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)

### 4.1 cv_analyzer.py

```python
from typing import AsyncIterator
import aiohttp

from .client import RunnerClient
from .models import StreamMessage, CVFile


class CVAnalyzer:
    """–°–µ—Ä–≤–∏—Å –∞–Ω–∞–ª–∏–∑–∞ CV —á–µ—Ä–µ–∑ Runner."""

    ENDPOINT = "/analyze-cv"

    def __init__(self, runner: RunnerClient):
        self.runner = runner

    async def analyze(
        self,
        cv_file: CVFile,
        user_id: int
    ) -> AsyncIterator[StreamMessage]:
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ CV."""
        form = aiohttp.FormData()
        form.add_field(
            "file",
            cv_file.content,
            filename=cv_file.filename,
            content_type=cv_file.mime_type
        )
        form.add_field("user_id", str(user_id))

        async for message in self.runner.stream_request(self.ENDPOINT, form, user_id):
            yield message

    async def cancel(self, user_id: int) -> bool:
        """–û—Ç–º–µ–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑."""
        return await self.runner.cancel_stream(user_id)
```

---

## 5. Bot Handler

### 5.1 FSM States (states/cv.py)

```python
from aiogram.fsm.state import State, StatesGroup

class CVStates(StatesGroup):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞–Ω–∞–ª–∏–∑–∞ CV."""
    waiting_for_file = State()      # –û–∂–∏–¥–∞–µ–º —Ñ–∞–π–ª –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    processing = State()            # –ê–Ω–∞–ª–∏–∑ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
```

### 5.2 Handler (handlers/cv.py)

```python
from aiogram import F, Router
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.types import Message, Document

from src.bot.states.cv import CVStates
from src.services.runner import get_cv_analyzer
from src.services.runner.models import CVFile, FileValidationError

router = Router(name="cv")

UPLOAD_PROMPT = """
üìÑ <b>–ê–Ω–∞–ª–∏–∑ CV</b>

–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à–µ —Ä–µ–∑—é–º–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ <b>PDF</b> –∏–ª–∏ <b>TXT</b>.

‚ö†Ô∏è –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: <b>1 –ú–ë</b>

–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –ø—Ä—è–º–æ –≤ —ç—Ç–æ—Ç —á–∞—Ç.
"""

ERROR_MESSAGES = {
    FileValidationError.INVALID_FORMAT: "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ PDF –∏ TXT.",
    FileValidationError.FILE_TOO_LARGE: "‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 1 –ú–ë.",
    FileValidationError.EMPTY_FILE: "‚ùå –§–∞–π–ª –ø—É—Å—Ç–æ–π.",
}


@router.message(Command("cv"))
async def cmd_cv(message: Message, state: FSMContext) -> None:
    """–ó–∞–ø—É—Å–∫ –∫–æ–º–∞–Ω–¥—ã –∞–Ω–∞–ª–∏–∑–∞ CV."""
    # –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∞–Ω–∞–ª–∏–∑, –µ—Å–ª–∏ –±—ã–ª
    analyzer = get_cv_analyzer()
    await analyzer.cancel(message.from_user.id)

    await state.set_state(CVStates.waiting_for_file)
    await message.answer(UPLOAD_PROMPT)


@router.message(CVStates.waiting_for_file, F.document)
async def handle_cv_file(message: Message, state: FSMContext) -> None:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ CV."""
    document: Document = message.document

    # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
    file = await message.bot.get_file(document.file_id)
    file_content = await message.bot.download_file(file.file_path)
    content = file_content.read()

    # –í–∞–ª–∏–¥–∞—Ü–∏—è
    result = CVFile.validate(content, document.file_name, document.mime_type)

    if isinstance(result, FileValidationError):
        await message.answer(ERROR_MESSAGES[result] + "\n\n" + UPLOAD_PROMPT)
        return

    cv_file: CVFile = result

    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    await state.set_state(CVStates.processing)
    await message.answer("üîÑ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à–µ —Ä–µ–∑—é–º–µ...")

    # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
    analyzer = get_cv_analyzer()

    async for msg in analyzer.analyze(cv_file, message.from_user.id):
        if msg.type == "cancelled":
            break
        elif msg.type == "error":
            await message.answer(f"‚ùå {msg.content}")
            break
        elif msg.type == "done":
            await message.answer("‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω!")
            break
        else:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            await message.answer(msg.content)

    await state.clear()


@router.message(CVStates.waiting_for_file)
async def handle_invalid_input(message: Message) -> None:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ –≤–≤–æ–¥–∞ (—Ç–µ–∫—Å—Ç –≤–º–µ—Å—Ç–æ —Ñ–∞–π–ª–∞)."""
    await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª, –∞ –Ω–µ —Ç–µ–∫—Å—Ç.\n\n" + UPLOAD_PROMPT)
```

---

## 6. –û—Ç–º–µ–Ω–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–æ–º–∞–Ω–¥—ã

### 6.1 Middleware –¥–ª—è –æ—Ç–º–µ–Ω—ã

–ü—Ä–∏ –≤—ã–∑–æ–≤–µ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –∫–æ–º–∞–Ω–¥—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ–Ω—è—Ç—å —Ç–µ–∫—É—â–∏–π –∞–Ω–∞–ª–∏–∑:

```python
# bot/middlewares/cancel_runner.py

from aiogram import BaseMiddleware
from aiogram.types import Message
from src.services.runner import get_runner_client

class CancelRunnerMiddleware(BaseMiddleware):
    """–û—Ç–º–µ–Ω—è–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–π —Å—Ç—Ä–∏–º Runner –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–æ–º–∞–Ω–¥—ã."""

    TRIGGER_COMMANDS = {"/start", "/help", "/profile", "/balance", "/tariffs", "/buy"}

    async def __call__(self, handler, event: Message, data: dict):
        if isinstance(event, Message) and event.text:
            if event.text.split()[0] in self.TRIGGER_COMMANDS:
                runner = get_runner_client()
                await runner.cancel_stream(event.from_user.id)

        return await handler(event, data)
```

---

## 7. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### 7.1 –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# Runner service
RUNNER_BASE_URL=http://155.212.245.141:8000
RUNNER_API_KEY=runner-health-secret-key-2024
```

### 7.2 config.py –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ

```python
class Settings(BaseSettings):
    # ... existing fields ...

    # Runner service
    runner_base_url: str = "http://155.212.245.141:8000"
    runner_api_key: str = "runner-health-secret-key-2024"
```

---

## 8. API Runner (–æ–∂–∏–¥–∞–µ–º—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç)

### 8.1 POST /analyze-cv

**Request:**
```
POST /analyze-cv
Content-Type: multipart/form-data
X-API-Key: runner-health-secret-key-2024

file: <binary>
user_id: 123456789
```

**Response (SSE stream):**
```
data: {"type": "progress", "content": "–ß–∏—Ç–∞—é —Ñ–∞–π–ª..."}

data: {"type": "result", "content": "## –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã\n\n–í–∞—à–µ —Ä–µ–∑—é–º–µ —Å–æ–¥–µ—Ä–∂–∏—Ç..."}

data: {"type": "result", "content": "## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n\n1. –î–æ–±–∞–≤—å—Ç–µ..."}

data: {"type": "done", "content": ""}
```

**–¢–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π:**
- `progress` ‚Äî –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å—Ç–∞—Ç—É—Å
- `result` ‚Äî —á–∞—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞
- `error` ‚Äî –æ—à–∏–±–∫–∞
- `done` ‚Äî –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω

---

## 9. User Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: /enhancecv                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ë–æ—Ç: "–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à–µ —Ä–µ–∑—é–º–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF –∏–ª–∏ TXT..."      ‚îÇ
‚îÇ [State: waiting_for_file]                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚ñº                 ‚ñº                 ‚ñº
    –¢–µ–∫—Å—Ç/–¥—Ä—É–≥–æ–µ         PDF/TXT > 1MB      PDF/TXT ‚â§ 1MB
    "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª"     "–§–∞–π–ª —Å–ª–∏—à–∫–æ–º      ‚îÇ
                         –±–æ–ª—å—à–æ–π"            ‚ñº
                                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                   ‚îÇ –ë–æ—Ç: "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é..."   ‚îÇ
                                   ‚îÇ [State: processing]     ‚îÇ
                                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                             ‚îÇ
                              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                              ‚ñº                             ‚ñº
                    Runner –æ—Ç–≤–µ—á–∞–µ—Ç              –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª
                    (SSE stream)                 –¥—Ä—É–≥—É—é –∫–æ–º–∞–Ω–¥—É
                              ‚îÇ                             ‚îÇ
                              ‚ñº                             ‚ñº
                    –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç              –ê–Ω–∞–ª–∏–∑ –æ—Ç–º–µ–Ω—ë–Ω
                    —Å–æ–æ–±—â–µ–Ω–∏—è                   State cleared
                    –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                              ‚îÇ
                              ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ "‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω!"   ‚îÇ
                    ‚îÇ [State: cleared]        ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 10. –ó–∞–º–µ–Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (–≤ –±—É–¥—É—â–µ–º)

–î–ª—è –∑–∞–º–µ–Ω—ã Runner –Ω–∞ –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–∏—Å:

1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å, –Ω–∞—Å–ª–µ–¥—É—é—â–∏–π `BaseRunnerClient`
2. –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–∞–±—Ä–∏–∫—É `get_runner_client()`:

```python
# services/runner/__init__.py

from src.core.config import settings
from .client import BaseRunnerClient, RunnerClient
from .cv_analyzer import CVAnalyzer

_runner: BaseRunnerClient | None = None
_cv_analyzer: CVAnalyzer | None = None


def get_runner_client() -> BaseRunnerClient:
    """–ü–æ–ª—É—á–∏—Ç—å –∫–ª–∏–µ–Ω—Ç Runner (singleton)."""
    global _runner
    if _runner is None:
        # –õ–µ–≥–∫–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –¥—Ä—É–≥—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é
        _runner = RunnerClient(
            base_url=settings.runner_base_url,
            api_key=settings.runner_api_key
        )
        # _runner = MockRunnerClient()  # –¥–ª—è —Ç–µ—Å—Ç–æ–≤
        # _runner = AlternativeRunnerClient()  # –¥—Ä—É–≥–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
    return _runner


def get_cv_analyzer() -> CVAnalyzer:
    """–ü–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä CV (singleton)."""
    global _cv_analyzer
    if _cv_analyzer is None:
        _cv_analyzer = CVAnalyzer(get_runner_client())
    return _cv_analyzer
```

---

## 11. Checklist —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- [ ] –°–æ–∑–¥–∞—Ç—å `services/runner/models.py`
- [ ] –°–æ–∑–¥–∞—Ç—å `services/runner/client.py`
- [ ] –°–æ–∑–¥–∞—Ç—å `services/runner/cv_analyzer.py`
- [ ] –°–æ–∑–¥–∞—Ç—å `services/runner/__init__.py` —Å —Ñ–∞–±—Ä–∏–∫–∞–º–∏
- [ ] –°–æ–∑–¥–∞—Ç—å `bot/states/cv.py`
- [ ] –°–æ–∑–¥–∞—Ç—å `bot/handlers/cv.py`
- [ ] –°–æ–∑–¥–∞—Ç—å `bot/middlewares/cancel_runner.py`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `core/config.py`
- [ ] –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ `healthcheck.py` ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `RunnerClient`
- [ ] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å handler –≤ `main.py`
- [ ] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å middleware
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É `/cv` –≤ –º–µ–Ω—é –±–æ—Ç–∞
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –î–µ–ø–ª–æ–π

---

## 12. –û—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã

1. **–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç Runner** ‚Äî –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å —Ç–æ—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç SSE —Å–æ–æ–±—â–µ–Ω–∏–π
2. **–¢–∞–π–º–∞—É—Ç—ã** ‚Äî –∫–∞–∫–æ–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞?
3. **–û—á–µ—Ä–µ–¥—å** ‚Äî –Ω—É–∂–Ω–∞ –ª–∏ –æ—á–µ—Ä–µ–¥—å –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–ª–∏ Runner –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ?
4. **–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** ‚Äî —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ª–∏ –∏—Å—Ç–æ—Ä–∏—é –∞–Ω–∞–ª–∏–∑–æ–≤ –≤ –ë–î?
5. **–õ–∏–º–∏—Ç—ã** ‚Äî –µ—Å—Ç—å –ª–∏ –ª–∏–º–∏—Ç –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–Ω–∞–ª–∏–∑–æ–≤ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?
