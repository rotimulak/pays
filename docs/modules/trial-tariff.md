# –ü—Ä–æ–º–æ-—Ç–∞—Ä–∏—Ñ –¥–ª—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞

## –û–±–∑–æ—Ä

–ü—Ä–æ–º–æ-—Ç–∞—Ä–∏—Ñ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –º—è–≥–∫–æ–≥–æ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –±–æ—Ç–æ–º. –í–º–µ—Å—Ç–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π –æ–ø–ª–∞—Ç—ã, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É.

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- 30 —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ
- 8 –¥–Ω–µ–π –ø–æ–¥–ø–∏—Å–∫–∏ (–¥–µ–Ω—å –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ + 7 –ø–æ–ª–Ω—ã—Ö –¥–Ω–µ–π)
- –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É
- –ë–µ—Å–ø–ª–∞—Ç–Ω–æ (—Å—Ç–æ–∏–º–æ—Å—Ç—å 0.01‚ÇΩ –¥–ª—è —Å–æ–±–ª—é–¥–µ–Ω–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ë–î)

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–û–¥–Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–∞ —Ç–∞—Ä–∏—Ñ:** –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–æ–º–æ-—Ç–∞—Ä–∏—Ñ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
2. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:** –ü—Ä–æ–º–æ–∫–æ–¥—ã –∏–º–µ—é—Ç –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π (max_uses)
3. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∫—É–ø–∏—Ç—å –æ–±—ã—á–Ω—ã–π —Ç–∞—Ä–∏—Ñ –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

#### –¢–∞–±–ª–∏—Ü–∞ `promo_activations`

–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–æ–º–æ-—Ç–∞—Ä–∏—Ñ–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏:

```sql
CREATE TABLE promo_activations (
    id UUID PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id),
    tariff_id UUID NOT NULL REFERENCES tariffs(id),
    promo_code_id UUID NOT NULL REFERENCES promo_codes(id),
    activated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    tokens_credited INTEGER NOT NULL,
    subscription_days_added INTEGER NOT NULL,
    UNIQUE (user_id, tariff_id)
);
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- `idx_promo_activations_user_tariff` (user_id, tariff_id) UNIQUE
- `idx_promo_activations_user_id` (user_id)
- `idx_promo_activations_promo_code_id` (promo_code_id)

#### –¢–∞—Ä–∏—Ñ trial-30-7

```sql
INSERT INTO tariffs (
    slug, name, price, tokens,
    period_unit, period_value,
    subscription_fee, min_payment,
    is_active
) VALUES (
    'trial-30-7',
    '–ü—Ä–æ–±–Ω—ã–π —Ç–∞—Ä–∏—Ñ',
    0.01, -- –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞
    30,
    'day',
    8, -- –¥–µ–Ω—å –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ + 7 –¥–Ω–µ–π
    0,
    0.01,
    false -- –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ —Ç–∞—Ä–∏—Ñ–æ–≤
);
```

**–ü–æ—á–µ–º—É is_active=false?**
–ü—Ä–æ–º–æ-—Ç–∞—Ä–∏—Ñ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –ø—Ä–æ–º–æ–∫–æ–¥—ã –∏ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è –≤ –æ–±—ã—á–Ω–æ–º —Å–ø–∏—Å–∫–µ —Ç–∞—Ä–∏—Ñ–æ–≤ –¥–ª—è –ø–æ–∫—É–ø–∫–∏.

### –ü—Ä–æ–º–æ–∫–æ–¥—ã

–ü—Ä–æ–º–æ–∫–æ–¥—ã –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —Ç–∞—Ä–∏—Ñ—É trial-30-7 —á–µ—Ä–µ–∑ –ø–æ–ª–µ `tariff_id`. –ü—Ä–∏–º–µ—Ä—ã:

- `TRIAL2025` - 100 –∞–∫—Ç–∏–≤–∞—Ü–∏–π
- `WELCOME100` - 50 –∞–∫—Ç–∏–≤–∞—Ü–∏–π
- `FRIENDLY` - 100 –∞–∫—Ç–∏–≤–∞—Ü–∏–π
- `TESTCODE` - 10 –∞–∫—Ç–∏–≤–∞—Ü–∏–π (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

```sql
INSERT INTO promo_codes (
    code, discount_type, discount_value,
    max_uses, tariff_id, is_active
) VALUES (
    'TRIAL2025',
    'bonus_tokens',
    1, -- –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏)
    100,
    '<tariff_id>',
    true
);
```

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. PromoActivation (–º–æ–¥–µ–ª—å)

**–§–∞–π–ª:** `backend/src/db/models/promo_activation.py`

–ú–æ–¥–µ–ª—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–π –ø—Ä–æ–º–æ-—Ç–∞—Ä–∏—Ñ–æ–≤.

### 2. PromoActivationRepository

**–§–∞–π–ª:** `backend/src/db/repositories/promo_activation_repository.py`

**–ú–µ—Ç–æ–¥—ã:**
- `create(activation)` - —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
- `has_activated_tariff(user_id, tariff_id)` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–∞—Ü–∏—é
- `get_user_activations(user_id)` - –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 3. TrialService

**–§–∞–π–ª:** `backend/src/services/trial_service.py`

–û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–æ–º–æ-—Ç–∞—Ä–∏—Ñ–æ–≤.

**–ú–µ—Ç–æ–¥:** `activate_trial(user_id, promo_code)`

**–õ–æ–≥–∏–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏:**

1. –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ (—Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ, –ø—Ä–∏–≤—è–∑–∫–∞ –∫ —Ç–∞—Ä–∏—Ñ—É)
2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ –ø–æ tariff_id –ø—Ä–æ–º–æ–∫–æ–¥–∞
3. –ü—Ä–æ–≤–µ—Ä–∫–∞: —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω? ‚Üí –æ—à–∏–±–∫–∞
4. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞ (max_uses, valid_from/until)
5. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π (FOR UPDATE)
6. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ (tariff.tokens)
7. –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏:
   - –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞: –¥–æ–±–∞–≤–∏—Ç—å 8 –¥–Ω–µ–π –∫ subscription_end
   - –ï—Å–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞: subscription_end = now + 8 days
8. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ promo_activations
9. –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç uses_count –ø—Ä–æ–º–æ–∫–æ–¥–∞
10. –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (—Ç–∏–ø TOPUP)
11. Commit

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```python
{
    "tokens_credited": 30,
    "subscription_end": datetime,
    "tariff_name": "–ü—Ä–æ–±–Ω—ã–π —Ç–∞—Ä–∏—Ñ",
    "new_balance": 150
}
```

### 4. FSM States

**–§–∞–π–ª:** `backend/src/bot/states/trial.py`

```python
class TrialStates(StatesGroup):
    waiting_for_code = State()
```

### 5. Handlers

**–§–∞–π–ª:** `backend/src/bot/handlers/trial.py`

**–†–æ—É—Ç–µ—Ä:** `trial.router`

#### Handlers:

1. `on_promo_trial_button` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "üéü –ü—Ä–æ–º–æ–∫–æ–¥"
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç FSM state `TrialStates.waiting_for_code`
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è –≤–≤–æ–¥–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞

2. `on_promo_code_input` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞
   - –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –≤–≤–æ–¥ (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç)
   - –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ uppercase
   - –í—ã–∑—ã–≤–∞–µ—Ç `TrialService.activate_trial()`
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∞)
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫ —ç–∫—Ä–∞–Ω—É –±–∞–ª–∞–Ω—Å–∞

### 6. Keyboards

**–§–∞–π–ª:** `backend/src/bot/keyboards/balance.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "üéü –ü—Ä–æ–º–æ–∫–æ–¥" –≤ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –±–∞–ª–∞–Ω—Å–∞:

```python
[üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å 200‚ÇΩ] [‚úèÔ∏è –î—Ä—É–≥–∞—è —Å—É–º–º–∞] [üéü –ü—Ä–æ–º–æ–∫–æ–¥]
[üìã –ò—Å—Ç–æ—Ä–∏—è] [üîÑ –û–±–Ω–æ–≤–∏—Ç—å]
[‚óÄÔ∏è –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é]
```

**Callback data:** `promo_trial`

## User Flow

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ä–∞–∑–¥–µ–ª –ë–∞–ª–∞–Ω—Å**
   - `/balance` –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ "üí∞ –ë–∞–ª–∞–Ω—Å"

2. **–ù–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "üéü –ü—Ä–æ–º–æ–∫–æ–¥"**
   - –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è –≤–≤–æ–¥–∞
   - FSM state: waiting_for_code

3. **–í–≤–æ–¥–∏—Ç –ø—Ä–æ–º–æ–∫–æ–¥** (–Ω–∞–ø—Ä–∏–º–µ—Ä, "TRIAL2025")
   - –ö–æ–¥ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ uppercase
   - –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏—è —á–µ—Ä–µ–∑ TrialService

4. **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
   - **–£—Å–ø–µ—Ö:** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏ –∏ –¥–∞—Ç–æ–π –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
   - **–û—à–∏–±–∫–∞:** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏—á–∏–Ω–∞ (–ø—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å—á–µ—Ä–ø–∞–Ω, —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∏ —Ç.–¥.)

5. **–í–æ–∑–≤—Ä–∞—Ç –∫ —ç–∫—Ä–∞–Ω—É –±–∞–ª–∞–Ω—Å–∞**
   - –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å –∏ –ø–æ–¥–ø–∏—Å–∫–∞

## –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

- "–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω" - –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î
- "–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Ç–∞—Ä–∏—Ñ—É" - tariff_id = NULL
- "–í—ã —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ —Ç–∞—Ä–∏—Ñ '–ü—Ä–æ–±–Ω—ã–π —Ç–∞—Ä–∏—Ñ' —Ä–∞–Ω–µ–µ" - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è
- "–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω" - not is_active
- "–ü—Ä–æ–º–æ–∫–æ–¥ –µ—â—ë –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω" - valid_from > now
- "–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏—Å—Ç—ë–∫" - valid_until < now
- "–õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏—Å—á–µ—Ä–ø–∞–Ω" - uses_count >= max_uses

## –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç `backend/create_trial_tariff.py`:

```bash
cd backend
python create_trial_tariff.py
```

**–°–∫—Ä–∏–ø—Ç:**
- –°–æ–∑–¥–∞–µ—Ç —Ç–∞—Ä–∏—Ñ trial-30-7 (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
- –°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥—ã —Å –∑–∞–¥–∞–Ω–Ω—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω (–º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ)

### –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ç–∏–≤–∞—Ü–∏–π

```sql
-- –í—Å–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
SELECT u.username, t.slug, pa.activated_at, pa.tokens_credited
FROM promo_activations pa
JOIN users u ON pa.user_id = u.id
JOIN tariffs t ON pa.tariff_id = t.id
ORDER BY pa.activated_at DESC;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º
SELECT pc.code, pc.uses_count, pc.max_uses,
       COUNT(pa.id) as actual_activations
FROM promo_codes pc
LEFT JOIN promo_activations pa ON pc.id = pa.promo_code_id
WHERE pc.tariff_id IN (
    SELECT id FROM tariffs WHERE slug = 'trial-30-7'
)
GROUP BY pc.id, pc.code, pc.uses_count, pc.max_uses;
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞

```python
# –í create_trial_tariff.py –¥–æ–±–∞–≤–∏—Ç—å –≤ promo_codes_data:
{"code": "NEWCODE", "max_uses": 50},
```

–ò–ª–∏ —á–µ—Ä–µ–∑ SQL:

```sql
INSERT INTO promo_codes (
    id, code, discount_type, discount_value,
    max_uses, uses_count,
    valid_from, valid_until,
    tariff_id, is_active
) VALUES (
    gen_random_uuid(),
    'NEWCODE',
    'bonus_tokens',
    1,
    50,
    0,
    NOW(),
    NULL,
    (SELECT id FROM tariffs WHERE slug = 'trial-30-7'),
    true
);
```

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å—ã

### 1. –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ 0.01‚ÇΩ

**–ü—Ä–∏—á–∏–Ω–∞:** Constraint `price > 0` –≤ —Ç–∞–±–ª–∏—Ü–µ tariffs

**–ö–æ–º–ø—Ä–æ–º–∏—Å—Å:** –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –≤–º–µ—Å—Ç–æ 0‚ÇΩ. –≠—Ç–æ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –ª–æ–≥–∏–∫—É, —Ç–∞–∫ –∫–∞–∫ –ø—Ä–æ–º–æ-—Ç–∞—Ä–∏—Ñ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ TrialService, –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è invoice.

### 2. discount_value = 1

**–ü—Ä–∏—á–∏–Ω–∞:** Constraint `discount_value > 0` –≤ —Ç–∞–±–ª–∏—Ü–µ promo_codes

**–ö–æ–º–ø—Ä–æ–º–∏—Å—Å:** –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ 1 –≤–º–µ—Å—Ç–æ 0. –≠—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ª–æ–≥–∏–∫–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ trial –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤.

### 3. –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è trial –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–º–æ–∫–æ–¥—ã –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç—Å—è –ø–æ –ø—Ä–∏–≤—è–∑–∫–µ –∫ tariff_id —Ç–∞—Ä–∏—Ñ–∞ trial-30-7

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** –ù–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ enum —Ç–∏–ø–∞ –∏–ª–∏ —Ñ–ª–∞–≥–∞. –ì–∏–±–∫–æ—Å—Ç—å - –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–Ω—ã—Ö trial —Ç–∞—Ä–∏—Ñ–æ–≤.

## Testing

### Manual Testing

1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–æ—Ç–µ
2. –ü–µ—Ä–µ–π—Ç–∏ –≤ —Ä–∞–∑–¥–µ–ª –ë–∞–ª–∞–Ω—Å
3. –ù–∞–∂–∞—Ç—å "üéü –ü—Ä–æ–º–æ–∫–æ–¥"
4. –í–≤–µ—Å—Ç–∏ "TESTCODE"
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - –ë–∞–ª–∞–Ω—Å —É–≤–µ–ª–∏—á–∏–ª—Å—è –Ω–∞ 30 —Ç–æ–∫–µ–Ω–æ–≤
   - –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –Ω–∞ 8 –¥–Ω–µ–π
   - –í –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –µ—Å—Ç—å –∑–∞–ø–∏—Å—å
6. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞ - –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞
7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –¥–æ–ª–∂–µ–Ω —Å—É–º–µ—Ç—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å

### Edge Cases

- ‚ùå –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è —Ç–æ–≥–æ –∂–µ —Ç–∞—Ä–∏—Ñ–∞
- ‚úÖ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ (–¥–æ–±–∞–≤–ª—è–µ—Ç –¥–Ω–∏)
- ‚ùå –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–º–æ–∫–æ–¥
- ‚ùå –ò—Å—á–µ—Ä–ø–∞–Ω–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ (uses_count >= max_uses)
- ‚úÖ –†–∞–∑–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω –ø—Ä–æ–º–æ–∫–æ–¥

## Future Improvements

1. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö trial —Ç–∞—Ä–∏—Ñ–æ–≤**
   - trial-10-3: 10 —Ç–æ–∫–µ–Ω–æ–≤, 3 –¥–Ω—è
   - trial-50-14: 50 —Ç–æ–∫–µ–Ω–æ–≤, 14 –¥–Ω–µ–π

2. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏**
   - –¢–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ–Ω–µ–µ N –¥–Ω–µ–π –Ω–∞–∑–∞–¥

3. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞**
   - Conversion rate (trial ‚Üí paid)
   - –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã
   - Retention –ø–æ—Å–ª–µ trial

4. **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è**
   - –†–∞–∑–Ω—ã–µ trial —Ç–∞—Ä–∏—Ñ—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
   - A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

## –°–º. —Ç–∞–∫–∂–µ

- [–ü—Ä–æ–º–æ–∫–æ–¥—ã](promo.md) - —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –¥–ª—è —Å–∫–∏–¥–æ–∫
- [–¢–∞—Ä–∏—Ñ—ã](tariffs.md) - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–Ω—ã–º–∏ –ø–ª–∞–Ω–∞–º–∏
- [–ë–∏–ª–ª–∏–Ω–≥](billing.md) - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
