# Архитектура

## Схема базы данных

```
┌─────────────────────────────────────────────────────────────────┐
│                           users                                 │
├─────────────────────────────────────────────────────────────────┤
│ id (PK)           │ BIGINT        │ Telegram user_id            │
│ username          │ VARCHAR       │ @username                   │
│ first_name        │ VARCHAR       │ Имя                         │
│ token_balance     │ INT           │ Остаток токенов             │
│ is_active         │ BOOLEAN       │ Подписка активна            │
│ subscription_end  │ TIMESTAMP     │ Дата окончания подписки     │
│ created_at        │ TIMESTAMP     │                             │
│ updated_at        │ TIMESTAMP     │                             │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                          invoices                               │
├─────────────────────────────────────────────────────────────────┤
│ id (PK)           │ UUID          │                             │
│ user_id (FK)      │ BIGINT        │ → users.id                  │
│ amount            │ DECIMAL       │ Сумма в рублях              │
│ tokens            │ INT           │ Кол-во токенов (если есть)  │
│ subscription_days │ INT           │ Дни подписки (если есть)    │
│ status            │ ENUM          │ pending / paid / cancelled / expired │
│ robokassa_id      │ VARCHAR       │ ID операции Робокассы       │
│ created_at        │ TIMESTAMP     │                             │
│ paid_at           │ TIMESTAMP     │                             │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                        transactions                             │
├─────────────────────────────────────────────────────────────────┤
│ id (PK)           │ UUID          │                             │
│ user_id (FK)      │ BIGINT        │ → users.id                  │
│ type              │ ENUM          │ topup / spend / subscription / refund │
│ tokens_delta      │ INT           │ +/- токенов                 │
│ description       │ VARCHAR       │ Причина списания/начисления │
│ invoice_id (FK)   │ UUID          │ → invoices.id (nullable)    │
│ created_at        │ TIMESTAMP     │                             │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                          tariffs                                │
├─────────────────────────────────────────────────────────────────┤
│ id (PK)           │ VARCHAR       │ basic_monthly / pro_yearly  │
│ name              │ VARCHAR       │ Название для пользователя   │
│ price             │ DECIMAL       │ Цена                        │
│ tokens            │ INT           │ Кол-во токенов              │
│ subscription_days │ INT           │ Дни подписки                │
│ is_active         │ BOOLEAN       │                             │
└─────────────────────────────────────────────────────────────────┘
```

---

## Жизненный цикл Invoice

```
                    ┌─────────────────────────────────────┐
                    │                                     │
                    ▼                                     │
┌─────────┐    ┌─────────┐    ┌─────────┐           ┌─────────┐
│ создан  │───>│ pending │───>│  paid   │           │ expired │
└─────────┘    └────┬────┘    └─────────┘           └─────────┘
                    │                                     ▲
                    │         ┌───────────┐               │
                    └────────>│ cancelled │               │
                              └───────────┘               │
                    │                                     │
                    └─────────── (TTL истёк) ─────────────┘
```

| Статус | Описание |
|--------|----------|
| `pending` | Счёт создан, ожидает оплаты |
| `paid` | Оплата подтверждена через webhook Робокассы |
| `cancelled` | Отменён пользователем или системой |
| `expired` | Истёк срок ожидания оплаты (TTL) |

---

## Жизненный цикл подписки

```
┌──────────────────────────────────────────────────────────────────┐
│                      АКТИВНАЯ ПОДПИСКА                           │
│                  (subscription_end > now)                        │
│                                                                  │
│  • Сервис полностью работоспособен                               │
│  • Токены списываются при рабочих запросах                       │
└──────────────────────────────────────────────────────────────────┘
                              │
                              │ subscription_end достигнут
                              ▼
              ┌───────────────────────────────────┐
              │   Проверка баланса токенов        │
              │   (token_balance >= SUBSCRIPTION_PRICE)
              └───────────────────────────────────┘
                     │                    │
          Достаточно │                    │ Недостаточно
                     ▼                    ▼
┌─────────────────────────────┐  ┌─────────────────────────────────┐
│   АВТОПРОДЛЕНИЕ             │  │      ПОДПИСКА ИСТЕКЛА           │
│                             │  │                                 │
│ • Списание токенов          │  │ • Сервис недоступен             │
│ • subscription_end += 30d   │  │ • Бот отвечает: "Подписка       │
│ • Транзакция type=spend     │  │   истекла, пополните баланс"    │
│ • Уведомление пользователю  │  │ • Баланс токенов сохраняется    │
└─────────────────────────────┘  └─────────────────────────────────┘
              │                                    │
              └────────> АКТИВНАЯ ПОДПИСКА <───────┘
                         (после пополнения)
```

---

## Логика списания токенов

```
┌─────────────────────────────────────────────────────────────────┐
│                     РАБОЧИЙ ЗАПРОС                              │
│              (использование основного сервиса)                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────────┐
              │   Проверка: подписка активна?     │
              └───────────────────────────────────┘
                     │                    │
                  Да │                    │ Нет
                     ▼                    ▼
              ┌─────────────┐      ┌─────────────────────┐
              │ Проверка:   │      │ Отказ в обслуживании│
              │ tokens > 0? │      │ "Продлите подписку" │
              └─────────────┘      └─────────────────────┘
                     │
          Да │             │ Нет
             ▼             ▼
   ┌──────────────┐  ┌──────────────────────┐
   │ Выполнить    │  │ Отказ: "Недостаточно │
   │ запрос       │  │ токенов, пополните   │
   │ tokens -= N  │  │ баланс"              │
   └──────────────┘  └──────────────────────┘
```

---

## Типы транзакций

| Тип | Описание | tokens_delta |
|-----|----------|--------------|
| `topup` | Пополнение баланса (оплата через Робокассу) | +N |
| `spend` | Списание за рабочий запрос | -N |
| `subscription` | Автосписание абонплаты с баланса | -SUBSCRIPTION_PRICE |
| `refund` | Возврат средств | +N |

---

## Архитектура webhook'ов

```
Робокасса                    Ваш сервер                    Telegram
    │                            │                            │
    │  POST /webhook/robokassa   │                            │
    │  (ResultURL)               │                            │
    │ ──────────────────────────>│                            │
    │                            │  1. Проверка подписи       │
    │                            │  2. Обновление invoice     │
    │                            │  3. Начисление токенов/    │
    │                            │     продление подписки     │
    │                            │  4. Запись в transactions  │
    │                            │                            │
    │                            │  sendMessage (уведомление) │
    │                            │ ──────────────────────────>│
    │                            │                            │
    │<── OK ─────────────────────│                            │
```

---

## См. также

- [Обзор](overview.md) — общее описание проекта
- [Интеграция с Робокассой](robokassa-adapter.md) — детали платёжной интеграции
- [Безопасность](security.md) — защита от повторной обработки платежей
