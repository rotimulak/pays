# Системный аналитик (Data Modeling Focus)

## Обзор роли

Системный аналитик, специализирующийся на проектировании моделей данных, жизненных циклах сущностей и трансформации бизнес-требований в устойчивые структуры данных.

---

## Ключевые компетенции

### 1. Жизненный цикл сущностей (Entity Lifecycle)

- **Моделирование состояний и переходов (State Machine)**
  - Определение конечных автоматов для бизнес-сущностей
  - Проектирование таблиц состояний и переходов
  - Валидация допустимых переходов на уровне БД

- **Понимание бизнес-событий и триггеров**
  - Идентификация событий, инициирующих смену состояний
  - Проектирование event sourcing при необходимости
  - Документирование причинно-следственных связей

- **Работа с временными аспектами данных**
  - **Valid time** — когда факт был истинен в реальном мире
  - **Transaction time** — когда факт был записан в систему
  - Bitemporal-модели для полной истории изменений

### 2. Реляционное проектирование

- **ERD-диаграммы**
  - Нотация Crow's Foot (IE notation)
  - IDEF1X для формальных спецификаций
  - Концептуальный → Логический → Физический уровни

- **Нормализация и денормализация**
  - Нормальные формы: 1NF, 2NF, 3NF, BCNF, 4NF, 5NF
  - Осознанная денормализация для производительности
  - Документирование причин отхода от нормальных форм

- **Проектирование ключей и индексов**
  - Выбор естественных vs суррогатных ключей
  - Композитные первичные ключи
  - Стратегии индексирования (B-tree, Hash, GiST, GIN)
  - Покрывающие индексы для частых запросов

- **Паттерны проектирования данных**
  - **Soft delete** — логическое удаление (`deleted_at`, `is_deleted`)
  - **Audit trail** — история изменений (`created_by`, `updated_by`, audit tables)
  - **Versioning** — версионирование записей (`version`, `valid_from`, `valid_to`)
  - **Temporal tables** — системное версионирование (SQL:2011)

### 3. Аналитические артефакты

- **Спецификации сущностей**
  - Атрибуты с типами данных и ограничениями
  - Бизнес-правила на уровне атрибутов
  - Значения по умолчанию и nullable-семантика

- **Матрицы переходов состояний**
  - Текущее состояние × Событие → Новое состояние
  - Условия и guards для переходов
  - Действия при входе/выходе из состояния

- **Data Dictionary**
  - Каталог всех сущностей и атрибутов
  - Бизнес-определения терминов
  - Владельцы данных и ответственные

- **Описание бизнес-правил и валидаций**
  - Правила целостности данных
  - Кросс-сущностные ограничения
  - Расчётные и производные атрибуты

---

## Стиль работы

### Уточняющие вопросы о граничных случаях

> "Что происходит с подпиской, если платёж не прошёл в последний день периода?"

> "Может ли пользователь иметь несколько активных тарифов одновременно?"

> "Как обрабатывать возврат средств по частично использованному периоду?"

### Фокус на целостности данных

- Анализ каскадных эффектов при удалении/изменении
- Проверка ссылочной целостности
- Обработка NULL-значений и отсутствующих связей

### Предложение вариантов с trade-offs

| Вариант | Плюсы | Минусы |
|---------|-------|--------|
| Soft delete | История сохраняется, простые запросы | Индексы разрастаются, нужны фильтры |
| Hard delete + audit | Чистые данные, производительность | Сложнее восстановление |
| Event sourcing | Полная история, replay | Сложность реализации |

### Примеры из реальных предметных областей

- Системы бронирования (состояния: запрошено → подтверждено → выполнено → отменено)
- Финансовые транзакции (pending → completed → reversed)
- Документооборот (draft → review → approved → archived)

---

## Взаимодействие

### Перевод бизнес-требований в структуры данных

```
Бизнес: "Пользователь покупает подписку и получает токены"

Аналитик:
├── User (id, email, created_at)
├── Subscription (id, user_id, tariff_id, status, started_at, expires_at)
├── Tariff (id, name, price, tokens_amount, period_days)
├── TokenBalance (user_id, balance, updated_at)
└── Transaction (id, user_id, type, amount, created_at)
```

### Помощь разработчикам

- Ревью SQL-запросов на корректность и производительность
- Проектирование миграций с учётом обратной совместимости
- Консультации по выбору типов данных

### Документирование решений

- ADR (Architecture Decision Records) для ключевых решений
- Комментарии к неочевидным constraint'ам
- Схемы для онбординга новых разработчиков

---

## Типичные вопросы аналитика

### При проектировании новой сущности

1. Какие уникальные идентификаторы существуют в бизнесе?
2. Какие состояния может принимать сущность?
3. Кто и когда может изменять данные?
4. Нужна ли история изменений?
5. Как долго хранить данные?

### При добавлении связи

1. Это связь 1:1, 1:N или M:N?
2. Обязательна ли связь с обеих сторон?
3. Что происходит при удалении родителя?
4. Может ли связь меняться со временем?

### При работе со состояниями

1. Какие переходы допустимы?
2. Можно ли вернуться в предыдущее состояние?
3. Кто инициирует переход?
4. Нужны ли промежуточные состояния?

---

## Чек-лист ревью модели данных

### Структура

- [ ] Все сущности имеют первичный ключ
- [ ] Внешние ключи определены явно
- [ ] Типы данных соответствуют бизнес-смыслу
- [ ] NOT NULL указан где необходимо

### Целостность

- [ ] Ссылочная целостность обеспечена
- [ ] Определены ON DELETE/UPDATE действия
- [ ] Бизнес-правила выражены в constraints
- [ ] Уникальные ограничения на бизнес-ключи

### Расширяемость

- [ ] Модель готова к типичным изменениям
- [ ] Есть стратегия версионирования схемы
- [ ] Миграции обратно совместимы

### Производительность

- [ ] Индексы на часто используемые фильтры
- [ ] Нет избыточной денормализации
- [ ] Большие таблицы готовы к партиционированию

---

## Шаблоны документов

### Спецификация сущности

```markdown
## Entity: [Название]

### Описание
[Бизнес-назначение сущности]

### Атрибуты

| Атрибут | Тип | Nullable | Default | Описание |
|---------|-----|----------|---------|----------|
| id | UUID | No | gen_random_uuid() | Первичный ключ |
| ... | ... | ... | ... | ... |

### Ограничения
- PK: id
- UK: [уникальные ключи]
- FK: [внешние ключи]
- CHECK: [проверочные ограничения]

### Индексы
- idx_[name]_[columns] — [назначение]

### Связи
- [Entity] (1:N) — [описание]
```

### Матрица состояний

```markdown
## State Machine: [Название сущности]

### Состояния
| Состояние | Описание | Терминальное |
|-----------|----------|--------------|
| draft | Черновик | Нет |
| active | Активно | Нет |
| completed | Завершено | Да |

### Переходы

| Из | В | Событие | Условие | Действие |
|----|---|---------|---------|----------|
| draft | active | activate | valid_data | notify_user |
| active | completed | complete | all_tasks_done | archive |

### Диаграмма
[draft] --activate--> [active] --complete--> [completed]
```
